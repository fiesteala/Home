<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Panel Inteligente Fiesteala</title>
    
    <!-- TAILWIND CSS & DARK MODE -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class', 
            theme: { extend: { fontFamily: { sans: ['Inter', 'sans-serif'], mono: ['Courier Prime', 'monospace'] } } }
        }
    </script>

    <!-- FUENTES E ICONOS -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <!-- LIBRERÍAS FUNCIONALES -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <script>
        function applyAdminTheme() {
            const hour = new Date().getHours();
            const isNight = hour >= 19 || hour < 6;
            const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const systemLight = window.matchMedia('(prefers-color-scheme: light)').matches;
            let enableDark = systemDark ? true : (systemLight ? false : isNight);
            const adminComponents = [
                'adminPanel', 'loginModal', 'addGuestModal', 'qrPreviewModal', 'guestDetailModal', 
                'receptionView', 'checkinModal', 'configModal', 'initialSetupModal', 
                'tableWarningModal', 'editTableModal', 'sysModal', 'aaResultModal',
                'editGuestTableModal', 'editGuestPaxModal'
            ];
            adminComponents.forEach(id => { const el = document.getElementById(id); if (el) { if (enableDark) el.classList.add('dark'); else el.classList.remove('dark'); } });
        }
        window.addEventListener('DOMContentLoaded', applyAdminTheme);
    </script>

    <!-- FIREBASE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, setDoc, onSnapshot, deleteDoc, doc, query, orderBy, updateDoc, getDoc, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyDL9UEEvWKYE7QpctYrnu1rG644x05_4Wk", authDomain: "bodasofiayalejadro.firebaseapp.com", projectId: "bodasofiayalejadro", storageBucket: "bodasofiayalejadro.firebasestorage.app", messagingSenderId: "905632324437", appId: "1:905632324437:web:b7aead724b299cc3202ddc" };
        const appId = 'evento_demo_01'; 
        let app, auth, db;
        try { app = initializeApp(firebaseConfig); auth = getAuth(app); db = getFirestore(app); } catch (e) { console.error("Error Firebase:", e); }
        window.db = db; window.collection = collection; window.addDoc = addDoc; window.setDoc = setDoc; 
        window.updateDoc = updateDoc; window.getDoc = getDoc; window.onSnapshot = onSnapshot; window.deleteDoc = deleteDoc; window.doc = doc; window.appId = appId; window.auth = auth; window.query = query; window.orderBy = orderBy; window.limit = limit; window.signInAnonymously = signInAnonymously; window.isAuthReady = false;
        if(auth) { signInAnonymously(auth).catch(e => console.log(e)); onAuthStateChanged(auth, (user) => { if (user) window.isAuthReady = true; }); }
    </script>

    <style>
        .logo-container { width: 100%; max-width: 150px; display: block; }
        @keyframes click-press { 0%, 100% { transform: scale(1) rotate(0deg); } 50% { transform: scale(0.92) rotate(-2deg); } }
        @keyframes confetti-pop { 0% { transform: scale(1); } 50% { transform: scale(1.35); } 100% { transform: scale(1); } }
        @keyframes dot-beat { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.4); fill: #2563eb; } }
        .cursor-icon, .spark-group, .dot-icon { transform-origin: center; transform-box: fill-box; transition: transform 0.5s ease; }
        .animating .cursor-icon { animation: click-press 0.6s ease-in-out forwards; }
        .animating .spark-group { animation: confetti-pop 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .animating .dot-icon { animation: dot-beat 0.6s ease-in-out forwards; }

        .admin-theme { font-family: 'Inter', sans-serif; }
        #adminPanel, #receptionView { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .admin-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .admin-scroll::-webkit-scrollbar-track { background: transparent; }
        .admin-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 10px; }
        @media (prefers-color-scheme: dark) { .admin-scroll::-webkit-scrollbar-thumb { background-color: #475569; } }
        
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Mapa Carta Vertical */
        .map-canvas { touch-action: none; overflow: hidden; position: relative;}
        .map-bg-grid { background-image: radial-gradient(#cbd5e1 1.5px, transparent 1.5px); background-size: 30px 30px; }
        .dark .map-bg-grid { background-image: radial-gradient(#334155 1.5px, transparent 1.5px); }
        #venueCanvas { transform-origin: top left; transition: transform 0.3s ease-out; }
        
        .chair-node { position: absolute; width: 22px; height: 22px; border-radius: 50%; border: 2px solid rgba(0,0,0,0.25); transition: all 0.3s ease; box-shadow: 0 3px 6px rgba(0,0,0,0.15); }
        .chair-empty { background-color: #e2e8f0; border-color: #94a3b8; }
        .dark .chair-empty { background-color: #475569; border-color: #1e293b; }
        .chair-name { position: absolute; top: -26px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.9); color: white; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: bold; white-space: nowrap; pointer-events: none; z-index: 50; opacity: 0; transition: opacity 0.2s; box-shadow: 0 2px 6px rgba(0,0,0,0.2); }
        .chair-node:hover .chair-name { opacity: 1; }
        .draggable-table { cursor: grab; }
        .draggable-table:active { cursor: grabbing; }
        .table-inner { transition: transform 0.3s ease; } 

        @media print {
            body > *:not(#printableArea) { display: none !important; }
            #printableArea { display: block !important; width: 100%; background: white !important; }
            @page { size: letter; margin: 0.5cm; }
            .wristband-page { display: flex; flex-direction: column; gap: 0px; }
            .wristband { position: relative; border: 1px dashed #ccc; height: 3cm; width: 100%; display: flex; align-items: center; justify-content: space-between; padding: 0 0.5cm; font-family: 'Inter', sans-serif; background: white !important; overflow: hidden; -webkit-print-color-adjust: exact; print-color-adjust: exact; page-break-inside: avoid; }
            .wristband-edge-logo { width: 100px; opacity: 0.25; display: flex; align-items: center; justify-content: center; filter: grayscale(100%); }
            .wristband-center { display: flex; flex-direction: column; align-items: center; justify-content: center; color: black !important; flex: 1; }
        }
        
        .dropdown-content { display: none; position: absolute; right: 0; background-color: white; min-width: 160px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 50; border-radius: 0.5rem; overflow: hidden; }
        .dark .dropdown-content { background-color: #1e293b; border: 1px solid #334155; }
        .dropdown-content button { color: black; padding: 12px 16px; text-decoration: none; display: block; width: 100%; text-align: left; font-size: 0.8rem; }
        .dark .dropdown-content button { color: #e2e8f0; }
        .dropdown-content button:hover { background-color: #f1f5f9; }
        .dark .dropdown-content button:hover { background-color: #334155; }
        .show { display: block; }
        
        /* Modificadores Movil Lista Invitados */
        .status-card-confirmed { border-left: 4px solid #facc15; background: #fefce8; box-shadow: 0 4px 6px -1px rgba(250, 204, 21, 0.1); }
        .status-card-checkedin { border-left: 4px solid #4ade80; background: #f0fdf4; box-shadow: 0 4px 6px -1px rgba(74, 222, 128, 0.1); }
        .dark .status-card-confirmed { background: rgba(113, 63, 18, 0.2); border-left-color: #eab308; }
        .dark .status-card-checkedin { background: rgba(20, 83, 45, 0.2); border-left-color: #22c55e; }
    </style>
</head>
<body class="bg-gray-100 text-slate-800">

    <!-- TOAST NOTIFICATION -->
    <div id="toastMsg" class="fixed top-5 left-1/2 -translate-x-1/2 z-[200] transform transition-all duration-300 -translate-y-32 opacity-0 bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl font-bold text-sm flex items-center gap-2 pointer-events-none">
        <span id="toastIcon"></span> <span id="toastText">Mensaje</span>
    </div>

    <!-- ÁREA DE LA INVITACIÓN -->
    <main id="guestView" class="min-h-screen relative">
        <div class="flex flex-col items-center justify-center h-screen text-center p-6 bg-white">
            <div class="mb-6 opacity-50 grayscale hover:grayscale-0 transition duration-500 logo-container">
                 <svg viewBox="0 0 400 150" xmlns="http://www.w3.org/2000/svg"><g transform="translate(50, 20)"><path d="M10,10 L30,70 L45,45 L70,30 Z" fill="#2563eb" stroke="white" stroke-width="3" /><g transform="translate(10, 10)"><path d="M-3,-6 L-6,-12" stroke="#f59e0b" stroke-width="3" stroke-linecap="round" /><path d="M-6,-3 L-12,-6" stroke="#f59e0b" stroke-width="3" stroke-linecap="round" /><path d="M3,-6 L6,-12" stroke="#f59e0b" stroke-width="3" stroke-linecap="round" /><circle cx="-9" cy="-9" r="2" fill="#f59e0b" /></g></g><g transform="translate(130, 85)"><text font-family="sans-serif" font-weight="800" font-size="44" fill="#1e293b" letter-spacing="-1">fiesteala</text><circle cx="182" cy="-5" r="4.5" fill="#2563eb" /><text x="188" y="0" font-family="sans-serif" font-weight="400" font-size="24" fill="#2563eb">com</text></g></svg>
            </div>
            <h1 class="text-2xl font-bold text-slate-800 mb-2">Panel Inteligente Listo</h1>
            <p class="text-slate-500 max-w-md text-sm">Pega el código HTML de tu invitación dentro de la etiqueta <code class="bg-slate-100 px-2 py-1 rounded text-red-500 text-xs">&lt;main id="guestView"&gt;</code>.</p>
            <button onclick="window.openAdminLogin()" class="mt-8 px-6 py-3 bg-slate-800 text-white rounded-full text-xs font-bold uppercase tracking-widest hover:scale-105 active:scale-95 transition shadow-lg">Probar Panel</button>
        </div>
        <div class="absolute bottom-4 left-0 w-full text-center pointer-events-none z-50">
             <button onclick="window.openAdminLogin()" class="text-slate-300 hover:text-slate-500 text-[10px] font-bold uppercase tracking-widest transition pointer-events-auto p-2">Panel de Control</button>
        </div>
    </main>

    <!-- ÁREA IMPRESIÓN -->
    <div id="printableArea" class="hidden"></div>

    <!-- MODAL GENERAL (ALERTAS / CONFIRMACIONES) -->
    <div id="sysModal" class="fixed inset-0 z-[150] hidden bg-black/70 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-slate-800 p-8 rounded-[2rem] w-full max-w-sm border border-slate-200 dark:border-slate-700 shadow-2xl animate__animated animate__zoomIn">
            <div id="sysModalIcon" class="text-center mb-4 text-5xl drop-shadow-md"></div>
            <h3 id="sysModalTitle" class="text-xl font-black text-slate-800 dark:text-white text-center mb-2 leading-tight"></h3>
            <p id="sysModalText" class="text-sm text-slate-500 dark:text-slate-400 text-center mb-8"></p>
            <div id="sysModalActions" class="flex flex-col sm:flex-row gap-3 justify-center"></div>
        </div>
    </div>

    <!-- LOGIN MODAL -->
    <div id="loginModal" class="fixed inset-0 z-[60] hidden bg-slate-900/95 flex items-center justify-center px-4 backdrop-blur-md">
        <div class="bg-white dark:bg-slate-800 p-8 rounded-3xl shadow-2xl max-w-sm w-full relative admin-theme overflow-hidden border border-slate-200 dark:border-slate-700 animate__animated animate__zoomIn">
             <div class="mb-6 flex justify-center scale-90">
                 <div class="logo-container svg-animate-target"><svg viewBox="0 0 400 150" xmlns="http://www.w3.org/2000/svg"><g transform="translate(50, 20)"><path class="cursor-icon" d="M10,10 L30,70 L45,45 L70,30 Z" fill="#2563eb" stroke="white" stroke-width="3" /><g class="spark-group" transform="translate(10, 10)"><path d="M-3,-6 L-6,-12" stroke="#f59e0b" stroke-width="3" stroke-linecap="round" /><path d="M-6,-3 L-12,-6" stroke="#f59e0b" stroke-width="3" stroke-linecap="round" /><path d="M3,-6 L6,-12" stroke="#f59e0b" stroke-width="3" stroke-linecap="round" /><circle cx="-9" cy="-9" r="2" fill="#f59e0b" /></g></g><g transform="translate(130, 85)"><text font-family="sans-serif" font-weight="800" font-size="44" class="fill-slate-800 dark:fill-white" letter-spacing="-1">fiesteala</text><circle class="dot-icon" cx="182" cy="-5" r="4.5" fill="#2563eb" /><text x="188" y="0" font-family="sans-serif" font-weight="400" font-size="24" fill="#2563eb">com</text></g></svg></div>
             </div>
            <p class="text-sm text-slate-500 dark:text-slate-400 mb-6 text-center font-medium">Panel de Control Inteligente</p>
            <input type="password" id="adminPassword" placeholder="PIN (1234)" class="w-full border border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 p-4 rounded-xl mb-4 text-center text-lg tracking-widest outline-none focus:border-blue-500 dark:focus:border-blue-400 transition text-slate-800 dark:text-white">
            <button onclick="checkLogin()" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold hover:bg-blue-700 active:scale-95 transition shadow-lg shadow-blue-500/30">Acceder</button>
            <button onclick="document.getElementById('loginModal').classList.add('hidden')" class="w-full mt-4 text-slate-400 dark:text-slate-500 text-xs hover:text-slate-600 dark:hover:text-slate-300 font-semibold p-2">Cancelar</button>
        </div>
    </div>

    <!-- PANEL UI -->
    <div id="adminPanel" class="fixed inset-0 z-50 bg-[#f8fafc] dark:bg-slate-950 overflow-y-auto transform translate-y-full admin-theme h-screen flex flex-col transition-colors duration-300">
        <!-- HEADER -->
        <div class="bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 px-4 py-3 shrink-0 sticky top-0 z-20 shadow-sm">
            <div class="relative flex items-center justify-center sm:justify-between h-14 sm:h-auto">
                <div class="flex flex-col sm:flex-row items-center gap-1 sm:gap-4">
                    <div class="w-36 h-10 relative flex items-center justify-center">
                         <div class="logo-container svg-animate-target w-full h-full">
                            <svg viewBox="0 0 400 150" xmlns="http://www.w3.org/2000/svg"><g transform="translate(50, 20)"><path class="cursor-icon" d="M10,10 L30,70 L45,45 L70,30 Z" fill="#2563eb" stroke="white" stroke-width="3" /><g class="spark-group" transform="translate(10, 10)"><path d="M-3,-6 L-6,-12" stroke="#f59e0b" stroke-width="3" stroke-linecap="round" /><path d="M-6,-3 L-12,-6" stroke="#f59e0b" stroke-width="3" stroke-linecap="round" /><path d="M3,-6 L6,-12" stroke="#f59e0b" stroke-width="3" stroke-linecap="round" /><circle cx="-9" cy="-9" r="2" fill="#f59e0b" /></g></g><g transform="translate(130, 85)"><text font-family="sans-serif" font-weight="800" font-size="44" class="fill-slate-800 dark:fill-white" letter-spacing="-1">fiesteala</text><circle class="dot-icon" cx="182" cy="-5" r="4.5" fill="#2563eb" /><text x="188" y="0" font-family="sans-serif" font-weight="400" font-size="24" fill="#2563eb">com</text></g></svg>
                         </div>
                    </div>
                    <span class="text-[10px] sm:text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest text-center sm:text-left leading-none">Panel de Control<br class="sm:hidden"> Inteligente</span>
                </div>
                <button onclick="closeAdmin()" class="absolute right-0 top-1/2 -translate-y-1/2 sm:static sm:translate-y-0 w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-500 dark:text-slate-400 hover:text-slate-800 dark:hover:text-white flex items-center justify-center transition shadow-sm active:scale-95"><i class="fas fa-times"></i></button>
            </div>
        </div>
        
        <!-- DASHBOARD STATS -->
        <div class="bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 px-4 py-3 grid grid-cols-3 gap-2 sm:gap-3 shrink-0">
            <div class="bg-blue-50 dark:bg-blue-900/20 p-2 sm:p-3 rounded-xl border border-blue-100 dark:border-blue-800/50 flex flex-col justify-center items-center">
                <p class="text-[9px] sm:text-[10px] text-blue-600 dark:text-blue-400 font-bold uppercase tracking-wider mb-0.5 text-center">Total</p>
                <p class="text-xl sm:text-2xl font-black text-blue-700 dark:text-blue-300" id="dashTotalGuests">0</p>
            </div>
            <div class="bg-yellow-50 dark:bg-yellow-900/20 p-2 sm:p-3 rounded-xl border border-yellow-100 dark:border-yellow-800/50 flex flex-col justify-center items-center">
                 <p class="text-[9px] sm:text-[10px] text-yellow-600 dark:text-yellow-400 font-bold uppercase tracking-wider mb-0.5 text-center">Confirmados</p>
                <p class="text-xl sm:text-2xl font-black text-yellow-600 dark:text-yellow-400" id="dashConfirmed">0</p>
            </div>
             <div class="bg-green-50 dark:bg-green-900/20 p-2 sm:p-3 rounded-xl border border-green-100 dark:border-green-800/50 flex flex-col justify-center items-center">
                 <p class="text-[9px] sm:text-[10px] text-green-600 dark:text-green-400 font-bold uppercase tracking-wider mb-0.5 text-center">Ingresaron</p>
                <p class="text-xl sm:text-2xl font-black text-green-600 dark:text-green-400" id="dashCheckedIn">0</p>
            </div>
        </div>

        <!-- MAIN CONTENT TABS -->
        <div class="flex-1 flex overflow-hidden">
            <div class="flex-1 flex flex-col min-w-0 bg-[#f8fafc] dark:bg-slate-950 transition-colors duration-300">
                
                <!-- MOBILE OPTIMIZED TABS -->
                <div class="border-b border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 overflow-x-auto hide-scrollbar touch-pan-x">
                    <div class="flex px-4 sm:px-6 min-w-max">
                        <button onclick="switchTab('guests')" id="tab-guests" class="py-4 px-4 sm:px-6 border-b-2 border-blue-600 text-blue-600 dark:text-blue-400 font-bold text-base sm:text-sm transition flex items-center justify-center gap-2 active:bg-slate-50 dark:active:bg-slate-800"><i class="fas fa-users text-lg sm:text-base"></i> <span class="hidden sm:inline whitespace-nowrap">Invitados</span></button>
                        <button onclick="switchTab('tables')" id="tab-tables" class="py-4 px-4 sm:px-6 border-b-2 border-transparent text-slate-500 dark:text-slate-400 font-medium text-base sm:text-sm transition flex items-center justify-center gap-2 active:bg-slate-50 dark:active:bg-slate-800"><i class="fas fa-list text-lg sm:text-base"></i> <span class="hidden sm:inline whitespace-nowrap">Mesas</span></button>
                        <button onclick="switchTab('map')" id="tab-map" class="py-4 px-4 sm:px-6 border-b-2 border-transparent text-slate-500 dark:text-slate-400 font-medium text-base sm:text-sm transition flex items-center justify-center gap-2 active:bg-slate-50 dark:active:bg-slate-800"><i class="fas fa-chair text-lg sm:text-base"></i> <span class="hidden sm:inline whitespace-nowrap">Mi Salón</span></button>
                        <button onclick="switchTab('planner')" id="tab-planner" class="py-4 px-4 sm:px-6 border-b-2 border-transparent text-slate-500 dark:text-slate-400 font-medium text-base sm:text-sm transition flex items-center justify-center gap-2 active:bg-slate-50 dark:active:bg-slate-800"><i class="fas fa-qrcode text-lg sm:text-base"></i> <span class="hidden sm:inline whitespace-nowrap">Scanner</span></button>
                    </div>
                </div>
                
                <div class="flex-1 overflow-y-auto p-3 md:p-6 admin-scroll text-slate-800 dark:text-slate-200 h-full relative" id="tabContentArea">
                    
                    <!-- VIEW: GUESTS -->
                    <div id="view-guests" class="space-y-4 md:space-y-6 pb-20">
                        <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-800 overflow-hidden">
                            <div class="px-4 py-4 border-b border-slate-100 dark:border-slate-800 bg-slate-50/50 dark:bg-slate-800/50">
                                <h3 class="font-bold text-slate-700 dark:text-slate-300 text-xs uppercase tracking-wide mb-3">Gestión de Invitados</h3>
                                
                                <!-- BARRA DE ACCIÓN (Línea Horizontal en Desktop) -->
                                <div class="flex flex-wrap items-center gap-2 w-full mb-2">
                                    <button onclick="openAddGuestModal()" class="flex-1 md:flex-none flex items-center justify-center gap-2 text-blue-600 hover:text-blue-800 text-[11px] font-bold uppercase border border-blue-200 px-3 py-2.5 rounded-xl bg-blue-50 dark:bg-blue-900/20 dark:border-blue-800 dark:text-blue-300 active:scale-95 transition whitespace-nowrap"><i class="fas fa-plus"></i> <span class="hidden sm:inline">Nuevo</span></button>
                                    <button onclick="generateWristbands()" class="flex-1 md:flex-none flex items-center justify-center gap-2 text-purple-600 hover:text-purple-800 text-[11px] font-bold uppercase border border-purple-200 px-3 py-2.5 rounded-xl bg-purple-50 dark:bg-purple-900/20 dark:border-purple-800 dark:text-purple-300 active:scale-95 transition whitespace-nowrap"><i class="fas fa-print"></i> <span class="hidden sm:inline">Pases</span></button>
                                    
                                    <div class="relative flex-1 md:flex-none">
                                        <button onclick="document.getElementById('exportDropdown').classList.toggle('show')" class="w-full flex items-center justify-center gap-2 text-slate-600 dark:text-slate-300 hover:text-blue-600 text-[11px] font-bold uppercase border border-slate-200 dark:border-slate-600 px-3 py-2.5 rounded-xl bg-white dark:bg-slate-800 active:scale-95 transition whitespace-nowrap"><i class="fas fa-file-export"></i> <span class="hidden sm:inline">Exportar</span></button>
                                        <div id="exportDropdown" class="dropdown-content mt-1">
                                            <button onclick="exportData('xlsx')"><i class="fas fa-file-excel text-green-600 mr-2"></i> Excel</button>
                                            <button onclick="exportData('pdf')"><i class="fas fa-file-pdf text-red-600 mr-2"></i> PDF</button>
                                            <button onclick="exportData('csv')"><i class="fas fa-file-csv text-slate-500 mr-2"></i> CSV</button>
                                            <button onclick="exportData('doc')"><i class="fas fa-file-word text-blue-600 mr-2"></i> Word</button>
                                        </div>
                                    </div>
                                    
                                    <button onclick="openConfigModal()" class="flex-1 md:flex-none flex items-center justify-center gap-2 text-slate-600 dark:text-slate-300 hover:text-slate-800 text-[11px] font-bold uppercase border border-slate-200 dark:border-slate-700 px-3 py-2.5 rounded-xl bg-white dark:bg-slate-800 active:scale-95 transition whitespace-nowrap"><i class="fas fa-image"></i> <span class="hidden sm:inline">WhatsApp</span></button>
                                    
                                    <!-- BUSCADOR Y FILTRO (Desktop Horizontal / Movil Iconos) -->
                                    <div class="hidden md:flex flex-1 items-center gap-2 min-w-[200px]">
                                        <div class="relative flex-1">
                                            <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
                                            <input type="text" id="searchGuestInput" oninput="document.getElementById('searchGuestInputMob').value=this.value; renderGuestList()" placeholder="Buscar invitado..." class="w-full bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl pl-9 pr-3 py-2 text-xs outline-none focus:border-blue-500 text-slate-800 dark:text-white transition shadow-sm h-[36px]">
                                        </div>
                                        <select id="sortGuestSelect" onchange="document.getElementById('sortGuestSelectMob').value=this.value; renderGuestList()" class="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl px-3 py-2 text-xs outline-none focus:border-blue-500 text-slate-800 dark:text-white font-bold shadow-sm cursor-pointer h-[36px]">
                                            <option value="newest">Recientes</option>
                                            <option value="name">Nombre (A-Z)</option>
                                            <option value="table">Mesa</option>
                                            <option value="tickets">Pases</option>
                                            <option value="confirmed">Confirmados</option>
                                            <option value="unconfirmed">Pendientes</option>
                                        </select>
                                    </div>
                                    
                                    <!-- Iconos Busqueda Movil -->
                                    <button onclick="document.getElementById('mobileSearchTools').classList.toggle('hidden')" class="md:hidden flex-none w-[36px] h-[36px] flex items-center justify-center gap-1 text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-700 rounded-xl bg-white dark:bg-slate-800 active:scale-95 transition"><i class="fas fa-search"></i> <i class="fas fa-sort text-[9px]"></i></button>
                                </div>
                                
                                <!-- Desplegable Busqueda Movil -->
                                <div id="mobileSearchTools" class="hidden md:hidden flex flex-col gap-2 mt-3 p-3 bg-slate-100 dark:bg-slate-800/50 rounded-xl border border-slate-200 dark:border-slate-700">
                                     <div class="relative w-full">
                                        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                                        <input type="text" id="searchGuestInputMob" oninput="document.getElementById('searchGuestInput').value=this.value; renderGuestList()" placeholder="Buscar por nombre..." class="w-full bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-600 rounded-lg pl-9 pr-4 py-2.5 text-sm outline-none focus:border-blue-500 text-slate-800 dark:text-white shadow-sm">
                                    </div>
                                    <div class="relative w-full">
                                        <i class="fas fa-sort absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                                        <select id="sortGuestSelectMob" onchange="document.getElementById('sortGuestSelect').value=this.value; renderGuestList()" class="w-full bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-600 rounded-lg pl-9 pr-4 py-2.5 text-sm outline-none focus:border-blue-500 text-slate-800 dark:text-white font-bold shadow-sm cursor-pointer appearance-none">
                                            <option value="newest">Ordenar: Recientes</option>
                                            <option value="name">Ordenar: Nombre (A-Z)</option>
                                            <option value="table">Ordenar: Mesa</option>
                                            <option value="tickets">Ordenar: Pases</option>
                                            <option value="confirmed">Filtrar: Confirmados</option>
                                            <option value="unconfirmed">Filtrar: Pendientes</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="w-full overflow-x-auto">
                                <!-- Cabecera Alineada Flex -->
                                <div class="hidden md:flex bg-slate-50 dark:bg-slate-800 text-slate-400 uppercase font-bold text-[10px] tracking-wider p-3 w-full items-center justify-between border-b border-slate-100 dark:border-slate-800/50 min-w-[600px]">
                                    <div class="w-1/3 pl-2">Invitado</div>
                                    <div class="w-20 text-center">Mesa</div>
                                    <div class="w-16 text-center">QR</div>
                                    <div class="w-24 text-center">Pax</div>
                                    <div class="w-24 text-center">Estado</div>
                                    <div class="w-24 text-center">Acción</div>
                                </div>
                                <!-- Cuerpo de Lista Flex -->
                                <div id="guestTableBody" class="flex flex-col w-full divide-y divide-slate-100 dark:divide-slate-800/50 min-w-[300px] md:min-w-[600px]"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- VIEW: TABLES (LISTA) -->
                    <div id="view-tables" class="hidden space-y-6 pb-20">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center bg-white dark:bg-slate-900 p-4 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-800 gap-4">
                            <div class="w-full md:w-auto text-center md:text-left">
                                <h3 class="font-bold text-slate-700 dark:text-slate-300">Gestión de Mesas y Acomodo</h3>
                                <p class="text-xs text-slate-400" id="tableStatsText">Calculando...</p>
                            </div>
                            <div class="flex flex-wrap gap-2 w-full md:w-auto">
                                <button onclick="openReconfigureModal()" class="flex-1 md:flex-none bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700 border border-slate-200 dark:border-slate-700 px-4 py-2.5 rounded-xl text-xs font-bold transition active:scale-95 flex items-center justify-center gap-1.5"><i class="fas fa-cog"></i> Configurar Salón</button>
                                <button onclick="emptyAllTables()" class="flex-1 md:flex-none bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 hover:bg-red-100 border border-red-200 dark:border-red-800 px-4 py-2.5 rounded-xl text-xs font-bold transition active:scale-95 flex items-center justify-center gap-1.5"><i class="fas fa-trash-alt"></i> Vaciar</button>
                                <button id="btnUndoLayout" onclick="undoReorganize()" class="hidden flex-1 md:flex-none bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300 hover:bg-slate-300 px-4 py-2.5 rounded-xl text-xs font-bold transition active:scale-95 flex items-center justify-center gap-1.5"><i class="fas fa-undo"></i> Deshacer</button>
                                <button onclick="reorganizeTables()" class="flex-1 md:flex-none bg-blue-600 text-white hover:bg-blue-700 px-4 py-2.5 rounded-xl text-xs font-bold shadow-md transition active:scale-95 flex items-center justify-center gap-1.5"><i class="fas fa-random"></i> Reorganizar</button>
                                <button onclick="autoAssignAll()" class="w-full md:w-auto bg-purple-600 text-white hover:bg-purple-700 px-4 py-2.5 rounded-xl text-xs font-bold shadow-md transition active:scale-95 flex items-center justify-center gap-1.5"><i class="fas fa-magic"></i> Auto-Acomodo</button>
                            </div>
                        </div>
                        <div id="tablesGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                    </div>

                    <!-- VIEW: MAPA INTERACTIVO (MI SALÓN) -->
                    <div id="view-map" class="hidden h-full flex-col min-h-[500px] pb-10">
                        <div class="bg-white dark:bg-slate-900 p-3 sm:p-4 rounded-t-2xl shadow-sm border border-slate-200 dark:border-slate-800 flex flex-col sm:flex-row justify-between items-center z-10 relative gap-3">
                            <h3 class="font-bold text-slate-700 dark:text-slate-300 text-sm w-full sm:w-auto text-center sm:text-left"><i class="fas fa-chair mr-2 text-blue-500"></i> Mi Salón Carta (Acomodo)</h3>
                            <div class="flex gap-2 w-full sm:w-auto">
                                <button onclick="openEditTableModal('new')" class="flex-1 sm:flex-none bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 hover:bg-blue-200 px-4 py-2.5 rounded-xl text-xs font-bold transition active:scale-95 flex justify-center items-center gap-2"><i class="fas fa-plus"></i> Mesa</button>
                                <button onclick="exportMapPdf()" class="flex-1 sm:flex-none bg-slate-800 dark:bg-slate-700 text-white hover:bg-slate-900 px-4 py-2.5 rounded-xl text-xs font-bold transition shadow-lg active:scale-95 flex justify-center items-center gap-2" id="btnSaveMap"><i class="fas fa-file-pdf"></i> PDF Plano</button>
                            </div>
                        </div>
                        <div class="flex-1 border border-t-0 border-slate-200 dark:border-slate-800 rounded-b-2xl relative bg-slate-100 dark:bg-slate-800/50 map-canvas shadow-inner" id="mapScrollArea">
                            <!-- Controles Zoom Móvil -->
                            <div class="absolute bottom-4 right-4 z-20 flex flex-col gap-2 md:hidden">
                                <button onclick="zoomMap(0.15)" class="bg-white dark:bg-slate-800 text-slate-800 dark:text-white w-10 h-10 rounded-full shadow-lg font-bold border border-slate-200 dark:border-slate-700 active:scale-95 flex items-center justify-center"><i class="fas fa-search-plus"></i></button>
                                <button onclick="zoomMap(-0.15)" class="bg-white dark:bg-slate-800 text-slate-800 dark:text-white w-10 h-10 rounded-full shadow-lg font-bold border border-slate-200 dark:border-slate-700 active:scale-95 flex items-center justify-center"><i class="fas fa-search-minus"></i></button>
                            </div>
                            
                            <!-- LIENZO TAMAÑO CARTA (Vertical) -->
                            <div id="venueCanvas" class="relative w-[850px] h-[1100px] bg-white dark:bg-slate-950 map-bg-grid mx-auto mt-4 shadow-xl border border-slate-300 dark:border-slate-700"></div>
                        </div>
                        <p class="text-[10px] sm:text-xs text-slate-400 mt-3 text-center px-4"><i class="fas fa-hand-pointer mr-1"></i> <b>Arrastra</b> las mesas. <b>1 Toque</b> para Zoom. <b>2 Toques</b> para Editar.</p>
                    </div>
                    
                    <!-- VIEW: PLANNER (SCANNER) -->
                    <div id="view-planner" class="hidden space-y-6 pb-20">
                         <div class="bg-white dark:bg-slate-900 p-8 rounded-3xl shadow-sm border border-slate-200 dark:border-slate-800 text-center max-w-sm mx-auto mt-6 sm:mt-10">
                            <div class="w-20 h-20 bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded-full flex items-center justify-center mx-auto mb-6 text-3xl"><i class="fas fa-qrcode"></i></div>
                            <h3 class="text-xl font-bold mb-2 text-slate-800 dark:text-white">Scanner de Acceso</h3>
                            <p class="text-sm text-slate-500 dark:text-slate-400 mb-8">Usa esta herramienta en la entrada del evento para registrar la llegada de los invitados rápidamente.</p>
                            <button onclick="openReceptionView()" class="w-full bg-slate-800 dark:bg-blue-600 text-white py-4 rounded-xl font-bold hover:bg-slate-900 transition shadow-xl active:scale-95 flex justify-center items-center gap-2"><i class="fas fa-camera"></i> Abrir Cámara del Scanner</button>
                            
                            <div class="mt-10 pt-6 border-t border-slate-100 dark:border-slate-800">
                                <p class="text-xs text-slate-500 font-semibold mb-3">Compartir acceso con Recepcionista:</p>
                                <div class="flex items-center gap-1 bg-slate-50 dark:bg-slate-800 p-1.5 rounded-xl border border-slate-200 dark:border-slate-700">
                                    <input type="text" id="plannerLinkInput" class="w-full bg-transparent text-xs outline-none px-3 text-slate-600 dark:text-slate-400" readonly>
                                    <button onclick="copyPlannerLink()" class="bg-white dark:bg-slate-700 text-blue-600 dark:text-blue-400 px-4 py-2 rounded-lg shadow-sm font-bold text-[10px] border border-slate-200 dark:border-slate-600 active:scale-95 transition">COPIAR</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALES OPTIMIZADOS PARA MÓVIL (SCROLL INTERNO) -->

    <!-- INITIAL SETUP MODAL (WELCOME / CONFIGURAR) -->
    <div id="initialSetupModal" class="fixed inset-0 z-[100] hidden bg-slate-900/95 flex items-center justify-center p-4 backdrop-blur-md">
        <div class="bg-white dark:bg-slate-800 p-6 sm:p-8 rounded-3xl shadow-2xl max-w-md w-full relative admin-theme border border-slate-200 dark:border-slate-700 animate__animated animate__zoomIn max-h-[90vh] overflow-y-auto">
            <!-- Close button for reconfiguration (hidden by default initially) -->
            <button id="btnCancelInitSetup" onclick="document.getElementById('initialSetupModal').classList.add('hidden')" class="hidden absolute top-4 right-4 bg-slate-100 dark:bg-slate-800 p-2 rounded-full text-slate-400 hover:text-slate-600 active:scale-95"><i class="fas fa-times w-5 h-5 flex justify-center items-center"></i></button>

            <div class="text-center mb-6 mt-4">
                <div class="w-16 h-16 bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl"><i class="fas fa-glass-cheers"></i></div>
                <h2 id="initSetupTitle" class="text-2xl font-bold text-slate-800 dark:text-white mb-2">¡Bienvenido al Simulador!</h2>
                <p id="initSetupDesc" class="text-sm text-slate-500 dark:text-slate-400">Configuremos el layout inicial de tu salón. Luego podrás mover y personalizar cada mesa libremente.</p>
            </div>
            <form id="initialSetupForm" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1 uppercase">Cantidad de Mesas</label>
                    <input type="number" id="initTableCount" value="10" min="1" max="50" class="w-full p-4 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl outline-none text-slate-800 dark:text-white font-bold text-center text-base sm:text-sm" required>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1 uppercase">Forma Predeterminada</label>
                    <select id="initTableShape" onchange="updateSetupInputs()" class="w-full p-4 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl outline-none text-slate-800 dark:text-white font-bold text-center text-base sm:text-sm">
                        <option value="round">Redonda (Max 10 sillas)</option>
                        <option value="square">Cuadrada (Max 12 sillas)</option>
                        <option value="rect">Rectangular (Sin Límite)</option>
                    </select>
                </div>
                <div id="initRoundConfig" class="block">
                    <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1 uppercase text-center">Capacidad (Sillas)</label>
                    <input type="number" id="initCapacityRound" value="10" min="1" max="10" class="w-full p-4 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl outline-none text-slate-800 dark:text-white font-bold text-center text-base sm:text-sm">
                </div>
                <div id="initSquareConfig" class="hidden flex gap-4">
                    <div class="flex-1">
                        <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1 uppercase text-center">Sillas Largo</label>
                        <input type="number" id="initChairsX" value="3" min="1" class="w-full p-4 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl outline-none text-slate-800 dark:text-white font-bold text-center text-base sm:text-sm">
                    </div>
                    <div class="flex-1">
                        <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1 uppercase text-center">Sillas Ancho</label>
                        <input type="number" id="initChairsY" value="3" min="1" class="w-full p-4 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl outline-none text-slate-800 dark:text-white font-bold text-center text-base sm:text-sm">
                    </div>
                </div>
                <p id="initLimitWarning" class="text-[10px] text-red-500 text-center font-bold hidden">En mesas cuadradas X y Y deben ser iguales (Max 3x3=12 sillas).</p>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg transition mt-6 active:scale-95">Aplicar y Generar Plano</button>
            </form>
        </div>
    </div>

    <!-- EDIT GUEST TABLE MODAL -->
    <div id="editGuestTableModal" class="fixed inset-0 z-[100] hidden bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-slate-800 p-6 sm:p-8 rounded-3xl shadow-2xl max-w-sm w-full relative admin-theme border border-slate-200 dark:border-slate-700 animate__animated animate__zoomIn">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-slate-800 dark:text-white">Asignar Mesa</h3>
                <button type="button" onclick="document.getElementById('editGuestTableModal').classList.add('hidden')" class="bg-slate-100 dark:bg-slate-800 p-2 rounded-full text-slate-400 hover:text-slate-600 active:scale-95"><i class="fas fa-times w-5 h-5 flex justify-center items-center"></i></button>
            </div>
            <form id="editGuestTableForm" class="space-y-4">
                <input type="hidden" id="editGT_id">
                <div>
                    <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-2 uppercase">Selecciona la mesa</label>
                    <select id="editGT_select" class="w-full p-4 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl outline-none text-slate-800 dark:text-white font-bold text-center text-base sm:text-sm"></select>
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg transition mt-4 active:scale-95">Guardar Cambios</button>
            </form>
        </div>
    </div>

    <!-- EDIT GUEST PAX MODAL -->
    <div id="editGuestPaxModal" class="fixed inset-0 z-[100] hidden bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-slate-800 p-6 sm:p-8 rounded-3xl shadow-2xl max-w-sm w-full relative admin-theme border border-slate-200 dark:border-slate-700 animate__animated animate__zoomIn">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-slate-800 dark:text-white">Modificar Pases</h3>
                <button type="button" onclick="document.getElementById('editGuestPaxModal').classList.add('hidden')" class="bg-slate-100 dark:bg-slate-800 p-2 rounded-full text-slate-400 hover:text-slate-600 active:scale-95"><i class="fas fa-times w-5 h-5 flex justify-center items-center"></i></button>
            </div>
            <form id="editGuestPaxForm" class="space-y-4">
                <input type="hidden" id="editGP_id">
                <div>
                    <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-2 uppercase text-center">Cantidad de Pases</label>
                    <input type="number" id="editGP_input" min="1" class="w-full p-4 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl outline-none text-slate-800 dark:text-white font-black text-center text-2xl" required>
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg transition mt-4 active:scale-95">Guardar Cambios</button>
            </form>
        </div>
    </div>

    <!-- TABLE WARNING MODAL -->
    <div id="tableWarningModal" class="fixed inset-0 z-[90] hidden bg-black/80 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-slate-800 p-6 rounded-3xl w-full max-w-sm border border-slate-200 dark:border-slate-700 shadow-2xl animate__animated animate__headShake max-h-[90vh] overflow-y-auto">
            <div class="text-center mb-4">
                <i class="fas fa-exclamation-triangle text-red-500 text-5xl mb-4 drop-shadow-md"></i>
                <h3 class="text-xl font-black text-slate-800 dark:text-white">Capacidad Excedida</h3>
                <p class="text-sm text-slate-500 dark:text-slate-400 mt-2">La mesa <strong class="text-slate-800 dark:text-white" id="twMesa">X</strong> solo tiene <strong class="text-red-500" id="twDisp">0</strong> sillas vacías, pero este invitado requiere <strong class="text-blue-500" id="twReq">0</strong> sillas.</p>
            </div>
            <div class="bg-slate-50 dark:bg-slate-900 p-4 rounded-xl border border-slate-200 dark:border-slate-700 mb-6">
                <p class="text-[10px] font-bold text-slate-400 uppercase mb-3 text-center">Alternativas Sugeridas:</p>
                <div id="twSuggestions" class="flex flex-wrap gap-2 justify-center"></div>
            </div>
            <div class="flex flex-col gap-3">
                <button id="btnAutoSingle" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3.5 rounded-xl shadow-lg transition text-sm flex items-center justify-center gap-2 active:scale-95"><i class="fas fa-magic"></i> Auto-Acomodar Invitado</button>
                <button onclick="closeTableWarning()" class="w-full bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 font-bold py-3.5 rounded-xl transition text-sm active:scale-95">Cancelar Asignación</button>
            </div>
        </div>
    </div>

    <!-- AUTO ASSIGN RESULT MODAL (SPLIT OPTION) -->
    <div id="aaResultModal" class="fixed inset-0 z-[110] hidden bg-black/80 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-slate-800 p-6 rounded-3xl w-full max-w-md border border-slate-200 dark:border-slate-700 shadow-2xl animate__animated animate__fadeInUp max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-2 shrink-0">
                <h3 class="text-xl font-black text-slate-800 dark:text-white"><i class="fas fa-info-circle text-blue-500 mr-2"></i> Reporte de Acomodo</h3>
                <button onclick="closeAaResult()" class="bg-slate-100 dark:bg-slate-800 p-2 rounded-full text-slate-400 hover:text-slate-600 active:scale-95"><i class="fas fa-times w-5 h-5 flex justify-center items-center"></i></button>
            </div>
            <div id="aaResultContent" class="flex-1 overflow-y-auto">
                <!-- Content injected via JS -->
            </div>
        </div>
    </div>

    <!-- EDIT/ADD TABLE MODAL -->
    <div id="editTableModal" class="fixed inset-0 z-[90] hidden bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-slate-900 p-6 rounded-3xl w-full max-w-sm border border-slate-200 dark:border-slate-700 shadow-2xl animate__animated animate__fadeInUp max-h-[90vh] overflow-y-auto admin-scroll">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-slate-800 dark:text-white" id="editTableTitle">Configurar Mesa</h3>
                <button type="button" onclick="document.getElementById('editTableModal').classList.add('hidden')" class="bg-slate-100 dark:bg-slate-800 p-2 rounded-full text-slate-400 hover:text-slate-600 active:scale-95"><i class="fas fa-times w-5 h-5 flex justify-center items-center"></i></button>
            </div>
            <form id="editTableForm" class="space-y-4">
                <input type="hidden" id="editTableId">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-2">NOMBRE/NÚMERO</label>
                        <input type="text" id="editTableLabel" class="w-full p-3 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl outline-none text-base sm:text-sm text-center text-slate-800 dark:text-white font-bold" required>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-2">FORMA</label>
                        <select id="editTableShape" onchange="updateEditInputs()" class="w-full p-3 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl outline-none text-base sm:text-sm text-slate-800 dark:text-white font-bold">
                            <option value="round">Redonda</option>
                            <option value="square">Cuadrada</option>
                            <option value="rect">Rectangular</option>
                        </select>
                    </div>
                </div>

                <div id="editRoundGroup" class="block bg-slate-50 dark:bg-slate-800 p-3 rounded-xl border border-slate-100 dark:border-slate-700">
                    <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-2 text-center">Sillas Totales (Max 10)</label>
                    <input type="number" id="editCapRound" min="1" max="10" class="w-full p-3 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-600 rounded-lg outline-none text-base sm:text-sm text-center text-slate-800 dark:text-white font-bold">
                </div>

                <div id="editSquareGroup" class="hidden gap-4 bg-slate-50 dark:bg-slate-800 p-3 rounded-xl border border-slate-100 dark:border-slate-700">
                    <div class="flex-1">
                        <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-2 text-center">Sillas Largo</label>
                        <input type="number" id="editCapX" min="1" class="w-full p-3 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-600 rounded-lg outline-none text-base sm:text-sm text-center text-slate-800 dark:text-white font-bold">
                    </div>
                    <div class="flex-1">
                        <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-2 text-center">Sillas Ancho</label>
                        <input type="number" id="editCapY" min="1" class="w-full p-3 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-600 rounded-lg outline-none text-base sm:text-sm text-center text-slate-800 dark:text-white font-bold">
                    </div>
                </div>
                <p id="editLimitWarning" class="text-[10px] text-red-500 text-center font-bold hidden px-2">Cuadradas requieren mismas sillas L/A (Max 3x3=12).</p>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-2">DISEÑO VISUAL</label>
                        <select id="editTableDesign" class="w-full p-3 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl outline-none text-base sm:text-xs text-slate-800 dark:text-white font-medium">
                            <option value="bg-white dark:bg-slate-800 border-2 border-slate-300 dark:border-slate-600 text-slate-800 dark:text-white shadow-md">Adaptativo (Día/Noche)</option>
                            <option value="bg-white border-2 border-slate-300 shadow-md text-slate-800">Blanco Clásico Fijo</option>
                            <option value="bg-[url('https://www.transparenttextures.com/patterns/wood-pattern.png')] bg-amber-700 border-4 border-amber-900 text-white shadow-xl">Madera Rústica</option>
                            <option value="bg-slate-900 border-4 border-slate-700 text-white shadow-xl">Negro Elegante Fijo</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-2">ROTACIÓN</label>
                        <div class="flex items-center gap-2">
                            <input type="range" id="editTableRotation" min="0" max="360" value="0" step="15" class="w-full accent-blue-600" oninput="document.getElementById('rotVal').innerText=this.value+'°'">
                            <span id="rotVal" class="text-xs font-bold text-slate-700 dark:text-slate-300 w-8 text-right">0°</span>
                        </div>
                    </div>
                </div>

                <div class="flex gap-3 pt-4">
                    <button type="button" id="btnDeleteTable" onclick="deleteTableFromMap()" class="bg-red-50 text-red-600 px-5 py-3 rounded-xl font-bold text-sm hidden hover:bg-red-100 active:scale-95 transition border border-red-100"><i class="fas fa-trash"></i></button>
                    <button type="submit" class="flex-1 bg-blue-600 text-white font-bold py-3.5 rounded-xl shadow-lg text-sm hover:bg-blue-700 active:scale-95 transition">Guardar Mesa</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL CONFIGURACION GLOBAL (IMAGEN WHASTAPP) -->
    <div id="configModal" class="fixed inset-0 z-[80] hidden bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-slate-900 p-6 rounded-3xl w-full max-w-md border border-slate-200 dark:border-slate-700 shadow-2xl animate__animated animate__fadeInUp">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-slate-800 dark:text-white">Imagen Evento (WhatsApp)</h3>
                <button type="button" onclick="document.getElementById('configModal').classList.add('hidden')" class="bg-slate-100 dark:bg-slate-800 p-2 rounded-full text-slate-400 active:scale-95"><i class="fas fa-times w-5 h-5 flex justify-center items-center"></i></button>
            </div>
            <form id="configForm" class="space-y-4">
                <input type="hidden" id="configImageUrlHidden">
                
                <div class="border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-2xl p-6 text-center hover:bg-slate-50 dark:hover:bg-slate-800 transition cursor-pointer relative" onclick="document.getElementById('configImageFile').click()">
                    <i class="fas fa-cloud-upload-alt text-3xl text-blue-500 mb-2"></i>
                    <p class="text-sm font-bold text-slate-700 dark:text-slate-300">Toca para subir una foto</p>
                    <p class="text-xs text-slate-500 mt-1">Se mostrará al enviar invitaciones y en el código QR</p>
                    <input type="file" id="configImageFile" accept="image/*" class="hidden">
                </div>
                
                <div class="flex justify-center">
                    <img id="configImagePreview" class="hidden rounded-xl max-h-32 object-cover shadow-md border border-slate-200 dark:border-slate-700">
                </div>

                <div class="flex gap-3 pt-4">
                    <button type="button" onclick="document.getElementById('configModal').classList.add('hidden')" class="flex-1 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 py-3.5 rounded-xl font-bold text-sm active:scale-95 transition">Cancelar</button>
                    <button type="submit" class="flex-1 bg-blue-600 text-white font-bold py-3.5 rounded-xl shadow-lg text-sm active:scale-95 transition">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- NEW GUEST MODAL -->
    <div id="addGuestModal" class="fixed inset-0 z-[70] hidden bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-slate-900 p-6 rounded-3xl w-full max-w-sm border border-slate-200 dark:border-slate-700 shadow-2xl max-h-[90vh] overflow-y-auto admin-scroll">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-slate-800 dark:text-white">Nueva Invitación</h3>
                <button type="button" onclick="document.getElementById('addGuestModal').classList.add('hidden')" class="bg-slate-100 dark:bg-slate-800 p-2 rounded-full text-slate-400 active:scale-95"><i class="fas fa-times w-5 h-5 flex justify-center items-center"></i></button>
            </div>
            <form id="addGuestFormModal" class="space-y-5">
                <div>
                    <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-2 uppercase">Nombre o Familia</label>
                    <input type="text" id="inputName" placeholder="Ej. Familia Pérez" class="w-full p-4 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl outline-none text-slate-800 dark:text-white font-bold text-base sm:text-sm" required>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-2 uppercase">WhatsApp</label>
                    <div class="flex">
                        <select id="countryCodeSelect" class="border border-r-0 border-slate-200 dark:border-slate-700 rounded-l-xl bg-slate-50 dark:bg-slate-800 p-4 text-base sm:text-sm text-slate-800 dark:text-white font-bold outline-none"><option value="52">🇲🇽 +52</option><option value="1">🇺🇸 +1</option></select>
                        <input type="tel" id="inputPhone" placeholder="10 dígitos" class="border border-slate-200 dark:border-slate-700 p-4 rounded-r-xl w-full bg-slate-50 dark:bg-slate-800 outline-none text-slate-800 dark:text-white font-bold text-base sm:text-sm" required>
                    </div>
                </div>
                <div class="flex items-center justify-between bg-slate-50 dark:bg-slate-800 p-3 rounded-xl border border-slate-200 dark:border-slate-700">
                    <span class="text-sm font-bold text-slate-500 dark:text-slate-400 ml-2 uppercase">Pases:</span>
                    <div class="flex items-center bg-white dark:bg-slate-900 rounded-lg border border-slate-200 dark:border-slate-700 overflow-hidden shadow-sm">
                        <button type="button" onclick="adjustTickets(-1)" class="w-12 h-12 hover:bg-slate-100 dark:hover:bg-slate-800 font-black text-slate-500 text-lg active:bg-slate-200">-</button>
                        <input type="number" id="inputTickets" value="2" class="w-12 text-center bg-transparent outline-none font-black text-slate-800 dark:text-white text-lg" readonly>
                        <button type="button" onclick="adjustTickets(1)" class="w-12 h-12 hover:bg-slate-100 dark:hover:bg-slate-800 font-black text-slate-500 text-lg active:bg-slate-200">+</button>
                    </div>
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg text-base active:scale-95 transition flex justify-center items-center gap-2 mt-4"><i class="fab fa-whatsapp text-xl"></i> Enviar Invitación</button>
            </form>
        </div>
    </div>

    <!-- QR TICKET MODAL -->
    <div id="qrPreviewModal" class="fixed inset-0 z-[80] hidden bg-black/90 flex items-center justify-center p-4 backdrop-blur-md" onclick="this.classList.add('hidden')">
        <div class="bg-white p-6 sm:p-8 rounded-[2rem] max-w-sm w-full text-center relative shadow-2xl transform transition-transform scale-100 animate__animated animate__zoomIn" onclick="event.stopPropagation()">
            <div id="ticketContainer" class="bg-white p-6 rounded-2xl border-4 border-dashed border-slate-200 mb-6 flex flex-col items-center">
                <!-- CUSTOM BRANDING / LOGO -->
                <div id="qrModalCustomBranding" class="mb-4 flex flex-col items-center justify-center min-h-[60px] w-full text-center"></div>
                
                <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Pase de Acceso</h3>
                <h2 class="text-2xl font-black text-slate-900 mb-3 leading-tight" id="qrModalName">Nombre Invitado</h2>
                <div class="flex justify-center gap-4 text-sm font-bold text-slate-700 mb-5 bg-slate-100 p-3 rounded-xl border border-slate-200 w-full max-w-[200px]">
                    <span id="qrModalPax"><i class="fas fa-users text-slate-400 mr-1"></i> 0</span>
                </div>
                <div id="qrModalCanvas" class="flex justify-center mb-4 p-3 bg-white rounded-xl shadow-inner border border-slate-100 w-fit mx-auto"></div>
                <p class="text-[10px] text-slate-400 font-mono tracking-widest bg-slate-50 py-1 px-4 rounded-lg border border-slate-100" id="qrModalID">ID: ---</p>
            </div>
            <button onclick="downloadQrTicket()" class="w-full bg-slate-900 hover:bg-slate-800 text-white font-bold py-4 rounded-2xl shadow-xl transition flex items-center justify-center gap-2 active:scale-95 text-sm uppercase tracking-wider">
                <i class="fas fa-download"></i> Guardar Imagen
            </button>
            <button onclick="document.getElementById('qrPreviewModal').classList.add('hidden')" class="mt-4 text-xs font-bold text-slate-400 uppercase tracking-wider p-2">Cerrar</button>
        </div>
    </div>

    <!-- GUEST DETAILS MODAL (MOBILE) -->
    <div id="guestDetailModal" class="fixed inset-0 z-[70] hidden bg-black/60 flex items-end sm:items-center justify-center p-0 sm:p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-slate-900 w-full sm:max-w-sm rounded-t-3xl sm:rounded-3xl overflow-hidden animate__animated animate__slideInUp sm:animate__fadeIn border-t border-slate-200 dark:border-slate-700 pb-6 sm:pb-0">
            <div class="p-6">
                <div class="flex justify-between items-start mb-6">
                    <div><h2 id="mobName" class="text-2xl font-black text-slate-800 dark:text-white leading-tight">Nombre</h2><p id="mobPhone" class="text-sm text-slate-400 font-medium mt-1"></p></div>
                    <button onclick="closeMobileDetails()" class="bg-slate-100 dark:bg-slate-800 p-2.5 rounded-full text-slate-500 dark:text-slate-400 active:scale-95"><i class="fas fa-times w-5 h-5 flex items-center justify-center"></i></button>
                </div>
                
                <div class="grid grid-cols-2 gap-3 mb-6">
                    <div class="bg-slate-50 dark:bg-slate-800 p-4 rounded-2xl border border-slate-100 dark:border-slate-700 text-center shadow-sm">
                        <span class="block text-[10px] text-slate-400 uppercase font-bold mb-1"><i class="fas fa-users"></i> Pases</span>
                        <div class="flex justify-center items-center gap-2">
                            <span id="mobTickets" class="text-2xl font-black text-slate-800 dark:text-white">0</span>
                            <button id="btnEditMobPax" class="text-slate-400 hover:text-blue-500 active:scale-95 transition"><i class="fas fa-edit"></i></button>
                        </div>
                    </div>
                    <div class="bg-slate-50 dark:bg-slate-800 p-4 rounded-2xl border border-slate-100 dark:border-slate-700 text-center shadow-sm flex flex-col justify-center">
                        <span class="block text-[10px] text-slate-400 uppercase font-bold mb-1"><i class="fas fa-chair"></i> Mesa</span>
                        <div class="flex justify-center items-center gap-2">
                            <span id="mobTableDisplay" class="text-2xl font-black text-blue-600 dark:text-blue-400">-</span>
                            <button id="mobEditTableBtn" class="text-slate-400 hover:text-blue-500 active:scale-95 transition"><i class="fas fa-edit"></i></button>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-center mb-6">
                    <button id="btnVerQR" class="w-full flex items-center justify-center gap-2 bg-blue-600 text-white px-6 py-4 rounded-2xl text-sm font-bold shadow-lg active:scale-95 transition"><i class="fas fa-qrcode text-lg"></i> Mostrar Código de Acceso</button>
                </div>
                
                <div id="mobStatusBadge" class="w-full py-3.5 rounded-xl text-center font-bold text-sm mb-6 border">Estado</div>
                
                <button id="btnEliminarInvitacion" class="w-full text-red-500 bg-red-50 dark:bg-red-900/10 border border-red-100 dark:border-red-900/30 text-sm font-bold py-3.5 rounded-xl active:scale-95 transition"><i class="fas fa-trash-alt mr-2"></i> Eliminar Invitación</button>
            </div>
        </div>
    </div>

    <!-- VISTA RECEPCIONISTA -->
    <div id="receptionView" class="hidden fixed inset-0 z-[80] bg-slate-900 overflow-y-auto font-sans">
        <div class="bg-slate-800 border-b border-slate-700 p-4 sticky top-0 z-10 flex justify-between items-center shadow-lg">
            <h2 class="text-slate-300 font-bold text-sm flex items-center gap-2"><i class="fas fa-camera text-blue-500"></i> Scanner Acceso</h2>
            <button onclick="exitReception()" class="bg-slate-700 text-slate-300 hover:text-white text-[10px] px-3 py-1.5 rounded-lg font-bold uppercase tracking-wider active:scale-95">Salir</button>
        </div>
        <div class="container mx-auto p-4 max-w-md pb-10">
            <div class="grid grid-cols-2 gap-3 mb-6">
                <div class="bg-slate-800 p-4 rounded-2xl shadow-inner border border-slate-700 text-center"><p class="text-[10px] text-slate-400 uppercase font-bold mb-1">Total Lista</p><p class="text-2xl font-black text-white" id="statTotalGuests">0</p></div>
                <div class="bg-slate-800 p-4 rounded-2xl shadow-inner border border-green-900/50 text-center"><p class="text-[10px] text-green-400 uppercase font-bold mb-1">Ingresaron</p><p class="text-2xl font-black text-green-400" id="statCheckedIn">0</p></div>
            </div>
            <div class="bg-slate-800 p-1.5 rounded-3xl shadow-xl mb-6 border border-slate-700 relative">
                <div class="bg-black rounded-2xl overflow-hidden h-72 relative w-full" id="reader"></div>
                <div class="absolute bottom-5 left-0 w-full text-center pointer-events-none"><span class="bg-black/70 backdrop-blur-sm text-white text-xs px-4 py-2 rounded-full border border-white/20 animate-pulse font-bold shadow-lg"><i class="fas fa-expand text-blue-400 mr-1"></i> Enfoca el QR...</span></div>
            </div>
            <div class="bg-slate-800 p-4 rounded-2xl shadow border border-slate-700 mb-6">
                <p class="text-[10px] text-slate-400 uppercase font-bold mb-2 ml-1">Ingreso Manual</p>
                <div class="flex gap-2"><input type="text" id="manualIdInput" placeholder="ID de 20 caracteres" class="flex-1 bg-slate-900 border border-slate-600 rounded-xl p-3.5 text-sm text-white outline-none focus:border-blue-500 font-mono"><button onclick="onScanSuccess(document.getElementById('manualIdInput').value)" class="bg-blue-600 hover:bg-blue-700 active:scale-95 text-white px-5 rounded-xl text-sm font-bold shadow transition">Validar</button></div>
            </div>
            <div class="bg-slate-800 rounded-2xl shadow border border-slate-700 overflow-hidden">
                <div class="p-4 bg-slate-900/50 border-b border-slate-700 font-bold text-slate-400 text-xs uppercase tracking-widest flex items-center gap-2"><i class="fas fa-history"></i> Historial Reciente</div>
                <ul id="recentCheckins" class="divide-y divide-slate-700 text-sm text-slate-300"></ul>
            </div>
        </div>
    </div>

    <!-- MODAL CHECK-IN RESULTADO -->
    <div id="checkinModal" class="fixed inset-0 z-[90] hidden bg-slate-900/95 flex items-center justify-center px-4 backdrop-blur-md">
        <div class="bg-white dark:bg-slate-800 rounded-3xl shadow-2xl w-full max-w-sm overflow-hidden animate__animated animate__zoomIn border border-slate-200 dark:border-slate-700">
            <div class="bg-blue-600 p-5 text-white text-center shadow-inner"><h3 class="text-sm font-bold uppercase tracking-widest"><i class="fas fa-check-circle mr-1"></i> Validar Acceso</h3></div>
            <div class="p-8 text-center text-slate-800 dark:text-white">
                <h2 id="ciName" class="text-3xl font-black mb-2 leading-none">Nombre</h2>
                <div class="flex justify-center gap-3 my-6">
                    <div class="bg-slate-50 dark:bg-slate-700 border p-4 rounded-2xl w-1/2 border-slate-200 dark:border-slate-600 shadow-sm"><p class="text-[10px] text-slate-400 uppercase font-bold mb-1"><i class="fas fa-chair"></i> Mesa</p><p id="ciTable" class="text-3xl font-black text-blue-600 dark:text-blue-400">-</p></div>
                    <div class="bg-slate-50 dark:bg-slate-700 border p-4 rounded-2xl w-1/2 border-slate-200 dark:border-slate-600 shadow-sm"><p class="text-[10px] text-slate-400 uppercase font-bold mb-1"><i class="fas fa-users"></i> Pases</p><p id="ciTickets" class="text-3xl font-black text-slate-800 dark:text-white">0</p></div>
                </div>
                <div class="text-left mb-8 bg-slate-50 dark:bg-slate-900 p-4 rounded-2xl border border-slate-100 dark:border-slate-700">
                    <label class="block text-[10px] font-bold text-slate-500 dark:text-slate-400 mb-3 uppercase text-center">¿Cuántas personas ingresan ahora?</label>
                    <div class="flex items-center bg-white dark:bg-slate-800 rounded-xl overflow-hidden border border-slate-200 dark:border-slate-600 shadow-sm mx-auto max-w-[200px]">
                        <button onclick="adjustCheckin(-1)" class="w-16 h-14 bg-slate-50 hover:bg-slate-100 dark:bg-slate-700 dark:hover:bg-slate-600 font-black text-2xl text-slate-600 dark:text-slate-300 active:bg-slate-200">-</button>
                        <input type="number" id="ciInput" class="flex-1 text-center font-black h-14 outline-none text-2xl text-slate-800 dark:text-white bg-transparent" value="1" readonly>
                        <button onclick="adjustCheckin(1)" class="w-16 h-14 bg-slate-50 hover:bg-slate-100 dark:bg-slate-700 dark:hover:bg-slate-600 font-black text-2xl text-slate-600 dark:text-slate-300 active:bg-slate-200">+</button>
                    </div>
                </div>
                <div class="flex flex-col gap-3">
                    <button onclick="confirmCheckin()" class="w-full bg-green-500 hover:bg-green-600 text-white py-4 rounded-2xl font-bold shadow-lg shadow-green-500/30 text-lg active:scale-95 transition flex items-center justify-center gap-2"><i class="fas fa-door-open"></i> Dar Acceso</button>
                    <button onclick="closeCheckin()" class="w-full bg-transparent border-2 border-slate-200 dark:border-slate-600 py-3.5 rounded-2xl font-bold text-slate-500 dark:text-slate-400 active:scale-95 transition hover:bg-slate-50 dark:hover:bg-slate-800">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- LOGICA JS OPTIMIZADA -->
    <script>
        const adminPin = "1234";
        let html5QrCode = null;
        let currentGuestIdCheckin = null;
        let currentMobId = null;
        let allGuests = [];
        let eventConfig = { imageUrl: "" };
        let tablesData = {}; 
        let tableOccupancy = {}; 
        let previousLayoutBackup = null;

        window.onclick = function(event) {
            if (!event.target.matches('.dropbtn') && !event.target.closest('#exportDropdown') && !event.target.closest('button') && !event.target.closest('label') && !event.target.closest('select')) {
                var dropdowns = document.getElementsByClassName("dropdown-content");
                for (var i = 0; i < dropdowns.length; i++) { if (dropdowns[i].classList.contains('show')) dropdowns[i].classList.remove('show'); }
            }
        }

        window.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            if (params.get('view') === 'wendy_planner') { document.getElementById('guestView').classList.add('hidden'); openReceptionView(); }
            fetch('https://ipapi.co/json/').then(res => res.json()).then(data => {
                const select = document.getElementById('countryCodeSelect');
                if(select) { const opt = document.createElement('option'); opt.value = data.country_calling_code.replace('+',''); opt.text = `${data.country_name} ${data.country_calling_code}`; select.add(opt, 0); select.selectedIndex = 0; }
            }).catch(e=>{});
            
            // Initial Zoom setup for mobile
            if (window.innerWidth < 768) { mapScale = window.innerWidth / 900; document.getElementById('venueCanvas').style.transform = `scale(${mapScale})`; }
        });

        // --- SISTEMA DE MODALES PERSONALIZADOS ---
        window.showToast = (msg, icon='check') => {
            const t = document.getElementById('toastMsg');
            document.getElementById('toastText').innerText = msg;
            let iconClass = icon === 'check' ? 'fa-check-circle text-green-400' : 'fa-info-circle text-blue-400';
            if(icon==='error') iconClass = 'fa-times-circle text-red-400';
            document.getElementById('toastIcon').innerHTML = `<i class="fas ${iconClass}"></i>`;
            t.classList.remove('-translate-y-32', 'opacity-0');
            setTimeout(() => t.classList.add('-translate-y-32', 'opacity-0'), 3000);
        }

        window.showAlert = (title, text, type='info') => {
            let icon = type==='error'?'<i class="fas fa-times-circle text-red-500"></i>':(type==='success'?'<i class="fas fa-check-circle text-green-500"></i>':'<i class="fas fa-info-circle text-blue-500"></i>');
            document.getElementById('sysModalIcon').innerHTML = icon;
            document.getElementById('sysModalTitle').innerText = title;
            document.getElementById('sysModalText').innerText = text;
            document.getElementById('sysModalActions').innerHTML = `<button onclick="closeSysModal()" class="w-full bg-slate-800 dark:bg-slate-700 text-white font-bold py-3.5 rounded-xl active:scale-95 transition shadow-lg">Aceptar</button>`;
            document.getElementById('sysModal').classList.remove('hidden');
        }

        window.showConfirm = (title, text, confirmCb) => {
            document.getElementById('sysModalIcon').innerHTML = '<i class="fas fa-question-circle text-yellow-500"></i>';
            document.getElementById('sysModalTitle').innerText = title;
            document.getElementById('sysModalText').innerText = text;
            window.tempConfirmCb = () => { closeSysModal(); confirmCb(); };
            document.getElementById('sysModalActions').innerHTML = `
                <button onclick="closeSysModal()" class="flex-1 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 font-bold py-3.5 rounded-xl active:scale-95 transition">Cancelar</button>
                <button onclick="window.tempConfirmCb()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 rounded-xl active:scale-95 transition shadow-lg">Confirmar</button>
            `;
            document.getElementById('sysModal').classList.remove('hidden');
        }
        window.closeSysModal = () => document.getElementById('sysModal').classList.add('hidden');


        // FUNCIONES ADMIN
        window.openAdminLogin = () => document.getElementById('loginModal').classList.remove('hidden');
        window.closeAdmin = () => document.getElementById('adminPanel').classList.add('translate-y-full');
        window.checkLogin = () => {
            if (document.getElementById('adminPassword').value === adminPin) {
                document.getElementById('loginModal').classList.add('hidden');
                document.getElementById('adminPanel').classList.remove('translate-y-full');
                loadConfig(); 
                document.getElementById('plannerLinkInput').value = window.location.origin + window.location.pathname + "?view=wendy_planner";
            } else { showAlert("Acceso Denegado", "El PIN ingresado es incorrecto.", "error"); }
        }
        window.switchTab = (tabName) => {
            ['guests', 'tables', 'map', 'planner'].forEach(t => {
                document.getElementById(`view-${t}`).classList.add('hidden');
                const btn = document.getElementById(`tab-${t}`);
                if(btn){ btn.classList.replace('text-blue-600','text-slate-500'); btn.classList.replace('dark:text-blue-400','dark:text-slate-400'); btn.classList.replace('border-blue-600','border-transparent'); }
            });
            document.getElementById(`view-${tabName}`).classList.remove('hidden');
            const activeBtn = document.getElementById(`tab-${tabName}`);
            activeBtn.classList.replace('text-slate-500','text-blue-600'); activeBtn.classList.replace('dark:text-slate-400','dark:text-blue-400'); activeBtn.classList.replace('border-transparent','border-blue-600');
            if(tabName === 'tables') renderTablesView();
            if(tabName === 'map') renderMap();
        }

        window.openReconfigureModal = () => {
            document.getElementById('initialSetupModal').classList.remove('hidden');
            document.getElementById('initSetupTitle').innerText = "Configurar Salón";
            document.getElementById('initSetupDesc').innerText = "Define la cantidad de mesas y sillas. Precaución: Al aplicar, esto reiniciará el plano actual.";
            document.getElementById('btnCancelInitSetup').classList.remove('hidden');
            if(Object.keys(tablesData).length > 0) document.getElementById('initTableCount').value = Object.keys(tablesData).length;
        }

        function loadConfig() {
            if(!window.db) return;
            window.onSnapshot(window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'settings', 'config'), (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if(data.imageUrl) {
                        eventConfig.imageUrl = data.imageUrl;
                        document.getElementById('configImageUrlHidden').value = data.imageUrl;
                        document.getElementById('configImagePreview').src = data.imageUrl;
                        document.getElementById('configImagePreview').classList.remove('hidden');
                    }
                    if(data.tablesData) tablesData = data.tablesData;
                }
                if (Object.keys(tablesData).length === 0) {
                    document.getElementById('initSetupTitle').innerText = "¡Bienvenido al Simulador!";
                    document.getElementById('initSetupDesc').innerText = "Configuremos el layout inicial de tu salón. Luego podrás mover y personalizar cada mesa libremente.";
                    document.getElementById('btnCancelInitSetup').classList.add('hidden');
                    document.getElementById('initialSetupModal').classList.remove('hidden');
                } else {
                    document.getElementById('initialSetupModal').classList.add('hidden');
                    loadAdminData(); 
                }
            });
        }

        window.updateSetupInputs = () => {
            const shape = document.getElementById('initTableShape').value;
            const roundGrp = document.getElementById('initRoundConfig'); const sqGrp = document.getElementById('initSquareConfig'); const limitW = document.getElementById('initLimitWarning');
            if(shape === 'round') { roundGrp.classList.remove('hidden'); sqGrp.classList.add('hidden'); limitW.classList.add('hidden'); }
            else { 
                roundGrp.classList.add('hidden'); sqGrp.classList.remove('hidden'); sqGrp.classList.add('flex');
                if(shape === 'square') { limitW.classList.remove('hidden'); document.getElementById('initChairsX').max = 3; document.getElementById('initChairsY').max = 3; }
                else { limitW.classList.add('hidden'); document.getElementById('initChairsX').removeAttribute('max'); document.getElementById('initChairsY').removeAttribute('max'); }
            }
        }

        document.getElementById('initialSetupForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const count = parseInt(document.getElementById('initTableCount').value);
            const shape = document.getElementById('initTableShape').value;
            let capRound = parseInt(document.getElementById('initCapacityRound').value);
            let cX = parseInt(document.getElementById('initChairsX').value);
            let cY = parseInt(document.getElementById('initChairsY').value);
            
            if(shape === 'square') { if(cX !== cY) { showAlert("Aviso", "Largo y ancho deben ser iguales en mesas cuadradas.", "info"); return; } if(cX > 3) cX = 3; cY = cX; }
            if(shape === 'round' && capRound > 10) capRound = 10;

            const applySetup = async () => {
                const newTables = {}; let cols = Math.ceil(Math.sqrt(count)); 
                for(let i=1; i<=count; i++) {
                    const row = Math.floor((i-1) / cols); const col = (i-1) % cols;
                    newTables[i] = { id: String(i), shape: shape, capacity: shape === 'round' ? capRound : 0, chairsX: shape !== 'round' ? cX : 0, chairsY: shape !== 'round' ? cY : 0, x: 50 + (col * 200), y: 50 + (row * 200), design: "bg-white dark:bg-slate-800 border-2 border-slate-300 dark:border-slate-600 text-slate-800 dark:text-white shadow-md", rotation: 0 };
                }
                try {
                    if (Object.keys(tablesData).length > 0) {
                        for(let g of allGuests) { if(g.table) await window.updateDoc(window.doc(window.db,'artifacts',window.appId,'public','data','guests',g.id), {table: ""}); }
                    }
                    await window.setDoc(window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'settings', 'config'), { tablesData: newTables, imageUrl: eventConfig.imageUrl || "" });
                    document.getElementById('initialSetupModal').classList.add('hidden');
                    showToast("Salón configurado correctamente", "check");
                    previousLayoutBackup = null;
                    const undoBtn = document.getElementById('btnUndoLayout'); if(undoBtn) undoBtn.classList.add('hidden');
                    loadAdminData();
                } catch (err) { showAlert("Error", "No se pudo guardar la configuración de mesas.", "error"); }
            };

            if (Object.keys(tablesData).length > 0) {
                showConfirm("Reconfigurar Salón", "Esto eliminará el plano actual y desasignará a todos los invitados de sus mesas. ¿Deseas continuar?", applySetup);
            } else {
                applySetup();
            }
        });

        window.loadAdminData = function() {
            if(!window.db) return;
            const q = window.query(window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'guests'), window.orderBy('createdAt', 'desc'));
            window.onSnapshot(q, (snapshot) => {
                allGuests = []; let totalG = 0, confirmedG = 0, checkedInG = 0;
                tableOccupancy = {}; Object.keys(tablesData).forEach(k => tableOccupancy[k] = 0);

                snapshot.forEach((docSnap) => {
                    const g = docSnap.data(); g.id = docSnap.id; allGuests.push(g);
                    totalG += g.tickets; if(g.confirmed) confirmedG += g.tickets; if(g.checkedIn) checkedInG += (g.actualAttendees || g.tickets);
                    if (g.table && tableOccupancy[g.table] !== undefined) tableOccupancy[g.table] += g.tickets;
                });
                
                window.renderGuestList();
                if(document.getElementById('dashTotalGuests')) document.getElementById('dashTotalGuests').innerText = totalG;
                if(document.getElementById('dashConfirmed')) document.getElementById('dashConfirmed').innerText = confirmedG;
                if(document.getElementById('dashCheckedIn')) document.getElementById('dashCheckedIn').innerText = checkedInG;
                if(!document.getElementById('view-tables').classList.contains('hidden')) renderTablesView();
                if(!document.getElementById('view-map').classList.contains('hidden')) renderMap();
            });
        }

        function getTableCapacity(t) { return t.shape === 'round' ? t.capacity : (t.chairsX + t.chairsY) * 2; }

        window.renderGuestList = function() {
            const tbody = document.getElementById('guestTableBody');
            tbody.innerHTML = ''; 
            
            let searchTerm = document.getElementById('searchGuestInput')?.value.toLowerCase() || '';
            let sortOption = document.getElementById('sortGuestSelect')?.value || 'newest';
            
            let filteredGuests = allGuests.filter(g => g.name.toLowerCase().includes(searchTerm));
            
            if (sortOption === 'confirmed') filteredGuests = filteredGuests.filter(g => g.confirmed);
            if (sortOption === 'unconfirmed') filteredGuests = filteredGuests.filter(g => !g.confirmed && !g.checkedIn);
            
            filteredGuests.sort((a, b) => {
                if (sortOption === 'name') return a.name.localeCompare(b.name);
                if (sortOption === 'table') return String(a.table || '').localeCompare(String(b.table || ''), undefined, {numeric: true});
                if (sortOption === 'tickets') return b.tickets - a.tickets;
                return 0; // default (newest) from Firebase
            });

            filteredGuests.forEach((g) => {
                const tr = document.createElement('div'); 
                tr.className = "flex flex-col md:flex-row w-full p-2 md:p-3 hover:bg-slate-50 dark:hover:bg-slate-800 transition";
                
                let deskStatusLabel = `<span class="bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-300 px-2 py-1 rounded text-[10px] font-bold">Pendiente</span>`;
                let mobStatusClass = "border-transparent bg-white dark:bg-slate-900 border border-slate-100 dark:border-slate-800";
                
                if (g.confirmed) { 
                    deskStatusLabel = `<span class="bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-400 px-2 py-1 rounded text-[10px] font-bold">Confirmado</span>`; 
                    mobStatusClass = "status-card-confirmed";
                }
                if (g.checkedIn) { 
                    deskStatusLabel = `<span class="bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 px-2 py-1 rounded text-[10px] font-bold">Ingresó</span>`;
                    mobStatusClass = "status-card-checkedin";
                }
                
                let tableDisplay = g.table ? g.table : '';
                let tableBtn = `<button onclick="event.stopPropagation(); window.openEditGuestTable('${g.id}', '${g.table||''}')" class="text-slate-400 hover:text-blue-500 transition ml-2"><i class="fas fa-edit"></i></button>`;
                let paxBtn = `<button onclick="event.stopPropagation(); window.openEditGuestPax('${g.id}', ${g.tickets})" class="text-slate-400 hover:text-blue-500 transition ml-2"><i class="fas fa-edit"></i></button>`;
                let mobileResendBtn = `<button onclick="event.stopPropagation(); resendInvitation('${g.id}', '${g.name}', '${g.phone}')" class="flex items-center justify-center gap-1.5 bg-[#25D366] hover:bg-green-600 text-white px-3 py-2.5 rounded-xl text-sm font-bold w-full mt-3 active:scale-95 transition shadow-sm border border-green-600/50"><i class="fab fa-whatsapp text-lg"></i> Reenviar Invitación</button>`;

                tr.innerHTML = `
                    <!-- VISTA MÓVIL (Oculta en md+) -->
                    <div class="md:hidden w-full p-4 rounded-xl mb-1 ${mobStatusClass}" onclick="openMobileDetails('${g.id}')">
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="font-black text-slate-800 dark:text-white text-lg leading-tight mb-1">${g.name}</div>
                                <div class="text-xs text-slate-500 flex items-center gap-2">
                                    <span class="bg-slate-200 dark:bg-slate-700 px-2 py-1 rounded-md font-bold text-slate-700 dark:text-slate-300"><i class="fas fa-users mr-1"></i> ${g.tickets}</span>
                                    <span class="bg-blue-100 dark:bg-blue-900/40 text-blue-700 dark:text-blue-400 px-2 py-1 rounded-md font-bold"><i class="fas fa-chair mr-1"></i> ${tableDisplay || 'Sin Mesa'}</span>
                                </div>
                            </div>
                            <button onclick="event.stopPropagation(); showGuestQR('${g.id}', '${g.name}', '${g.tickets}')" class="w-12 h-12 rounded-full bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 flex items-center justify-center shadow-md border border-slate-100 dark:border-slate-700 active:scale-95"><i class="fas fa-qrcode text-xl"></i></button>
                        </div>
                        ${mobileResendBtn}
                    </div>

                    <!-- VISTA ESCRITORIO (Oculta en móvil) -->
                    <div class="hidden md:flex w-full items-center justify-between">
                        <div class="w-1/3 font-bold text-slate-700 dark:text-slate-300 text-sm truncate pl-2 pr-2">${g.name}</div>
                        <div class="w-20 text-center"><span class="font-bold text-slate-600 dark:text-slate-300">${tableDisplay}</span>${tableBtn}</div>
                        <div class="w-16 text-center"><button onclick="showGuestQR('${g.id}', '${g.name}', '${g.tickets}')" class="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-500 hover:text-blue-500 transition active:scale-95 flex items-center justify-center mx-auto"><i class="fas fa-qrcode"></i></button></div>
                        <div class="w-24 text-center"><span class="font-bold text-slate-600 dark:text-slate-300 text-sm">${g.tickets}</span>${paxBtn}</div>
                        <div class="w-24 text-center">${deskStatusLabel}</div>
                        <div class="w-24 text-center flex justify-center gap-2"><button onclick="resendInvitation('${g.id}', '${g.name}', '${g.phone}')" class="w-8 h-8 rounded-full bg-green-50 dark:bg-green-900/20 text-green-500 hover:bg-green-100 transition active:scale-95" title="Reenviar"><i class="fab fa-whatsapp"></i></button><button onclick="confirmDeleteGuest('${g.id}')" class="w-8 h-8 rounded-full bg-red-50 dark:bg-red-900/20 text-red-400 hover:bg-red-100 hover:text-red-500 transition active:scale-95" title="Eliminar"><i class="fas fa-trash-alt"></i></button></div>
                    </div>
                `;
                tbody.appendChild(tr);
            });
            
            if(filteredGuests.length === 0) {
                 tbody.innerHTML = `<div class="p-8 text-center text-slate-400 dark:text-slate-500 font-bold text-sm">No se encontraron invitados.</div>`;
            }
        }

        // --- ASIGNACIÓN DE MESAS (VÍA MODAL DE EDICIÓN NATIVA) ---
        window.openEditGuestTable = (id, currentTable) => {
            const g = allGuests.find(x => x.id === id);
            if(!g) return;
            document.getElementById('editGT_id').value = id;
            const sel = document.getElementById('editGT_select');
            sel.innerHTML = '<option value="">Sin Asignar</option>';
            
            Object.values(tablesData).sort((a,b) => a.id.localeCompare(b.id, undefined, {numeric:true})).forEach(t => {
                let occ = tableOccupancy[t.id] || 0;
                let cap = getTableCapacity(t);
                let isCurrent = (currentTable == t.id);
                let available = cap - occ;
                let extra = `(${occ}/${cap})`;
                if (cap > 0 && !isCurrent && available < g.tickets) extra = `(Lleno)`;
                if (isCurrent) extra = `(Actual)`;
                
                sel.innerHTML += `<option value="${t.id}" ${isCurrent ? 'selected' : ''}>${t.id} ${extra}</option>`;
            });
            
            document.getElementById('editGuestTableModal').classList.remove('hidden');
        };

        document.getElementById('editGuestTableForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const id = document.getElementById('editGT_id').value;
            const newTable = document.getElementById('editGT_select').value;
            const g = allGuests.find(x => x.id === id);
            if(!g) return;

            if(!newTable) { 
                window.updateDoc(window.doc(window.db,'artifacts',window.appId,'public','data','guests',id), {table:""}); 
                showToast("Mesa removida", "check"); 
                document.getElementById('editGuestTableModal').classList.add('hidden');
                if(currentMobId === id) openMobileDetails(id);
                return; 
            }

            const tObj = tablesData[newTable];
            if(!tObj) return;
            
            let cap = getTableCapacity(tObj); 
            let currentOcc = tableOccupancy[newTable] || 0; 
            let availableSpace = cap - currentOcc;
            if(g.table === newTable) availableSpace += g.tickets;

            if (newTable !== g.table && g.tickets > availableSpace) {
                document.getElementById('editGuestTableModal').classList.add('hidden');
                
                let suggestions = [];
                Object.values(tablesData).forEach(t => { 
                    if (t.id != newTable && (getTableCapacity(t) - (tableOccupancy[t.id]||0)) >= g.tickets) suggestions.push(t.id); 
                });
                document.getElementById('twMesa').innerText = newTable; 
                document.getElementById('twDisp').innerText = availableSpace; 
                document.getElementById('twReq').innerText = g.tickets;
                let suggDiv = document.getElementById('twSuggestions');
                if (suggestions.length > 0) { 
                    suggDiv.innerHTML = suggestions.slice(0,6).map(s => `<button onclick="assignAndCloseWarning('${id}', '${s}')" class="bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 px-4 py-2 rounded-lg text-xs font-bold transition active:scale-95 border border-blue-200 dark:border-blue-800">${s}</button>`).join(''); 
                } else { 
                    suggDiv.innerHTML = '<span class="text-red-500 text-xs font-bold bg-red-50 dark:bg-red-900/20 px-3 py-2 rounded-lg">Ninguna otra mesa disponible.</span>'; 
                }
                document.getElementById('btnAutoSingle').onclick = () => { autoAssignSingle(id, g.tickets); closeTableWarning(); };
                document.getElementById('tableWarningModal').classList.remove('hidden');
            } else {
                window.updateDoc(window.doc(window.db,'artifacts',window.appId,'public','data','guests',id), {table: newTable}); 
                showToast(`Asignado correctamente`, "check");
                document.getElementById('editGuestTableModal').classList.add('hidden');
                if(currentMobId === id) openMobileDetails(id);
            }
        });

        // --- ASIGNACIÓN DE PASES (VÍA MODAL DE EDICIÓN NATIVA) ---
        window.openEditGuestPax = (id, pax) => {
            document.getElementById('editGP_id').value = id;
            document.getElementById('editGP_input').value = pax;
            document.getElementById('editGuestPaxModal').classList.remove('hidden');
        };

        document.getElementById('editGuestPaxForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('editGP_id').value;
            const newPax = parseInt(document.getElementById('editGP_input').value);
            if(!newPax || newPax < 1) return;
            
            await window.updateDoc(window.doc(window.db,'artifacts',window.appId,'public','data','guests',id), {tickets: newPax});
            showToast("Pases actualizados", "check");
            document.getElementById('editGuestPaxModal').classList.add('hidden');
            if(currentMobId === id) openMobileDetails(id);
        });

        window.closeTableWarning = () => document.getElementById('tableWarningModal').classList.add('hidden');
        window.assignAndCloseWarning = (guestId, tableId) => { window.updateDoc(window.doc(window.db,'artifacts',window.appId,'public','data','guests',guestId), {table: tableId}); closeTableWarning(); showToast(`Asignado correctamente`, "check"); if(currentMobId === guestId) openMobileDetails(guestId); }
        
        window.autoAssignSingle = (guestId, tickets) => {
             for(let t of Object.values(tablesData).sort((a,b)=>parseInt(a.id)-parseInt(b.id))) { 
                 if ((getTableCapacity(t) - (tableOccupancy[t.id]||0)) >= tickets) { window.updateDoc(window.doc(window.db,'artifacts',window.appId,'public','data','guests',guestId), {table: t.id}); showToast(`Acomodado correctamente`, "check"); if(currentMobId === guestId) openMobileDetails(guestId); return; } 
             }
             showAlert("Aviso", "No hay ninguna mesa con el espacio suficiente para esta familia.", "info");
        }

        window.autoAssignAll = async () => {
             if (allGuests.length === 0) { showAlert("Lista Vacía", "No hay invitados registrados en la lista.", "info"); return; }
             let unassigned = allGuests.filter(g => !g.table || g.table === "Sin Asignar");
             if (unassigned.length === 0) { showAlert("¡Excelente!", "Todos los invitados ya tienen una mesa asignada.", "success"); return; }
             if (Object.keys(tablesData).length === 0) { showAlert("Faltan Mesas", "Aún no tienes mesas configuradas en el mapa.", "error"); return; }
             
             // Check if it's from reorganize button logic (previousLayoutBackup is active)
             if (!previousLayoutBackup) {
                 showConfirm("Acomodo Inteligente BFD", `El sistema analizará a ${unassigned.length} familias para encajarlas de la forma más exacta en las mesas sin separarlas. ¿Continuar?`, runAutoAssignLogic);
             } else {
                 runAutoAssignLogic();
             }
        }
        
        const runAutoAssignLogic = async () => {
             showToast("Calculando la mejor distribución...", "info");
             let unassigned = allGuests.filter(g => !g.table || g.table === "Sin Asignar");
             
             // Si viene de reorganizar, le damos una pequeñísima variación aleatoria si tienen el mismo tamaño
             unassigned.sort((a,b) => {
                 let diff = (parseInt(b.tickets)||1) - (parseInt(a.tickets)||1);
                 if (diff === 0 && previousLayoutBackup) return Math.random() - 0.5;
                 return diff;
             }); 
             
             let tempOcc = {...tableOccupancy}; 
             let countAssigned = 0;
             let failedGuests = [];
             
             for(let g of unassigned) {
                 let reqTix = parseInt(g.tickets) || 1;
                 
                 let validTables = Object.values(tablesData)
                    .filter(t => (getTableCapacity(t) - (tempOcc[t.id]||0)) >= reqTix)
                    .sort((a, b) => {
                        let huecoA = (getTableCapacity(a) - (tempOcc[a.id]||0)) - reqTix;
                        let huecoB = (getTableCapacity(b) - (tempOcc[b.id]||0)) - reqTix;
                        return huecoA - huecoB; 
                    });
                 
                 if (validTables.length > 0) {
                     let chosen = validTables[0].id; 
                     tempOcc[chosen] = (tempOcc[chosen] || 0) + reqTix;
                     await window.updateDoc(window.doc(window.db,'artifacts',window.appId,'public','data','guests',g.id), {table: String(chosen)}); 
                     countAssigned++;
                 } else {
                     failedGuests.push(g);
                 }
             }
             
             if (failedGuests.length === 0) {
                 if(!previousLayoutBackup) showAlert("¡Acomodo Exitoso!", `Se acomodaron perfectamente a las ${countAssigned} familias sin separar a nadie.`, "success");
                 else showToast("Distribución reorganizada exitosamente", "success");
             } else {
                 openAutoAssignResult(countAssigned, failedGuests);
             }
        }

        window.openAutoAssignResult = (count, failedGuests) => {
            let html = `<div class="bg-yellow-50 dark:bg-yellow-900/20 p-4 rounded-xl mb-4 border border-yellow-200 dark:border-yellow-800"><p class="text-sm text-yellow-800 dark:text-yellow-400 font-medium">Acomodamos a <b>${count}</b> familias con éxito, pero las siguientes superan el tamaño de cualquier hueco restante. Puedes elegir dividirlas.</p></div><div class="space-y-3 max-h-60 overflow-y-auto pr-2 admin-scroll">`;
            
            failedGuests.forEach(g => {
                html += `<div class="bg-slate-50 dark:bg-slate-800 p-4 rounded-xl border border-slate-200 dark:border-slate-700 flex flex-col sm:flex-row justify-between items-center gap-3">
                    <div class="text-center sm:text-left"><p class="font-bold text-slate-800 dark:text-white text-base leading-tight">${g.name}</p><p class="text-[10px] text-slate-500 uppercase font-bold mt-1 bg-slate-200 dark:bg-slate-700 inline-block px-2 py-0.5 rounded">${g.tickets} lugares requeridos</p></div>
                    <button onclick="splitFamily('${g.id}')" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white px-4 py-2.5 rounded-xl text-xs font-bold active:scale-95 transition flex items-center justify-center gap-2 shadow-sm"><i class="fas fa-cut"></i> Dividir y Acomodar</button>
                </div>`;
            });
            html += `</div>`;
            document.getElementById('aaResultContent').innerHTML = html;
            document.getElementById('aaResultModal').classList.remove('hidden');
        }
        window.closeAaResult = () => document.getElementById('aaResultModal').classList.add('hidden');

        window.splitFamily = async (guestId) => {
            let g = allGuests.find(x => x.id === guestId); if(!g) return;
            let reqTix = parseInt(g.tickets) || 1;
            
            let availableSeats = [];
            Object.values(tablesData).forEach(t => {
                let free = getTableCapacity(t) - (tableOccupancy[t.id] || 0);
                if (free > 0) availableSeats.push({ id: t.id, free: free });
            });
            availableSeats.sort((a,b) => b.free - a.free);
            
            let totalFree = availableSeats.reduce((sum, t) => sum + t.free, 0);
            if (totalFree < reqTix) {
                showAlert("Imposible Separar", "No hay sillas vacías suficientes en todo el salón para acomodar a esta familia, ni siquiera separándolos.", "error"); return;
            }

            showToast("Separando familia...", "info");
            let remaining = reqTix; let isOriginalUpdated = false; let partCounter = 2;
            
            for (let seat of availableSeats) {
                if (remaining <= 0) break;
                let take = Math.min(remaining, seat.free);
                if (!isOriginalUpdated) {
                    await window.updateDoc(window.doc(window.db,'artifacts',window.appId,'public','data','guests',g.id), { tickets: take, table: seat.id });
                    isOriginalUpdated = true;
                } else {
                    let newDocRef = window.doc(window.collection(window.db,'artifacts',window.appId,'public','data','guests'));
                    await window.setDoc(newDocRef, { name: `${g.name} (P.${partCounter})`, phone: g.phone, tickets: take, table: seat.id, checkedIn: g.checkedIn, confirmed: g.confirmed, createdAt: new Date().toISOString() }); 
                    partCounter++;
                }
                remaining -= take; tableOccupancy[seat.id] = (tableOccupancy[seat.id] || 0) + take;
            }
            closeAaResult();
            showAlert("¡Acomodados!", `La familia ${g.name} fue dividida exitosamente para ocupar los lugares disponibles.`, "success");
        }
        
        // --- VACÍAR Y REORGANIZAR MESAS ---
        window.emptyAllTables = () => {
            showConfirm("Vaciar Todo", "¿Estás seguro que deseas quitar a TODOS los invitados de sus mesas? Volverán a estar 'Sin Asignar'.", async () => {
                showToast("Vaciando mesas...", "info");
                for(let g of allGuests) {
                    if(g.table) await window.updateDoc(window.doc(window.db,'artifacts',window.appId,'public','data','guests',g.id), {table: ""});
                }
                document.getElementById('btnUndoLayout').classList.add('hidden');
                previousLayoutBackup = null;
                showToast("Todas las mesas fueron vaciadas.", "success");
            });
        }
        
        window.reorganizeTables = () => {
            if (allGuests.filter(g => g.table).length === 0 && allGuests.length > 0) {
                autoAssignAll(); return;
            }
            showConfirm("Reorganizar Acomodo", "El sistema desasignará y volverá a acomodar a los invitados de una forma nueva. Podrás deshacer el cambio si no te gusta. ¿Continuar?", async () => {
                showToast("Guardando estado previo...", "info");
                previousLayoutBackup = {};
                allGuests.forEach(g => previousLayoutBackup[g.id] = g.table || "");
                document.getElementById('btnUndoLayout').classList.remove('hidden');
                
                for(let g of allGuests) { if(g.table) await window.updateDoc(window.doc(window.db,'artifacts',window.appId,'public','data','guests',g.id), {table: ""}); }
                setTimeout(() => { autoAssignAll(); }, 1500); // Dar tiempo a que db actualice
            });
        }
        
        window.undoReorganize = async () => {
            if(!previousLayoutBackup) return;
            showToast("Restaurando distribución anterior...", "info");
            for(let g of allGuests) {
                if(previousLayoutBackup[g.id] !== undefined) {
                    await window.updateDoc(window.doc(window.db,'artifacts',window.appId,'public','data','guests',g.id), {table: previousLayoutBackup[g.id]});
                }
            }
            previousLayoutBackup = null;
            document.getElementById('btnUndoLayout').classList.add('hidden');
            showToast("Distribución restaurada a como estaba.", "success");
        }

        function renderTablesView() { 
            const g=document.getElementById('tablesGrid'); g.innerHTML=''; const t={}; let unassignedCount = 0;
            
            // Asegurar que todas las mesas existan en el diccionario t
            Object.keys(tablesData).forEach(k => t[k] = []);
            
            allGuests.forEach(x=>{ 
                const k = x.table || 'Sin Asignar'; 
                if(!t[k]) t[k]=[]; 
                t[k].push(x); 
                if(!x.table || x.table === "Sin Asignar") unassignedCount++; 
            }); 
            
            document.getElementById('tableStatsText').innerText = `${unassignedCount} invitados sin mesa.`;
            if(t['Sin Asignar'] && t['Sin Asignar'].length > 0) g.innerHTML+=createTableCard('Sin Asignar',t['Sin Asignar'],'slate', null); 
            
            let sortedKeys = Object.keys(t).filter(k=>k!=='Sin Asignar').sort((a,b)=>a.localeCompare(b, undefined, {numeric:true}));
            sortedKeys.forEach(k => { g.innerHTML += createTableCard(k, t[k], 'blue', k); }); 
        }

        function createTableCard(t,gList,c, tableId) { 
            const tot=gList.reduce((s,x)=>s+x.tickets,0); 
            let isFull = false; let cap = 0;
            if(tableId && tablesData[tableId]) { cap = getTableCapacity(tablesData[tableId]); isFull = tot >= cap; }
            const borderColor = c === 'blue' ? (isFull ? 'border-red-400' : 'border-blue-500 dark:border-blue-700') : 'border-slate-300 dark:border-slate-700';
            const bgColor = c === 'blue' ? 'bg-white dark:bg-slate-800' : 'bg-slate-50 dark:bg-slate-800/50';
            let extraBadge = '';
            
            if (tableId) {
                if (isFull) extraBadge = `<span class="text-[10px] text-red-500 font-bold ml-2 bg-red-50 dark:bg-red-900/20 px-2 py-0.5 rounded uppercase">Lleno</span>`;
                else extraBadge = `<span class="text-[10px] text-slate-400 font-bold ml-2">(${tot}/${cap})</span>`;
            }
            
            let h=`<div class="${bgColor} border-t-4 ${borderColor} shadow-sm rounded-2xl p-5 transition-transform hover:-translate-y-1 duration-300 flex flex-col"><div class="flex justify-between items-center mb-4 border-b border-slate-100 dark:border-slate-700 pb-2"><h4 class="font-bold text-slate-800 dark:text-white flex items-center">${t} ${extraBadge}</h4><span class="text-[10px] bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 px-2 py-1 rounded-md font-bold">${tot} Pax</span></div>`; 
            if (gList.length === 0) {
                h += `<p class="text-xs text-slate-400 italic text-center py-2 flex-1 flex items-center justify-center">Mesa vacía</p>`;
            } else {
                h += `<ul class="text-xs text-slate-500 dark:text-slate-400 space-y-2 flex-1 overflow-y-auto max-h-40 admin-scroll">`;
                gList.forEach(x=>h+=`<li class="flex justify-between items-center pb-2 border-b border-slate-50 dark:border-slate-700 last:border-0 last:pb-0"><span class="${x.confirmed?'text-yellow-600 dark:text-yellow-400 font-bold':''}">${x.name}</span> <span class="font-bold bg-slate-50 dark:bg-slate-700 border border-slate-100 dark:border-slate-600 px-1.5 py-0.5 rounded">${x.tickets}</span></li>`); 
                h += `</ul>`;
            }
            return h+'</div>'; 
        }

        // --- MAPA INTERACTIVO Y FÍSICA ---
        let mapDragging = null; let startX = 0, startY = 0, initTbX = 0, initTbY = 0; let mapScale = 1;
        
        window.zoomMap = (delta) => {
            mapScale += delta;
            if(mapScale < 0.3) mapScale = 0.3;
            if(mapScale > 2) mapScale = 2;
            document.getElementById('venueCanvas').style.transform = `scale(${mapScale})`;
        }

        window.renderMap = () => {
            const canvas = document.getElementById('venueCanvas'); canvas.innerHTML = '';
            const colors = ['bg-blue-500', 'bg-green-500', 'bg-purple-500', 'bg-pink-500', 'bg-indigo-500', 'bg-teal-500', 'bg-orange-500', 'bg-cyan-500'];

            Object.values(tablesData).forEach(t => {
                let cap = getTableCapacity(t); let guestsAtTable = allGuests.filter(g => g.table === t.id);
                let occupiedChairs = [];
                guestsAtTable.forEach((g, idx) => { const cColor = colors[idx % colors.length]; for(let i=0; i<g.tickets; i++) occupiedChairs.push({ name: g.name, color: cColor }); });
                let chairsHTML = ''; let tWidth = 0, tHeight = 0;
                let rot = t.rotation || 0;
                
                // Actualizar diseños antiguos al formato adaptativo correcto para la vista nocturna
                let currentDesign = t.design;
                if (currentDesign === "bg-white border-2 border-slate-300" || currentDesign.includes("bg-white border-2 border-slate-300") && !currentDesign.includes("dark:")) {
                     currentDesign = "bg-white dark:bg-slate-800 border-2 border-slate-300 dark:border-slate-600 shadow-md";
                }

                if (t.shape === 'round') {
                    const radius = Math.max(40, cap * 7); tWidth = radius * 2; tHeight = radius * 2;
                    for(let i=0; i<cap; i++) {
                        const angle = (i / cap) * 2 * Math.PI; 
                        const cx = radius + Math.cos(angle) * (radius + 28); // Separacion aumentada y perfecta
                        const cy = radius + Math.sin(angle) * (radius + 28);
                        const cData = occupiedChairs[i]; const bgClass = cData ? cData.color : 'chair-empty'; const nLabel = cData ? `<div class="chair-name">${cData.name}</div>` : '';
                        chairsHTML += `<div class="chair-node ${bgClass}" style="left: ${cx}px; top: ${cy}px; transform: translate(-50%, -50%);">${nLabel}</div>`;
                    }
                    canvas.innerHTML += `<div id="map-tb-${t.id}" class="absolute draggable-table" style="left: ${t.x}px; top: ${t.y}px;" onmousedown="startDrag(event, '${t.id}')" ontouchstart="startDrag(event, '${t.id}'); handleTableTap(event, '${t.id}')" ondblclick="openEditTableModal('${t.id}')">
                        <div class="relative rounded-full shadow-2xl table-inner ${currentDesign}" style="width: ${tWidth}px; height: ${tHeight}px; transform: rotate(${rot}deg);">
                            <span class="absolute inset-0 flex items-center justify-center font-black text-slate-800 dark:text-white text-xl pointer-events-none" style="transform: rotate(-${rot}deg);">${t.id}</span>
                            ${chairsHTML}
                        </div>
                    </div>`;
                } else {
                    tWidth = Math.max(60, t.chairsX * 42 + 20); tHeight = Math.max(60, t.chairsY * 42 + 20); let cIndex = 0;
                    const addChair = (cx, cy) => {
                        const cData = occupiedChairs[cIndex++]; const bgClass = cData ? cData.color : 'chair-empty'; const nLabel = cData ? `<div class="chair-name">${cData.name}</div>` : '';
                        chairsHTML += `<div class="chair-node ${bgClass}" style="left: ${cx}px; top: ${cy}px; transform: translate(-50%, -50%);">${nLabel}</div>`;
                    }
                    const spacingX = (tWidth) / (t.chairsX || 1);
                    for(let i=0; i<t.chairsX; i++) addChair((spacingX/2) + i*spacingX, -16); // Separación perfecta afuera
                    for(let i=0; i<t.chairsX; i++) addChair((spacingX/2) + i*spacingX, tHeight + 16);
                    const spacingY = (tHeight) / (t.chairsY || 1);
                    for(let i=0; i<t.chairsY; i++) addChair(-16, (spacingY/2) + i*spacingY);
                    for(let i=0; i<t.chairsY; i++) addChair(tWidth + 16, (spacingY/2) + i*spacingY);

                    canvas.innerHTML += `<div id="map-tb-${t.id}" class="absolute draggable-table" style="left: ${t.x}px; top: ${t.y}px;" onmousedown="startDrag(event, '${t.id}')" ontouchstart="startDrag(event, '${t.id}'); handleTableTap(event, '${t.id}')" ondblclick="openEditTableModal('${t.id}')">
                        <div class="relative shadow-2xl rounded-lg table-inner ${currentDesign}" style="width: ${tWidth}px; height: ${tHeight}px; transform: rotate(${rot}deg);">
                            <span class="absolute inset-0 flex items-center justify-center font-black text-slate-800 dark:text-white text-xl pointer-events-none" style="transform: rotate(-${rot}deg);">${t.id}</span>
                            ${chairsHTML}
                        </div>
                    </div>`;
                }
            });
        }

        // Doble Toque en Móvil (y un toque)
        let lastTapMap = {};
        window.handleTableTap = (e, id) => {
            const now = Date.now();
            const last = lastTapMap[id] || 0;
            
            if (window.innerWidth < 768) {
                if (now - last < 400 && now - last > 0) {
                    // Doble toque: Editar mesa
                    openEditTableModal(id);
                    e.preventDefault(); 
                } else {
                    // Un toque: Zoom y centrar en esa mesa
                    const t = tablesData[id];
                    if(t) {
                        mapScale = 1.3; // Zoom in
                        document.getElementById('venueCanvas').style.transform = `scale(${mapScale})`;
                        const mapArea = document.getElementById('mapScrollArea');
                        const targetX = (t.x * mapScale) - (mapArea.clientWidth / 2) + 50; 
                        const targetY = (t.y * mapScale) - (mapArea.clientHeight / 2) + 50;
                        setTimeout(() => { mapArea.scrollTo({ left: targetX, top: targetY, behavior: 'smooth' }); }, 300);
                    }
                }
            } else {
                // Desktop, let ondblclick handle edit
            }
            lastTapMap[id] = now;
        };

        window.startDrag = (e, id) => {
            if (e.target.closest('.chair-node')) return; 
            mapDragging = id;
            const clientX = e.touches ? e.touches[0].clientX : e.clientX; const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            startX = clientX; startY = clientY; initTbX = tablesData[id].x; initTbY = tablesData[id].y;
            document.getElementById(`map-tb-${id}`).style.zIndex = 1000;
        }

        const mapArea = document.getElementById('mapScrollArea');
        mapArea.addEventListener('mousemove', (e) => {
            if (!mapDragging) return;
            const dx = (e.clientX - startX) / mapScale; const dy = (e.clientY - startY) / mapScale;
            const el = document.getElementById(`map-tb-${mapDragging}`);
            tablesData[mapDragging].x = initTbX + dx; tablesData[mapDragging].y = initTbY + dy;
            el.style.left = tablesData[mapDragging].x + 'px'; el.style.top = tablesData[mapDragging].y + 'px';
        });
        mapArea.addEventListener('touchmove', (e) => {
            if (!mapDragging) return;
            const dx = (e.touches[0].clientX - startX) / mapScale; const dy = (e.touches[0].clientY - startY) / mapScale;
            const el = document.getElementById(`map-tb-${mapDragging}`);
            tablesData[mapDragging].x = initTbX + dx; tablesData[mapDragging].y = initTbY + dy;
            el.style.left = tablesData[mapDragging].x + 'px'; el.style.top = tablesData[mapDragging].y + 'px';
            e.preventDefault();
        }, { passive: false });

        const endDrag = () => { 
            if(mapDragging){ 
                document.getElementById(`map-tb-${mapDragging}`).style.zIndex = ''; 
                saveMapToFirebase(); // Autoguardado al soltar
                mapDragging = null; 
            } 
        }
        mapArea.addEventListener('mouseup', endDrag); mapArea.addEventListener('mouseleave', endDrag); mapArea.addEventListener('touchend', endDrag);

        window.saveMapToFirebase = async () => {
            try { 
                // Evitamos el "merge:true" para poder eliminar correctamente las mesas borradas del layout
                await window.setDoc(window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'settings', 'config'), { tablesData: tablesData, imageUrl: eventConfig.imageUrl || "" }); 
            } catch(e) { console.error("Error auto-save"); }
        }
        
        // Exportar MAPA a PDF (Tamaño Carta)
        window.exportMapPdf = () => {
            showToast("Generando Plano en PDF...", "info");
            const oldScale = mapScale;
            document.getElementById('venueCanvas').style.transform = `scale(1)`; 
            setTimeout(() => {
                html2canvas(document.getElementById('venueCanvas'), { scale: 2, useCORS: true, backgroundColor: "#ffffff" }).then(canvas => {
                    const imgData = canvas.toDataURL('image/jpeg', 0.9);
                    const { jsPDF } = window.jspdf;
                    // Forzamos formato carta vertical
                    const pdf = new jsPDF({ orientation: 'portrait', unit: 'px', format: 'letter' });
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);
                    pdf.save('Plano_Fiesteala_Carta.pdf');
                    document.getElementById('venueCanvas').style.transform = `scale(${oldScale})`; 
                    showToast("PDF Carta Exportado", "check");
                });
            }, 500);
        }

        // --- EDITAR MESA INDIVIDUAL ---
        window.openEditTableModal = (id) => {
            document.getElementById('editTableForm').reset();
            if (id === 'new') {
                document.getElementById('editTableTitle').innerText = "Nueva Mesa"; document.getElementById('editTableId').value = ""; document.getElementById('editTableLabel').value = Object.keys(tablesData).length + 1; document.getElementById('btnDeleteTable').classList.add('hidden'); document.getElementById('editTableShape').value = 'round';
                document.getElementById('editTableRotation').value = 0; document.getElementById('rotVal').innerText = "0°";
                updateEditInputs();
            } else {
                const t = tablesData[id];
                document.getElementById('editTableTitle').innerText = "Editar: " + id; document.getElementById('editTableId').value = id; document.getElementById('editTableLabel').value = t.id; document.getElementById('editTableShape').value = t.shape; document.getElementById('editTableDesign').value = t.design;
                document.getElementById('editTableRotation').value = t.rotation || 0; document.getElementById('rotVal').innerText = (t.rotation || 0) + "°";
                updateEditInputs();
                if(t.shape === 'round') document.getElementById('editCapRound').value = t.capacity; else { document.getElementById('editCapX').value = t.chairsX; document.getElementById('editCapY').value = t.chairsY; }
                document.getElementById('btnDeleteTable').classList.remove('hidden');
            }
            document.getElementById('editTableModal').classList.remove('hidden');
        }

        window.updateEditInputs = () => {
            const shape = document.getElementById('editTableShape').value;
            const roundGrp = document.getElementById('editRoundGroup'); const sqGrp = document.getElementById('editSquareGroup'); const limitW = document.getElementById('editLimitWarning');
            if(shape === 'round') { roundGrp.classList.remove('hidden'); sqGrp.classList.add('hidden'); limitW.classList.add('hidden'); }
            else { 
                roundGrp.classList.add('hidden'); sqGrp.classList.remove('hidden'); sqGrp.classList.add('flex');
                if(shape === 'square') { limitW.classList.remove('hidden'); document.getElementById('editCapX').max = 3; document.getElementById('editCapY').max = 3; }
                else { limitW.classList.add('hidden'); document.getElementById('editCapX').removeAttribute('max'); document.getElementById('editCapY').removeAttribute('max'); }
            }
        }

        document.getElementById('editTableForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const originalId = document.getElementById('editTableId').value; const newId = document.getElementById('editTableLabel').value; const shape = document.getElementById('editTableShape').value; const design = document.getElementById('editTableDesign').value;
            let capRound = parseInt(document.getElementById('editCapRound').value) || 10; let cX = parseInt(document.getElementById('editCapX').value) || 3; let cY = parseInt(document.getElementById('editCapY').value) || 3;
            let rot = parseInt(document.getElementById('editTableRotation').value) || 0;

            if(shape === 'square') { if(cX !== cY) { showAlert("Aviso", "Cuadradas: L y A deben ser iguales.", "info"); return; } if(cX > 3) cX=3; cY=cX; }
            if(shape === 'round' && capRound > 10) capRound = 10;

            if (originalId && originalId !== newId) {
                tablesData[newId] = {...tablesData[originalId], id: newId, shape, design, rotation: rot, capacity: shape==='round'?capRound:0, chairsX: shape!=='round'?cX:0, chairsY: shape!=='round'?cY:0};
                delete tablesData[originalId];
                allGuests.forEach(g => { if(g.table === originalId) window.updateDoc(window.doc(window.db,'artifacts',window.appId,'public','data','guests',g.id), {table: newId}); });
            } else {
                const tid = originalId || newId;
                const tx = originalId ? tablesData[originalId].x : (Math.abs(mapArea.scrollLeft) + 150) / mapScale; const ty = originalId ? tablesData[originalId].y : (Math.abs(mapArea.scrollTop) + 150) / mapScale;
                tablesData[tid] = { id: tid, shape, design, rotation: rot, capacity: shape==='round'?capRound:0, chairsX: shape!=='round'?cX:0, chairsY: shape!=='round'?cY:0, x: tx, y: ty };
            }
            saveMapToFirebase(); document.getElementById('editTableModal').classList.add('hidden'); renderMap(); renderTablesView();
        });

        window.deleteTableFromMap = () => {
            const id = document.getElementById('editTableId').value;
            showConfirm("Eliminar Mesa", `¿Deseas eliminar la mesa ${id}? Los invitados volverán a la lista "Sin Asignar".`, () => {
                delete tablesData[id];
                allGuests.forEach(g => { if(g.table === id) window.updateDoc(window.doc(window.db,'artifacts',window.appId,'public','data','guests',g.id), {table: ""}); });
                saveMapToFirebase(); document.getElementById('editTableModal').classList.add('hidden'); renderMap(); renderTablesView();
            });
        }

        // --- FUNCIONES RESTANTES Y RECUPERADAS ---
        window.openMobileDetails = (id) => {
            if(window.innerWidth > 768) return; 
            const g = allGuests.find(guest => guest.id === id); if(!g) return;
            currentMobId = id; 
            document.getElementById('mobName').innerText = g.name; 
            document.getElementById('mobPhone').innerText = g.phone; 
            document.getElementById('mobTickets').innerText = g.tickets;
            
            document.getElementById('mobTableDisplay').innerText = g.table || '-';
            document.getElementById('mobEditTableBtn').onclick = () => window.openEditGuestTable(g.id, g.table||'');
            document.getElementById('btnEditMobPax').onclick = () => window.openEditGuestPax(g.id, g.tickets);

            const badge = document.getElementById('mobStatusBadge');
            if(g.checkedIn) { badge.className = "w-full py-4 rounded-xl text-center font-black text-sm mb-4 bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300"; badge.innerText = "YA INGRESÓ"; }
            else if(g.confirmed) { badge.className = "w-full py-4 rounded-xl text-center font-black text-sm mb-4 bg-yellow-100 text-yellow-700 dark:bg-yellow-900 dark:text-yellow-300"; badge.innerText = "CONFIRMADO"; }
            else { badge.className = "w-full py-4 rounded-xl text-center font-black text-sm mb-4 bg-slate-100 text-slate-500 dark:bg-slate-800 dark:text-slate-400"; badge.innerText = "PENDIENTE"; }
            
            document.getElementById('btnVerQR').onclick = () => showGuestQR(g.id, g.name, g.tickets);
            document.getElementById('btnEliminarInvitacion').onclick = () => { confirmDeleteGuest(g.id); closeMobileDetails(); };
            document.getElementById('guestDetailModal').classList.remove('hidden');
        }
        window.closeMobileDetails = () => document.getElementById('guestDetailModal').classList.add('hidden');

        // Lógica Subida Archivo Config (Base64 reducida para evitar limite Firebase)
        document.getElementById('configImageFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                    const MAX_WIDTH = 600; let width = img.width; let height = img.height;
                    if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                    canvas.width = width; canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.6); // Comprimido para DB
                    document.getElementById('configImagePreview').src = dataUrl;
                    document.getElementById('configImagePreview').classList.remove('hidden');
                    document.getElementById('configImageUrlHidden').value = dataUrl;
                }
                img.src = event.target.result;
            }
            reader.readAsDataURL(file);
        });

        document.getElementById('configForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const url = document.getElementById('configImageUrlHidden').value;
            try {
                await window.setDoc(window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'settings', 'config'), { imageUrl: url, tablesData: tablesData }, { merge: true });
                eventConfig.imageUrl = url;
                document.getElementById('configModal').classList.add('hidden');
                showToast("Imagen guardada exitosamente");
            } catch (err) { showAlert("Error", "La imagen es demasiado grande o hubo un error.", "error"); }
        });

        window.confirmDeleteGuest = (id) => { showConfirm("Eliminar Invitado", "¿Estás seguro de eliminar permanentemente a este invitado?", async () => { await window.deleteDoc(window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'guests', id)); showToast("Invitado eliminado"); }); }
        window.copyToClipboard = (text) => { var t = document.createElement("textarea"); t.value = text; document.body.appendChild(t); t.select(); document.execCommand('copy'); document.body.removeChild(t); showToast("Copiado al portapapeles"); }
        window.openAddGuestModal = () => document.getElementById('addGuestModal').classList.remove('hidden');
        window.openConfigModal = () => document.getElementById('configModal').classList.remove('hidden');
        
        window.showGuestQR = (id, name, tickets) => { 
            document.getElementById('qrModalName').innerText = name; 
            document.getElementById('qrModalPax').innerHTML = `<i class="fas fa-users text-slate-400 mr-1"></i> ${tickets}`; 
            
            // Branding Dinámico desde Invitación Externa
            const guestView = document.getElementById('guestView');
            const h1Element = guestView.querySelector('h1, h2, .event-title');
            const logoCont = document.getElementById('qrModalCustomBranding');
            
            if (eventConfig.imageUrl) {
                logoCont.innerHTML = `<img src="${eventConfig.imageUrl}" class="w-16 h-16 rounded-full object-cover shadow-sm border border-slate-200" alt="Evento">`;
            } else if (h1Element) {
                const computed = window.getComputedStyle(h1Element);
                logoCont.innerHTML = `<span style="font-family: ${computed.fontFamily}; color: ${computed.color}; font-size: 1.25rem; font-weight: 800; line-height: 1; letter-spacing: -0.5px; text-transform: uppercase;">${h1Element.innerText}</span>`;
            } else {
                logoCont.innerHTML = `<div class="w-12 h-12 bg-slate-900 text-white rounded-full flex items-center justify-center border-2 border-slate-200"><i class="fas fa-ticket-alt text-lg"></i></div>`;
            }
            
            document.getElementById('qrModalID').innerText = `ID: ${id}`; 
            const canvasContainer = document.getElementById('qrModalCanvas'); 
            canvasContainer.innerHTML = ''; 
            new QRCode(canvasContainer, { text: id, width: 200, height: 200, colorDark : "#0f172a", colorLight : "#ffffff" }); 
            document.getElementById('qrPreviewModal').classList.remove('hidden'); 
        }
        
        window.downloadQrTicket = () => { const ticketElement = document.getElementById("ticketContainer"); html2canvas(ticketElement, { scale: 3, useCORS: true, backgroundColor: "#ffffff" }).then(canvas => { const link = document.createElement('a'); link.download = `Ticket_${document.getElementById('qrModalName').innerText}.png`; link.href = canvas.toDataURL("image/png"); link.click(); }); }
        window.resendInvitation = (id, name, phone) => { const link = `${window.location.origin}${window.location.pathname}?id=${id}`; const msg = `¡Hola ${name}! 🎟️ Aquí tienes tu invitación digital. Confirma asistencia: ${link}`; window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`, '_blank'); }
        
        window.exportData = (type) => {
            const data = allGuests.map(g => ({ Nombre: g.name, ID: g.id, Pases: g.tickets, Mesa: g.table || 'Sin Asignar', Estado: g.checkedIn ? 'Ingresó' : (g.confirmed ? 'Confirmado' : 'Pendiente'), Teléfono: g.phone || '' }));
            if(type === 'csv') { let csv = "Nombre,ID,Pases,Mesa,Estado,Teléfono\n"; data.forEach(d => csv += `${d.Nombre},${d.ID},${d.Pases},${d.Mesa},${d.Estado},${d.Teléfono}\n`); const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' }); saveAs(blob, "invitados.csv"); } 
            else if (type === 'xlsx') { const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Invitados"); XLSX.writeFile(wb, "invitados.xlsx"); }
            else if (type === 'doc') { let html = '<html><head><meta charset="utf-8"></head><body><h2>Lista de Invitados</h2><table border="1" style="width:100%; border-collapse:collapse;"><tr><th>Nombre</th><th>ID</th><th>Pax</th><th>Mesa</th><th>Estado</th></tr>'; data.forEach(d => html += `<tr><td>${d.Nombre}</td><td>${d.ID}</td><td>${d.Pases}</td><td>${d.Mesa}</td><td>${d.Estado}</td></tr>`); html += '</table></body></html>'; const blob = new Blob(['\ufeff', html], { type: 'application/msword' }); saveAs(blob, "invitados.doc"); }
            else if (type === 'pdf') { const { jsPDF } = window.jspdf; const doc = new jsPDF(); doc.text("Lista de Invitados", 14, 15); const tableColumn = ["Nombre", "ID", "Pax", "Mesa", "Estado"]; const tableRows = data.map(d => [d.Nombre, d.ID, d.Pases, d.Mesa, d.Estado]); doc.autoTable({ head: [tableColumn], body: tableRows, startY: 20 }); doc.save("invitados.pdf"); }
            document.getElementById('exportDropdown').classList.remove('show');
        }

        window.generateWristbands = () => {
            if (allGuests.length === 0) { showAlert("Aviso", "No hay invitados.", "info"); return; }
            document.getElementById('exportDropdown').classList.remove('show');
            const printArea = document.getElementById('printableArea'); printArea.innerHTML = ''; const pageDiv = document.createElement('div'); pageDiv.className = 'wristband-page';
            const logoSvg = `<svg viewBox="0 0 400 150" xmlns="http://www.w3.org/2000/svg" style="width:100%; height:auto;"><g transform="translate(50, 20)"><path d="M10,10 L30,70 L45,45 L70,30 Z" fill="#000000" stroke="#ffffff" stroke-width="3" /><g transform="translate(10, 10)"><path d="M-3,-6 L-6,-12" stroke="#000000" stroke-width="3" stroke-linecap="round" /><path d="M-6,-3 L-12,-6" stroke="#000000" stroke-width="3" stroke-linecap="round" /><path d="M3,-6 L6,-12" stroke="#000000" stroke-width="3" stroke-linecap="round" /><circle cx="-9" cy="-9" r="2" fill="#000000" /></g></g><g transform="translate(130, 85)"><text font-family="sans-serif" font-weight="800" font-size="44" fill="#000000" letter-spacing="-1">fiesteala</text><circle cx="182" cy="-5" r="4.5" fill="#000000" /><text x="188" y="0" font-family="sans-serif" font-weight="400" font-size="24" fill="#000000">com</text></g></svg>`;
            allGuests.forEach(g => {
                const band = document.createElement('div'); band.className = 'wristband';
                const lLogo = document.createElement('div'); lLogo.className = 'wristband-edge-logo'; lLogo.innerHTML = logoSvg;
                const rLogo = document.createElement('div'); rLogo.className = 'wristband-edge-logo'; rLogo.innerHTML = logoSvg;
                const content = document.createElement('div'); content.className = 'wristband-center';
                const info = document.createElement('div'); info.innerHTML = `<div style="font-size: 11px; font-weight:800; text-transform: uppercase; margin-bottom:3px; letter-spacing: 1px;">ACCESO VIP</div>`;
                const qrDiv = document.createElement('div'); qrDiv.style.cssText = "margin: 0 auto; padding: 2px; background: white;"; new QRCode(qrDiv, { text: g.id, width: 75, height: 75, colorDark : "#000000", colorLight : "#ffffff" });
                const gName = document.createElement('div'); gName.style.cssText = "font-size: 10px; font-weight:600; margin-top:3px; text-transform: uppercase;"; gName.innerText = g.name;
                content.appendChild(info); content.appendChild(qrDiv); content.appendChild(gName);
                band.appendChild(lLogo); band.appendChild(content); band.appendChild(rLogo); pageDiv.appendChild(band);
            });
            printArea.appendChild(pageDiv); setTimeout(() => { window.print(); }, 800);
        }

        window.adjustTickets = (v) => { const el=document.getElementById('inputTickets'); let n=parseInt(el.value)+v; if(n<1)n=1; el.value=n; }

        document.getElementById('addGuestFormModal').addEventListener('submit', async(e)=>{ 
            e.preventDefault(); 
            const n=document.getElementById('inputName').value; const p=document.getElementById('inputPhone').value; const t=document.getElementById('inputTickets').value; const country = document.getElementById('countryCodeSelect').value;
            try { 
                const newDocRef = window.doc(window.collection(window.db,'artifacts',window.appId,'public','data','guests')); const link = `${window.location.origin}${window.location.pathname}?id=${newDocRef.id}`;
                const msg = `¡Hola ${n}! 🎟️ Aquí tienes tu invitación digital. Confirma asistencia: ${link}`; window.open(`https://wa.me/${country+p}?text=${encodeURIComponent(msg)}`, '_blank');
                await window.setDoc(newDocRef, { name:n, phone:country+p, tickets:parseInt(t), table:"", checkedIn:false, confirmed:false, createdAt:new Date().toISOString() }); 
                e.target.reset(); document.getElementById('inputTickets').value="2"; document.getElementById('addGuestModal').classList.add('hidden');
                showToast("Invitado creado correctamente");
            } catch(e){ showAlert("Error", "No se pudo crear la invitación.", "error"); } 
        });

        window.openReceptionView = () => { document.getElementById('adminPanel').classList.add('translate-y-full'); document.getElementById('receptionView').classList.remove('hidden'); startScanner(); }
        window.exitReception = () => { if (html5QrCode) { html5QrCode.stop().then(() => { html5QrCode.clear(); html5QrCode = null; }).catch(err => console.log(err)); } document.getElementById('receptionView').classList.add('hidden'); if(window.location.search.includes('wendy_planner')) window.location.href = window.location.pathname; }
        window.copyPlannerLink = () => { copyToClipboard(document.getElementById('plannerLinkInput').value); }
        
        function startScanner() { if (html5QrCode) return; html5QrCode = new Html5Qrcode("reader"); html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, onScanSuccess).catch(e=>{}); }
        async function onScanSuccess(d) { if(html5QrCode) html5QrCode.pause(); try{ const s=await window.getDoc(window.doc(window.db,'artifacts',window.appId,'public','data','guests',d)); if(s.exists()){ const x=s.data(); currentGuestIdCheckin=d; document.getElementById('ciName').innerText=x.name; document.getElementById('ciTable').innerText=x.table||"-"; document.getElementById('ciTickets').innerText=x.tickets; document.getElementById('ciInput').value=x.tickets; if(x.checkedIn) showAlert("Aviso", "Este invitado YA INGRESÓ anteriormente.", "info"); document.getElementById('checkinModal').classList.remove('hidden'); }else{ showAlert("Inválido", "El QR no pertenece a este evento.", "error"); if(html5QrCode) html5QrCode.resume(); } }catch(e){ showAlert("Error", "Fallo al leer el QR", "error"); if(html5QrCode) html5QrCode.resume(); } }
        window.adjustCheckin=(v)=>{ const el=document.getElementById('ciInput'); let n=parseInt(el.value)+v; if(n<0)n=0; el.value=n; }
        window.closeCheckin=()=>{ document.getElementById('checkinModal').classList.add('hidden'); if(html5QrCode) html5QrCode.resume(); }
        window.confirmCheckin=async()=>{ const a=parseInt(document.getElementById('ciInput').value); if(currentGuestIdCheckin){ await window.updateDoc(window.doc(window.db,'artifacts',window.appId,'public','data','guests',currentGuestIdCheckin),{checkedIn:true,actualAttendees:a,checkinTime:new Date().toISOString()}); const li=document.createElement('li'); li.className="p-4 bg-slate-800/50 border-b border-slate-700 last:border-0 flex justify-between"; li.innerHTML=`<span class="text-slate-300 font-medium">${document.getElementById('ciName').innerText}</span> <strong class="text-green-400 bg-green-900/30 px-3 py-1 rounded-lg text-xs">${a} pax</strong>`; document.getElementById('recentCheckins').prepend(li); closeCheckin(); showToast("Acceso Registrado"); } }
    </script>
</body>
</html>