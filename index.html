<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Panel Inteligente Fiesteala</title>
    
    <!-- TAILWIND CSS & DARK MODE -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class', 
            theme: { extend: { fontFamily: { sans: ['Inter', 'sans-serif'], mono: ['Courier Prime', 'monospace'] } } }
        }
    </script>

    <!-- FUENTES E ICONOS -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <!-- LIBRERÍAS FUNCIONALES -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <script>
        function applyAdminTheme() {
            const hour = new Date().getHours();
            const isNight = hour >= 19 || hour < 6;
            const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const systemLight = window.matchMedia('(prefers-color-scheme: light)').matches;
            let enableDark = systemDark ? true : (systemLight ? false : isNight);
            
            if (systemDark) enableDark = true;
            
            const adminComponents = [
                'adminPanel', 'loginModal', 'addGuestModal', 'qrPreviewModal', 'guestDetailModal', 
                'receptionView', 'checkinModal', 'configModal', 'initialSetupModal', 'tableConfigModal',
                'tableWarningModal', 'editTableModal', 'sysModal', 'aaResultModal',
                'editGuestTableModal', 'editGuestPaxModal', 'editObjectModal'
            ];
            adminComponents.forEach(id => { 
                const el = document.getElementById(id); 
                if (el) { 
                    if (enableDark) el.classList.add('dark'); 
                    else el.classList.remove('dark'); 
                } 
            });
        }
        window.addEventListener('DOMContentLoaded', applyAdminTheme);
    </script>

    <!-- FIREBASE (Adaptado para Canvas) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, setDoc, onSnapshot, deleteDoc, doc, query, orderBy, updateDoc, getDoc, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'evento_demo_01'; 
        
        let app, auth, db;
        try { 
            app = initializeApp(firebaseConfig); 
            auth = getAuth(app); 
            db = getFirestore(app); 
        } catch (e) { console.error("Error Firebase:", e); }

        window.db = db; window.collection = collection; window.addDoc = addDoc; window.setDoc = setDoc; window.updateDoc = updateDoc; window.getDoc = getDoc; window.onSnapshot = onSnapshot; window.deleteDoc = deleteDoc; window.doc = doc; window.appId = appId; window.auth = auth; window.query = query; window.orderBy = orderBy; window.limit = limit; window.signInAnonymously = signInAnonymously; window.isAuthReady = false;

        if(auth) { 
            const initAuth = async () => {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) { await signInWithCustomToken(auth, __initial_auth_token); } else { await signInAnonymously(auth); }
            };
            initAuth().catch(e => console.log("Auth Error:", e));
            onAuthStateChanged(auth, (user) => { if (user) { window.isAuthReady = true; if(!document.getElementById('adminPanel').classList.contains('translate-y-full')) { window.loadAdminData(); } } }); 
        }
    </script>

    <style>
        .logo-container { width: 100%; max-width: 150px; display: block; }
        @keyframes click-press { 0%, 100% { transform: scale(1) rotate(0deg); } 50% { transform: scale(0.92) rotate(-2deg); } }
        @keyframes confetti-pop { 0% { transform: scale(1); } 50% { transform: scale(1.35); } 100% { transform: scale(1); } }
        @keyframes dot-beat { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.4); fill: #2563eb; } }
        .cursor-icon, .spark-group, .dot-icon { transform-origin: center; transform-box: fill-box; transition: transform 0.5s ease; }
        .animating .cursor-icon { animation: click-press 0.6s ease-in-out forwards; }
        .animating .spark-group { animation: confetti-pop 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .animating .dot-icon { animation: dot-beat 0.6s ease-in-out forwards; }

        .admin-theme { font-family: 'Inter', sans-serif; }
        #adminPanel, #receptionView { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .admin-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .admin-scroll::-webkit-scrollbar-track { background: transparent; }
        .admin-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 10px; }
        @media (prefers-color-scheme: dark) { .admin-scroll::-webkit-scrollbar-thumb { background-color: #475569; } }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Mapa Carta Vertical y Objetos */
        .map-canvas { touch-action: none; overflow: hidden; position: relative;}
        /* El grid ahora se aplica a las ÁREAS (pisos), no al canvas global */
        .map-floor-area { 
            position: absolute;
            background-image: radial-gradient(#cbd5e1 1.5px, transparent 1.5px); 
            background-size: 30px 30px; 
            background-color: white; 
            border: 1px dashed #cbd5e1; /* Borde sutil para guiar */
        }
        .dark .map-floor-area { 
            background-image: radial-gradient(#334155 1.5px, transparent 1.5px); 
            background-color: #0f172a; 
            border-color: #334155;
        }
        
        #venueCanvas { transform-origin: top left; transition: transform 0.1s ease-out; /* Removed shadow from main canvas, applied to floors */ }
        
        /* Silla Tiffany - Updated Logic */
        .chair-tiffany { position: absolute; transition: all 0.3s ease; display: flex; flex-direction: column; align-items: center; justify-content: center; pointer-events: none; z-index: 25; }
        .chair-seat { width: 100%; height: 100%; border-radius: 2px; box-shadow: 0 1px 3px rgba(0,0,0,0.2); position: relative; z-index: 10; border: 1px solid rgba(0,0,0,0.2); }
        .chair-back { position: absolute; width: 110%; height: 30%; background: rgba(0,0,0,0.3); border-radius: 2px; z-index: 20; border: 1px solid rgba(0,0,0,0.1); bottom: 105%; /* Siempre "atrás" visualmente en la estructura, la rotación JS se encarga del resto */ }

        .draggable-table, .draggable-object, .draggable-floor { cursor: grab; position: absolute; touch-action: none; }
        .draggable-table:active, .draggable-object:active, .draggable-floor:active { cursor: grabbing; z-index: 1000 !important; }
        
        /* Manteles */
        .table-cloth-base { position: absolute; inset: 0; border-radius: inherit; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); transition: background-color 0.3s; z-index: 30; }
        .table-cloth-overlay { position: absolute; inset: 0; margin: auto; transition: all 0.3s; opacity: 0.9; box-shadow: 0 2px 4px rgba(0,0,0,0.1); z-index: 31;}
        
        /* Objetos de Salón */
        .venue-object { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; font-weight: bold; text-align: center; overflow: hidden; border: 1px solid rgba(0,0,0,0.1); box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 40; }
        .led-floor { background-image: linear-gradient(45deg, #ff0000 25%, #00ff00 25%, #00ff00 50%, #0000ff 50%, #0000ff 75%, #ffff00 75%, #ffff00 100%); background-size: 20px 20px; opacity: 0.8; }
        .pool-water { background-image: radial-gradient(circle, #0ea5e9 20%, #0284c7 80%); opacity: 0.9; }
        .grass-texture { background-color: #4ade80; background-image: radial-gradient(#22c55e 1px, transparent 1px); background-size: 10px 10px; }

        @media print {
            body > *:not(#printableArea) { display: none !important; }
            #printableArea { display: block !important; width: 100%; background: white !important; }
            @page { size: letter; margin: 0.5cm; }
        }
        
        .dropdown-content { display: none; position: absolute; right: 0; background-color: white; min-width: 160px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 50; border-radius: 0.5rem; overflow: hidden; }
        .dark .dropdown-content { background-color: #1e293b; border: 1px solid #334155; }
        .dropdown-content button { color: black; padding: 12px 16px; text-decoration: none; display: block; width: 100%; text-align: left; font-size: 0.8rem; }
        .dark .dropdown-content button { color: #e2e8f0; }
        .dropdown-content button:hover { background-color: #f1f5f9; }
        .dark .dropdown-content button:hover { background-color: #334155; }
        .show { display: block; }
        
        .status-card-confirmed { border-left: 4px solid #facc15; background: #fefce8; box-shadow: 0 4px 6px -1px rgba(250, 204, 21, 0.1); }
        .status-card-checkedin { border-left: 4px solid #4ade80; background: #f0fdf4; box-shadow: 0 4px 6px -1px rgba(74, 222, 128, 0.1); }
        .dark .status-card-confirmed { background: rgba(113, 63, 18, 0.2); border-left-color: #eab308; }
        .dark .status-card-checkedin { background: rgba(20, 83, 45, 0.2); border-left-color: #22c55e; }

        .ticket-cover-img { width: 100%; height: 160px; object-fit: cover; -webkit-mask-image: linear-gradient(to bottom, black 40%, transparent 100%); mask-image: linear-gradient(to bottom, black 40%, transparent 100%); position: absolute; top: 0; left: 0; z-index: 0; border-top-left-radius: 1rem; border-top-right-radius: 1rem; }
        .ticket-content { position: relative; z-index: 10; }
        
        .color-swatch { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 2px solid #e2e8f0; transition: transform 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .color-swatch:hover { transform: scale(1.2); z-index: 10; border-color: #94a3b8; }
        .dark .color-swatch { border-color: #475569; }
    </style>
</head>
<body class="bg-gray-100 text-slate-800">

    <div id="toastMsg" class="fixed top-5 left-1/2 -translate-x-1/2 z-[200] transform transition-all duration-300 -translate-y-32 opacity-0 bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl font-bold text-sm flex items-center gap-2 pointer-events-none">
        <span id="toastIcon"></span> <span id="toastText">Mensaje</span>
    </div>

    <!-- MAIN APP WRAPPER -->
    <main id="guestView" class="min-h-screen relative">
        <div class="flex flex-col items-center justify-center h-screen text-center p-6 bg-white">
            <div class="mb-6 opacity-50 grayscale hover:grayscale-0 transition duration-500 logo-container">
                 <svg viewBox="0 0 400 150" xmlns="http://www.w3.org/2000/svg"><g transform="translate(50, 20)"><path d="M10,10 L30,70 L45,45 L70,30 Z" fill="#2563eb" stroke="white" stroke-width="3" /><g transform="translate(10, 10)"><path d="M-3,-6 L-6,-12" stroke="#f59e0b" stroke-width="3" stroke-linecap="round" /><path d="M-6,-3 L-12,-6" stroke="#f59e0b" stroke-width="3" stroke-linecap="round" /><path d="M3,-6 L6,-12" stroke="#f59e0b" stroke-width="3" stroke-linecap="round" /><circle cx="-9" cy="-9" r="2" fill="#f59e0b" /></g></g><g transform="translate(130, 85)"><text font-family="sans-serif" font-weight="800" font-size="44" fill="#1e293b" letter-spacing="-1">fiesteala</text><circle cx="182" cy="-5" r="4.5" fill="#2563eb" /><text x="188" y="0" font-family="sans-serif" font-weight="400" font-size="24" fill="#2563eb">com</text></g></svg>
            </div>
            <h1 class="text-2xl font-bold text-slate-800 mb-2">Panel Inteligente Listo</h1>
            <p class="text-slate-500 max-w-md text-sm">Pega el código HTML de tu invitación dentro de la etiqueta <code class="bg-slate-100 px-2 py-1 rounded text-red-500 text-xs">&lt;main id="guestView"&gt;</code>.</p>
            <button onclick="window.openAdminLogin()" class="mt-8 px-6 py-3 bg-slate-800 text-white rounded-full text-xs font-bold uppercase tracking-widest hover:scale-105 active:scale-95 transition shadow-lg">Probar Panel</button>
        </div>
        <div class="absolute bottom-4 left-0 w-full text-center pointer-events-none z-50">
             <button onclick="window.openAdminLogin()" class="text-slate-300 hover:text-slate-500 text-[10px] font-bold uppercase tracking-widest transition pointer-events-auto p-2">Panel de Control</button>
        </div>
    </main>

    <div id="printableArea" class="hidden"></div>
    <div id="qrGenContainer" class="hidden"></div>

    <div id="sysModal" class="fixed inset-0 z-[150] hidden bg-black/70 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-slate-800 p-8 rounded-[2rem] w-full max-w-sm border border-slate-200 dark:border-slate-700 shadow-2xl animate__animated animate__zoomIn">
            <div id="sysModalIcon" class="text-center mb-4 text-5xl drop-shadow-md"></div>
            <h3 id="sysModalTitle" class="text-xl font-black text-slate-800 dark:text-white text-center mb-2 leading-tight"></h3>
            <p id="sysModalText" class="text-sm text-slate-500 dark:text-slate-400 text-center mb-8"></p>
            <div id="sysModalActions" class="flex flex-col sm:flex-row gap-3 justify-center"></div>
        </div>
    </div>

    <!-- LOGIN MODAL -->
    <div id="loginModal" class="fixed inset-0 z-[60] hidden bg-slate-900/95 flex items-center justify-center px-4 backdrop-blur-md">
        <div class="bg-white dark:bg-slate-800 p-8 rounded-3xl shadow-2xl max-w-sm w-full relative admin-theme overflow-hidden border border-slate-200 dark:border-slate-700 animate__animated animate__zoomIn">
             <div class="mb-6 flex justify-center scale-90">
                 <div class="logo-container svg-animate-target"><svg viewBox="0 0 400 150" xmlns="http://www.w3.org/2000/svg"><g transform="translate(50, 20)"><path class="cursor-icon" d="M10,10 L30,70 L45,45 L70,30 Z" fill="#2563eb" stroke="white" stroke-width="3" /><g class="spark-group" transform="translate(10, 10)"><path d="M-3,-6 L-6,-12" stroke="#f59e0b" stroke-width="3" stroke-linecap="round" /><path d="M-6,-3 L-12,-6" stroke="#f59e0b" stroke-width="3" stroke-linecap="round" /><path d="M3,-6 L6,-12" stroke="#f59e0b" stroke-width="3" stroke-linecap="round" /><circle cx="-9" cy="-9" r="2" fill="#f59e0b" /></g></g><g transform="translate(130, 85)"><text font-family="sans-serif" font-weight="800" font-size="44" class="fill-slate-800 dark:fill-white" letter-spacing="-1">fiesteala</text><circle class="dot-icon" cx="182" cy="-5" r="4.5" fill="#2563eb" /><text x="188" y="0" font-family="sans-serif" font-weight="400" font-size="24" fill="#2563eb">com</text></g></svg></div>
             </div>
            <p class="text-sm text-slate-500 dark:text-slate-400 mb-6 text-center font-medium">Panel de Control Inteligente</p>
            <input type="password" id="adminPassword" placeholder="PIN (1234)" class="w-full border border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 p-4 rounded-xl mb-4 text-center text-lg tracking-widest outline-none focus:border-blue-500 dark:focus:border-blue-400 transition text-slate-800 dark:text-white">
            <button onclick="checkLogin()" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold hover:bg-blue-700 active:scale-95 transition shadow-lg shadow-blue-500/30">Acceder</button>
            <button onclick="document.getElementById('loginModal').classList.add('hidden')" class="w-full mt-4 text-slate-400 dark:text-slate-500 text-xs hover:text-slate-600 dark:hover:text-slate-300 font-semibold p-2">Cancelar</button>
        </div>
    </div>

    <!-- PANEL UI -->
    <div id="adminPanel" class="fixed inset-0 z-50 bg-[#f8fafc] dark:bg-slate-950 overflow-y-auto transform translate-y-full admin-theme h-screen flex flex-col transition-colors duration-300">
        <div class="bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 px-4 py-3 shrink-0 sticky top-0 z-20 shadow-sm">
            <div class="relative flex items-center justify-center sm:justify-between h-14 sm:h-auto">
                <div class="flex flex-col sm:flex-row items-center gap-1 sm:gap-4">
                    <div class="w-36 h-10 relative flex items-center justify-center">
                         <div class="logo-container svg-animate-target w-full h-full">
                            <svg viewBox="0 0 400 150" xmlns="http://www.w3.org/2000/svg"><g transform="translate(50, 20)"><path class="cursor-icon" d="M10,10 L30,70 L45,45 L70,30 Z" fill="#2563eb" stroke="white" stroke-width="3" /><g class="spark-group" transform="translate(10, 10)"><path d="M-3,-6 L-6,-12" stroke="#f59e0b" stroke-width="3" stroke-linecap="round" /><path d="M-6,-3 L-12,-6" stroke="#f59e0b" stroke-width="3" stroke-linecap="round" /><path d="M3,-6 L6,-12" stroke="#f59e0b" stroke-width="3" stroke-linecap="round" /><circle cx="-9" cy="-9" r="2" fill="#f59e0b" /></g></g><g transform="translate(130, 85)"><text font-family="sans-serif" font-weight="800" font-size="44" class="fill-slate-800 dark:fill-white" letter-spacing="-1">fiesteala</text><circle class="dot-icon" cx="182" cy="-5" r="4.5" fill="#2563eb" /><text x="188" y="0" font-family="sans-serif" font-weight="400" font-size="24" fill="#2563eb">com</text></g></svg>
                         </div>
                    </div>
                    <span class="text-[10px] sm:text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest text-center sm:text-left leading-none">Panel de Control<br class="sm:hidden"> Inteligente</span>
                </div>
                <button onclick="closeAdmin()" class="absolute right-0 top-1/2 -translate-y-1/2 sm:static sm:translate-y-0 w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-500 dark:text-slate-400 hover:text-slate-800 dark:hover:text-white flex items-center justify-center transition shadow-sm active:scale-95"><i class="fas fa-times"></i></button>
            </div>
        </div>
        
        <!-- MAIN TABS -->
        <div class="flex-1 flex overflow-hidden">
            <div class="flex-1 flex flex-col min-w-0 bg-[#f8fafc] dark:bg-slate-950 transition-colors duration-300">
                <div class="border-b border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 overflow-x-auto hide-scrollbar touch-pan-x">
                    <div class="flex px-4 sm:px-6 min-w-max">
                        <button onclick="switchTab('guests')" id="tab-guests" class="py-4 px-4 sm:px-6 border-b-2 border-blue-600 text-blue-600 dark:text-blue-400 font-bold text-base sm:text-sm transition flex items-center justify-center gap-2 active:bg-slate-50 dark:active:bg-slate-800"><i class="fas fa-users text-lg sm:text-base"></i> <span class="hidden sm:inline whitespace-nowrap">Invitados</span></button>
                        <button onclick="switchTab('tables')" id="tab-tables" class="py-4 px-4 sm:px-6 border-b-2 border-transparent text-slate-500 dark:text-slate-400 font-medium text-base sm:text-sm transition flex items-center justify-center gap-2 active:bg-slate-50 dark:active:bg-slate-800"><i class="fas fa-list text-lg sm:text-base"></i> <span class="hidden sm:inline whitespace-nowrap">Mesas</span></button>
                        <button onclick="switchTab('map')" id="tab-map" class="py-4 px-4 sm:px-6 border-b-2 border-transparent text-slate-500 dark:text-slate-400 font-medium text-base sm:text-sm transition flex items-center justify-center gap-2 active:bg-slate-50 dark:active:bg-slate-800"><i class="fas fa-chair text-lg sm:text-base"></i> <span class="hidden sm:inline whitespace-nowrap">Mi Salón</span></button>
                        <button onclick="switchTab('planner')" id="tab-planner" class="py-4 px-4 sm:px-6 border-b-2 border-transparent text-slate-500 dark:text-slate-400 font-medium text-base sm:text-sm transition flex items-center justify-center gap-2 active:bg-slate-50 dark:active:bg-slate-800"><i class="fas fa-qrcode text-lg sm:text-base"></i> <span class="hidden sm:inline whitespace-nowrap">Scanner</span></button>
                    </div>
                </div>
                
                <div class="flex-1 overflow-y-auto p-3 md:p-6 admin-scroll text-slate-800 dark:text-slate-200 h-full relative" id="tabContentArea">
                    
                    <!-- VIEW: GUESTS -->
                    <div id="view-guests" class="space-y-4 md:space-y-6 pb-20">
                        <!-- STATS ROW -->
                        <div class="grid grid-cols-3 gap-2 sm:gap-4 mb-2">
                            <div class="bg-white dark:bg-slate-900 p-3 sm:p-4 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-800 text-center">
                                <span class="block text-[10px] text-slate-400 uppercase font-bold tracking-wider">Total</span>
                                <span class="block text-xl sm:text-2xl font-black text-slate-800 dark:text-white" id="dashTotalGuests">0</span>
                            </div>
                            <div class="bg-white dark:bg-slate-900 p-3 sm:p-4 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-800 text-center relative overflow-hidden">
                                <div class="absolute top-0 left-0 w-1 h-full bg-yellow-400"></div>
                                <span class="block text-[10px] text-slate-400 uppercase font-bold tracking-wider">Confirmados</span>
                                <span class="block text-xl sm:text-2xl font-black text-yellow-600 dark:text-yellow-400" id="dashConfirmed">0</span>
                            </div>
                            <div class="bg-white dark:bg-slate-900 p-3 sm:p-4 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-800 text-center relative overflow-hidden">
                                <div class="absolute top-0 left-0 w-1 h-full bg-green-500"></div>
                                <span class="block text-[10px] text-slate-400 uppercase font-bold tracking-wider">Ingresados</span>
                                <span class="block text-xl sm:text-2xl font-black text-green-600 dark:text-green-400" id="dashCheckedIn">0</span>
                            </div>
                        </div>

                        <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-800" style="overflow: visible;">
                            <div class="px-4 py-4 border-b border-slate-100 dark:border-slate-800 bg-slate-50/50 dark:bg-slate-800/50">
                                <h3 class="font-bold text-slate-700 dark:text-slate-300 text-xs uppercase tracking-wide mb-3">Gestión de Invitados</h3>
                                <div class="flex flex-wrap items-center gap-2 w-full mb-2">
                                    <button onclick="openAddGuestModal()" class="flex-1 md:flex-none flex items-center justify-center gap-2 text-blue-600 hover:text-blue-800 text-[11px] font-bold uppercase border border-blue-200 px-3 py-2.5 rounded-xl bg-blue-50 dark:bg-blue-900/20 dark:border-blue-800 dark:text-blue-300 active:scale-95 transition whitespace-nowrap"><i class="fas fa-plus"></i> <span class="hidden sm:inline">Nuevo</span></button>
                                    <button onclick="generateWristbands()" class="flex-1 md:flex-none flex items-center justify-center gap-2 text-purple-600 hover:text-purple-800 text-[11px] font-bold uppercase border border-purple-200 px-3 py-2.5 rounded-xl bg-purple-50 dark:bg-purple-900/20 dark:border-purple-800 dark:text-purple-300 active:scale-95 transition whitespace-nowrap"><i class="fas fa-print"></i> <span class="hidden sm:inline">Pulseras</span></button>
                                    <div class="relative flex-1 md:flex-none z-50">
                                        <button onclick="document.getElementById('exportDropdown').classList.toggle('show')" class="w-full flex items-center justify-center gap-2 text-slate-600 dark:text-slate-300 hover:text-blue-600 text-[11px] font-bold uppercase border border-slate-200 dark:border-slate-600 px-3 py-2.5 rounded-xl bg-white dark:bg-slate-800 active:scale-95 transition whitespace-nowrap"><i class="fas fa-file-export"></i> <span class="hidden sm:inline">Exportar</span></button>
                                        <div id="exportDropdown" class="dropdown-content mt-1">
                                            <button onclick="exportData('xlsx')"><i class="fas fa-file-excel text-green-600 mr-2"></i> Excel</button>
                                            <button onclick="exportData('pdf')"><i class="fas fa-file-pdf text-red-600 mr-2"></i> PDF</button>
                                        </div>
                                    </div>
                                    <button onclick="openConfigModal()" class="flex-1 md:flex-none flex items-center justify-center gap-2 text-slate-600 dark:text-slate-300 hover:text-slate-800 text-[11px] font-bold uppercase border border-slate-200 dark:border-slate-700 px-3 py-2.5 rounded-xl bg-white dark:bg-slate-800 active:scale-95 transition whitespace-nowrap"><i class="fas fa-image"></i> <span class="hidden sm:inline">Miniatura</span></button>
                                    <div class="hidden md:flex flex-1 items-center gap-2 min-w-[200px]">
                                        <div class="relative flex-1">
                                            <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
                                            <input type="text" id="searchGuestInput" oninput="document.getElementById('searchGuestInputMob').value=this.value; renderGuestList()" placeholder="Buscar invitado..." class="w-full bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl pl-9 pr-3 py-2 text-xs outline-none focus:border-blue-500 text-slate-800 dark:text-white transition shadow-sm h-[36px]">
                                        </div>
                                        <select id="sortGuestSelect" onchange="document.getElementById('sortGuestSelectMob').value=this.value; renderGuestList()" class="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl px-3 py-2 text-xs outline-none focus:border-blue-500 text-slate-800 dark:text-white font-bold shadow-sm cursor-pointer h-[36px]">
                                            <option value="newest">Recientes</option>
                                            <option value="name">Nombre</option>
                                            <option value="table">Mesa</option>
                                            <option value="confirmed">Confirmados</option>
                                        </select>
                                    </div>
                                    <button onclick="document.getElementById('mobileSearchTools').classList.toggle('hidden')" class="md:hidden flex-none w-[36px] h-[36px] flex items-center justify-center gap-1 text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-700 rounded-xl bg-white dark:bg-slate-800 active:scale-95 transition"><i class="fas fa-search"></i></button>
                                </div>
                                <div id="mobileSearchTools" class="hidden md:hidden flex flex-col gap-2 mt-3 p-3 bg-slate-100 dark:bg-slate-800/50 rounded-xl border border-slate-200 dark:border-slate-700">
                                     <div class="relative w-full"><i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i><input type="text" id="searchGuestInputMob" oninput="document.getElementById('searchGuestInput').value=this.value; renderGuestList()" placeholder="Buscar por nombre..." class="w-full bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-600 rounded-lg pl-9 pr-4 py-2.5 text-sm outline-none focus:border-blue-500 text-slate-800 dark:text-white shadow-sm"></div>
                                </div>
                            </div>
                            <div class="w-full overflow-x-auto"><div id="guestTableBody" class="flex flex-col w-full divide-y divide-slate-100 dark:divide-slate-800/50 min-w-[300px] md:min-w-[600px]"></div></div>
                        </div>
                    </div>
                    
                    <!-- VIEW: TABLES (LISTA) -->
                    <div id="view-tables" class="hidden space-y-6 pb-20">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center bg-white dark:bg-slate-900 p-4 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-800 gap-4">
                            <div class="w-full md:w-auto text-center md:text-left">
                                <h3 class="font-bold text-slate-700 dark:text-slate-300">Gestión de Mesas y Acomodo</h3>
                                <p class="text-xs text-slate-400" id="tableStatsText">Calculando...</p>
                            </div>
                            <div class="flex flex-wrap gap-2 w-full md:w-auto">
                                <button onclick="openTableConfigModal()" class="flex-1 md:flex-none bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700 border border-slate-200 dark:border-slate-700 px-4 py-2.5 rounded-xl text-xs font-bold transition active:scale-95 flex items-center justify-center gap-1.5"><i class="fas fa-cog"></i> Configurar</button>
                                <button onclick="emptyAllTables()" class="flex-1 md:flex-none bg-orange-50 dark:bg-orange-900/20 text-orange-600 dark:text-orange-400 hover:bg-orange-100 border border-orange-200 dark:border-orange-800 px-4 py-2.5 rounded-xl text-xs font-bold transition active:scale-95 flex items-center justify-center gap-1.5"><i class="fas fa-user-slash"></i> Vaciar</button>
                                <button onclick="deleteAllTables()" class="flex-1 md:flex-none bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 hover:bg-red-100 border border-red-200 dark:border-red-800 px-4 py-2.5 rounded-xl text-xs font-bold transition active:scale-95 flex items-center justify-center gap-1.5"><i class="fas fa-trash-alt"></i> Eliminar Todo</button>
                                <button onclick="autoAssignAll()" class="w-full md:w-auto bg-purple-600 text-white hover:bg-purple-700 px-4 py-2.5 rounded-xl text-xs font-bold shadow-md transition active:scale-95 flex items-center justify-center gap-1.5"><i class="fas fa-magic"></i> Auto-Acomodo</button>
                            </div>
                        </div>
                        <div id="tablesGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                    </div>

                    <!-- VIEW: MAPA INTERACTIVO (MEJORADO) -->
                    <div id="view-map" class="hidden h-full flex-col min-h-[500px] pb-10">
                        <div class="bg-white dark:bg-slate-900 p-3 sm:p-4 rounded-t-2xl shadow-sm border border-slate-200 dark:border-slate-800 flex flex-col sm:flex-row justify-between items-center z-10 relative gap-3">
                            <h3 class="font-bold text-slate-700 dark:text-slate-300 text-sm w-full sm:w-auto text-center sm:text-left"><i class="fas fa-chair mr-2 text-blue-500"></i> Plano Real</h3>
                            <div class="flex flex-wrap gap-2 w-full sm:w-auto pb-2 sm:pb-0">
                                <button onclick="openReconfigureModal()" class="whitespace-nowrap flex-none bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 hover:bg-slate-200 px-4 py-2.5 rounded-xl text-xs font-bold transition active:scale-95 flex items-center gap-2"><i class="fas fa-ruler-combined"></i> Medidas</button>
                                <div class="relative">
                                    <button onclick="document.getElementById('addObjDropdown').classList.toggle('show')" class="whitespace-nowrap flex-none bg-indigo-100 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-300 hover:bg-indigo-200 px-4 py-2.5 rounded-xl text-xs font-bold transition active:scale-95 flex items-center gap-2"><i class="fas fa-cubes"></i> Objetos</button>
                                    <div id="addObjDropdown" class="dropdown-content mt-1 w-48 max-h-60 overflow-y-auto">
                                        <button onclick="openEditObjectModal('new', 'pista')"><i class="fas fa-chess-board text-purple-500 mr-2"></i> Pista Baile</button>
                                        <button onclick="openEditObjectModal('new', 'escenario')"><i class="fas fa-microphone-alt text-blue-500 mr-2"></i> Escenario/Tarima</button>
                                        <button onclick="openEditObjectModal('new', 'dj')"><i class="fas fa-music text-pink-500 mr-2"></i> DJ / Audio</button>
                                        <button onclick="openEditObjectModal('new', 'barra')"><i class="fas fa-cocktail text-orange-500 mr-2"></i> Barra / Snacks</button>
                                        <button onclick="openEditObjectModal('new', 'mesa_honor')"><i class="fas fa-star text-yellow-500 mr-2"></i> Mesa Honor</button>
                                        <button onclick="openEditObjectModal('new', 'entrada')"><i class="fas fa-door-open text-green-500 mr-2"></i> Entrada</button>
                                        <button onclick="openEditObjectModal('new', 'bano')"><i class="fas fa-restroom text-cyan-500 mr-2"></i> Baños</button>
                                        <!-- NUEVOS OBJETOS -->
                                        <button onclick="openEditObjectModal('new', 'deco')"><i class="fas fa-camera-retro text-rose-500 mr-2"></i> Decoración/Fotos</button>
                                        <button onclick="openEditObjectModal('new', 'brincolin')"><i class="fas fa-child text-orange-400 mr-2"></i> Brincolín</button>
                                        <button onclick="openEditObjectModal('new', 'alberca')"><i class="fas fa-water text-blue-400 mr-2"></i> Alberca</button>
                                        <button onclick="openEditObjectModal('new', 'jardin')"><i class="fas fa-tree text-green-600 mr-2"></i> Jardín</button>
                                        <button onclick="openEditObjectModal('new', 'pinata')"><i class="fas fa-star text-yellow-500 mr-2"></i> Piñata</button>
                                        <button onclick="openEditObjectModal('new', 'animacion')"><i class="fas fa-theater-masks text-purple-500 mr-2"></i> Animación</button>
                                        <button onclick="openEditObjectModal('new', 'custom')"><i class="fas fa-square text-gray-500 mr-2"></i> Otro Elemento</button>
                                    </div>
                                </div>
                                <button onclick="openEditTableModal('new')" class="whitespace-nowrap flex-none bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 hover:bg-blue-200 px-4 py-2.5 rounded-xl text-xs font-bold transition active:scale-95 flex items-center gap-2"><i class="fas fa-plus"></i> Mesa</button>
                                <button onclick="exportMapPdf()" class="whitespace-nowrap flex-none bg-slate-800 dark:bg-slate-700 text-white hover:bg-slate-900 px-4 py-2.5 rounded-xl text-xs font-bold transition shadow-lg active:scale-95 flex items-center gap-2"><i class="fas fa-file-pdf"></i> PDF</button>
                            </div>
                        </div>
                        <div class="flex-1 border border-t-0 border-slate-200 dark:border-slate-800 rounded-b-2xl relative bg-slate-200 dark:bg-slate-950 map-canvas shadow-inner overflow-auto" id="mapScrollArea">
                            <!-- Controles Zoom -->
                            <div class="absolute bottom-4 right-4 z-20 flex flex-col gap-2">
                                <button onclick="zoomMap(0.1)" class="bg-white dark:bg-slate-800 text-slate-800 dark:text-white w-10 h-10 rounded-full shadow-lg font-bold border border-slate-200 dark:border-slate-700 active:scale-95 flex items-center justify-center"><i class="fas fa-search-plus"></i></button>
                                <button onclick="zoomMap(-0.1)" class="bg-white dark:bg-slate-800 text-slate-800 dark:text-white w-10 h-10 rounded-full shadow-lg font-bold border border-slate-200 dark:border-slate-700 active:scale-95 flex items-center justify-center"><i class="fas fa-search-minus"></i></button>
                            </div>
                            <!-- LIENZO -->
                            <div id="venueCanvas" class="relative bg-transparent mx-auto mt-4" style="width: 2000px; height: 2000px;">
                                <!-- Los pisos y objetos se renderizan aquí -->
                            </div>
                        </div>
                        <p class="text-[10px] sm:text-xs text-slate-400 mt-3 text-center px-4"><i class="fas fa-hand-pointer mr-1"></i> Arrastra para mover. Doble clic para editar. Todo a escala real.</p>
                    </div>
                    
                    <!-- VIEW: PLANNER -->
                    <div id="view-planner" class="hidden space-y-6 pb-20">
                         <div class="bg-white dark:bg-slate-900 p-8 rounded-3xl shadow-sm border border-slate-200 dark:border-slate-800 text-center max-w-sm mx-auto mt-6 sm:mt-10">
                            <div class="w-20 h-20 bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded-full flex items-center justify-center mx-auto mb-6 text-3xl"><i class="fas fa-qrcode"></i></div>
                            <h3 class="text-xl font-bold mb-2 text-slate-800 dark:text-white">Scanner de Acceso</h3>
                            <button onclick="openReceptionView()" class="w-full bg-slate-800 dark:bg-blue-600 text-white py-4 rounded-xl font-bold hover:bg-slate-900 transition shadow-xl active:scale-95 flex justify-center items-center gap-2"><i class="fas fa-camera"></i> Abrir Cámara del Scanner</button>
                            <div class="mt-10 pt-6 border-t border-slate-100 dark:border-slate-800 flex items-center gap-1 bg-slate-50 dark:bg-slate-800 p-1.5 rounded-xl border border-slate-200 dark:border-slate-700">
                                <input type="text" id="plannerLinkInput" class="w-full bg-transparent text-xs outline-none px-3 text-slate-600 dark:text-slate-400" readonly>
                                <button onclick="copyPlannerLink()" class="bg-white dark:bg-slate-700 text-blue-600 dark:text-blue-400 px-4 py-2 rounded-lg shadow-sm font-bold text-[10px] border border-slate-200 dark:border-slate-600 active:scale-95 transition">COPIAR</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- INITIAL SETUP / VENUE AREAS CONFIG MODAL (MODIFICADO) -->
    <div id="initialSetupModal" class="fixed inset-0 z-[100] hidden bg-slate-900/95 flex items-center justify-center p-4 backdrop-blur-md">
        <div class="bg-white dark:bg-slate-800 p-6 sm:p-8 rounded-3xl shadow-2xl max-w-md w-full relative admin-theme border border-slate-200 dark:border-slate-700 animate__animated animate__zoomIn max-h-[90vh] overflow-y-auto">
            <button onclick="document.getElementById('initialSetupModal').classList.add('hidden')" class="absolute top-4 right-4 bg-slate-100 dark:bg-slate-800 p-2 rounded-full text-slate-400 hover:text-slate-600 active:scale-95"><i class="fas fa-times w-5 h-5 flex justify-center items-center"></i></button>
            <div class="text-center mb-6 mt-4">
                <div class="w-16 h-16 bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl"><i class="fas fa-layer-group"></i></div>
                <h2 id="initSetupTitle" class="text-2xl font-bold text-slate-800 dark:text-white mb-2">Áreas del Evento</h2>
                <p id="initSetupDesc" class="text-sm text-slate-500 dark:text-slate-400">Edita las medidas o agrega nuevas secciones.</p>
            </div>
            
            <div id="venueAreasList" class="space-y-3 mb-4 max-h-60 overflow-y-auto admin-scroll">
                <!-- Lista de áreas generada por JS -->
            </div>

            <div class="bg-slate-50 dark:bg-slate-900 p-4 rounded-2xl border border-slate-200 dark:border-slate-700">
                <p class="text-[10px] font-bold text-slate-400 uppercase mb-2">Nueva Área</p>
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div>
                        <label class="block text-[10px] font-bold text-slate-500 dark:text-slate-400 mb-1 uppercase text-center">Ancho (m)</label>
                        <input type="number" id="newAreaW" value="10" min="1" max="100" class="w-full p-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg outline-none text-slate-800 dark:text-white font-bold text-center">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-500 dark:text-slate-400 mb-1 uppercase text-center">Largo (m)</label>
                        <input type="number" id="newAreaL" value="10" min="1" max="100" class="w-full p-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg outline-none text-slate-800 dark:text-white font-bold text-center">
                    </div>
                </div>
                <button type="button" onclick="addNewVenueArea()" class="w-full bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 hover:bg-blue-200 font-bold py-2 rounded-xl transition text-xs border border-blue-200 dark:border-blue-800"><i class="fas fa-plus"></i> Agregar Área</button>
            </div>

            <button onclick="document.getElementById('initialSetupModal').classList.add('hidden')" class="w-full bg-slate-800 text-white font-bold py-4 rounded-xl shadow-lg transition mt-4 active:scale-95">Listo, volver al mapa</button>
        </div>
    </div>

    <!-- TABLE GENERATION CONFIG MODAL (RESTAURADO) -->
    <div id="tableConfigModal" class="fixed inset-0 z-[100] hidden bg-slate-900/95 flex items-center justify-center p-4 backdrop-blur-md">
        <div class="bg-white dark:bg-slate-800 p-6 sm:p-8 rounded-3xl shadow-2xl max-w-md w-full relative admin-theme border border-slate-200 dark:border-slate-700 animate__animated animate__zoomIn max-h-[90vh] overflow-y-auto">
            <button onclick="document.getElementById('tableConfigModal').classList.add('hidden')" class="absolute top-4 right-4 bg-slate-100 dark:bg-slate-800 p-2 rounded-full text-slate-400 hover:text-slate-600 active:scale-95"><i class="fas fa-times w-5 h-5 flex justify-center items-center"></i></button>
            <div class="text-center mb-6 mt-4">
                <div class="w-16 h-16 bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl"><i class="fas fa-cog"></i></div>
                <h2 class="text-2xl font-bold text-slate-800 dark:text-white mb-2">Generar Mesas</h2>
                <p class="text-sm text-slate-500 dark:text-slate-400">Configura y crea mesas automáticamente.</p>
            </div>
            
            <form id="tableGenerationForm" class="space-y-4">
                <!-- SINGLE TABLE COUNT -->
                <div id="singleConfigContainer">
                    <div>
                        <label class="block text-[10px] font-bold text-slate-500 dark:text-slate-400 mb-1 uppercase">Cantidad de Mesas</label>
                        <input type="number" id="initTableCount" value="10" min="1" max="100" class="w-full p-3 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl outline-none text-slate-800 dark:text-white font-bold text-center">
                    </div>
                </div>

                <!-- VARIETY TOGGLE -->
                <div class="flex items-center justify-between bg-blue-50 dark:bg-blue-900/10 p-3 rounded-xl border border-blue-100 dark:border-blue-900/30">
                    <span class="text-xs font-bold text-blue-700 dark:text-blue-300 flex items-center gap-2"><i class="fas fa-layer-group"></i> Variedad (Mezcla de mesas)</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="varietyToggle" class="sr-only peer" onchange="toggleVariety()">
                        <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer dark:bg-slate-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>

                <!-- SINGLE CONFIG SECTION -->
                <div id="singleTypeConfig" class="bg-slate-50 dark:bg-slate-900 p-4 rounded-2xl border border-slate-200 dark:border-slate-700 space-y-3">
                    <div>
                        <label class="block text-[10px] font-bold text-slate-500 dark:text-slate-400 mb-1 uppercase">Tipo de Mesa</label>
                        <select id="initTableShape" onchange="updateInitInputs()" class="w-full p-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-xl outline-none text-slate-800 dark:text-white font-bold text-sm">
                            <option value="round">Redonda (1.5m Diám)</option>
                            <option value="square">Cuadrada (1.5m x 1.5m)</option>
                            <option value="rect">Rectangular (2.44m x 0.75m)</option>
                            <option value="custom">Personalizada (Sin límites)</option>
                        </select>
                    </div>

                    <div id="initRoundConfig">
                        <label class="block text-[10px] font-bold text-slate-500 dark:text-slate-400 mb-1 uppercase">Sillas por Mesa</label>
                        <input type="number" id="initTableCap" value="10" min="1" max="10" class="w-full p-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-xl outline-none text-slate-800 dark:text-white font-bold text-center">
                    </div>

                    <div id="initRectConfig" class="hidden grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-[10px] font-bold text-slate-500 dark:text-slate-400 mb-1 uppercase text-center">Largo (Lados)</label>
                            <input type="number" id="initTableX" value="3" min="1" class="w-full p-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-xl outline-none text-slate-800 dark:text-white font-bold text-center">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-slate-500 dark:text-slate-400 mb-1 uppercase text-center">Ancho (Cabecera)</label>
                            <input type="number" id="initTableY" value="1" min="1" class="w-full p-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-xl outline-none text-slate-800 dark:text-white font-bold text-center">
                        </div>
                    </div>

                    <div id="initCustomConfig" class="hidden grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-[10px] font-bold text-slate-500 dark:text-slate-400 mb-1 uppercase text-center">Largo (Lados)</label>
                            <input type="number" id="initCustomX" value="3" min="1" class="w-full p-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-xl outline-none text-slate-800 dark:text-white font-bold text-center">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-slate-500 dark:text-slate-400 mb-1 uppercase text-center">Ancho (Cabecera)</label>
                            <input type="number" id="initCustomY" value="1" min="1" class="w-full p-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-xl outline-none text-slate-800 dark:text-white font-bold text-center">
                        </div>
                    </div>
                </div>

                <!-- MIXED CONFIG -->
                <div id="initMixedConfig" class="hidden space-y-4">
                    <!-- Redondas -->
                    <div class="bg-slate-50 dark:bg-slate-900 p-3 rounded-xl border border-slate-200 dark:border-slate-700">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs font-bold text-slate-700 dark:text-slate-300">Redondas (1.5m)</span>
                            <input type="number" id="mixRoundCount" placeholder="Cant." class="w-16 p-1 text-center rounded border border-slate-300 dark:border-slate-600 dark:bg-slate-800 text-sm font-bold text-slate-800 dark:text-white outline-none focus:border-blue-500">
                        </div>
                        <div class="flex items-center gap-2">
                            <label class="text-[10px] text-slate-500 uppercase">Sillas (Max 10):</label>
                            <input type="number" id="mixRoundCap" value="10" max="10" class="w-full p-1 text-center rounded border border-slate-300 dark:border-slate-600 dark:bg-slate-800 text-sm text-slate-800 dark:text-white outline-none">
                        </div>
                    </div>
                    <!-- Cuadradas -->
                    <div class="bg-slate-50 dark:bg-slate-900 p-3 rounded-xl border border-slate-200 dark:border-slate-700">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs font-bold text-slate-700 dark:text-slate-300">Cuadradas (1.5x1.5m)</span>
                            <input type="number" id="mixSquareCount" placeholder="Cant." class="w-16 p-1 text-center rounded border border-slate-300 dark:border-slate-600 dark:bg-slate-800 text-sm font-bold text-slate-800 dark:text-white outline-none focus:border-blue-500">
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-[10px] text-slate-500 uppercase text-center">Largo</label>
                                <input type="number" id="mixSquareX" value="3" max="3" class="w-full p-1 text-center rounded border border-slate-300 dark:border-slate-600 dark:bg-slate-800 text-sm text-slate-800 dark:text-white outline-none">
                            </div>
                            <div>
                                <label class="block text-[10px] text-slate-500 uppercase text-center">Ancho</label>
                                <input type="number" id="mixSquareY" value="3" max="3" class="w-full p-1 text-center rounded border border-slate-300 dark:border-slate-600 dark:bg-slate-800 text-sm text-slate-800 dark:text-white outline-none">
                            </div>
                        </div>
                    </div>
                    <!-- Rectangulares -->
                    <div class="bg-slate-50 dark:bg-slate-900 p-3 rounded-xl border border-slate-200 dark:border-slate-700">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs font-bold text-slate-700 dark:text-slate-300">Rectangulares (2.44x0.75m)</span>
                            <input type="number" id="mixRectCount" placeholder="Cant." class="w-16 p-1 text-center rounded border border-slate-300 dark:border-slate-600 dark:bg-slate-800 text-sm font-bold text-slate-800 dark:text-white outline-none focus:border-blue-500">
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-[10px] text-slate-500 uppercase text-center">Largo (Max 5)</label>
                                <input type="number" id="mixRectX" value="3" max="5" class="w-full p-1 text-center rounded border border-slate-300 dark:border-slate-600 dark:bg-slate-800 text-sm text-slate-800 dark:text-white outline-none">
                            </div>
                            <div>
                                <label class="block text-[10px] text-slate-500 uppercase text-center">Ancho (Max 1)</label>
                                <input type="number" id="mixRectY" value="1" max="1" class="w-full p-1 text-center rounded border border-slate-300 dark:border-slate-600 dark:bg-slate-800 text-sm text-slate-800 dark:text-white outline-none">
                            </div>
                        </div>
                    </div>
                    <!-- Personalizadas -->
                    <div class="bg-slate-50 dark:bg-slate-900 p-3 rounded-xl border border-slate-200 dark:border-slate-700">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs font-bold text-slate-700 dark:text-slate-300">Personalizadas</span>
                            <input type="number" id="mixCustomCount" placeholder="Cant." class="w-16 p-1 text-center rounded border border-slate-300 dark:border-slate-600 dark:bg-slate-800 text-sm font-bold text-slate-800 dark:text-white outline-none focus:border-blue-500">
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-[10px] text-slate-500 uppercase text-center">Largo (m)</label>
                                <input type="number" id="mixCustomL" step="0.1" value="2.0" class="w-full p-1 text-center rounded border border-slate-300 dark:border-slate-600 dark:bg-slate-800 text-sm text-slate-800 dark:text-white outline-none">
                            </div>
                            <div>
                                <label class="block text-[10px] text-slate-500 uppercase text-center">Ancho (m)</label>
                                <input type="number" id="mixCustomW" step="0.1" value="1.0" class="w-full p-1 text-center rounded border border-slate-300 dark:border-slate-600 dark:bg-slate-800 text-sm text-slate-800 dark:text-white outline-none">
                            </div>
                        </div>
                    </div>
                </div>

                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg transition mt-6 active:scale-95">Generar Configuración</button>
            </form>
        </div>
    </div>

    <!-- EDIT TABLE MODAL (MEJORADO CON MANTELES Y SILLAS) -->
    <div id="editTableModal" class="fixed inset-0 z-[90] hidden bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-slate-900 p-6 rounded-3xl w-full max-w-sm border border-slate-200 dark:border-slate-700 shadow-2xl animate__animated animate__fadeInUp max-h-[90vh] overflow-y-auto admin-scroll">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-slate-800 dark:text-white" id="editTableTitle">Configurar Mesa</h3>
                <button type="button" onclick="document.getElementById('editTableModal').classList.add('hidden')" class="bg-slate-100 dark:bg-slate-800 p-2 rounded-full text-slate-400 hover:text-slate-600 active:scale-95"><i class="fas fa-times w-5 h-5 flex justify-center items-center"></i></button>
            </div>
            <form id="editTableForm" class="space-y-4">
                <input type="hidden" id="editTableId">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[10px] font-bold text-slate-500 dark:text-slate-400 mb-2 uppercase">Nombre/No.</label>
                        <input type="text" id="editTableLabel" class="w-full p-3 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl outline-none text-sm text-center text-slate-800 dark:text-white font-bold" required>
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-500 dark:text-slate-400 mb-2 uppercase">Forma</label>
                        <select id="editTableShape" onchange="updateEditInputs()" class="w-full p-3 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl outline-none text-sm text-slate-800 dark:text-white font-bold">
                            <option value="round">Redonda (1.5m Diám)</option>
                            <option value="square">Cuadrada (1.5x1.5m)</option>
                            <option value="rect">Rectangular (2.44x0.75m)</option>
                            <option value="custom">Personalizada (Libre)</option>
                        </select>
                    </div>
                </div>

                <div id="editCustomDims" class="hidden grid grid-cols-2 gap-4 bg-slate-50 dark:bg-slate-800 p-3 rounded-xl border border-slate-100 dark:border-slate-700">
                    <div>
                        <label class="block text-[10px] font-bold text-slate-500 dark:text-slate-400 mb-1 text-center uppercase">Largo (m)</label>
                        <input type="number" id="editDimLargo" step="0.1" value="2.0" class="w-full p-2 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-600 rounded-lg outline-none text-center text-slate-800 dark:text-white font-bold">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-500 dark:text-slate-400 mb-1 text-center uppercase">Ancho (m)</label>
                        <input type="number" id="editDimAncho" step="0.1" value="1.0" class="w-full p-2 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-600 rounded-lg outline-none text-center text-slate-800 dark:text-white font-bold">
                    </div>
                </div>

                <div id="editRoundGroup" class="block bg-slate-50 dark:bg-slate-800 p-3 rounded-xl border border-slate-100 dark:border-slate-700">
                    <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-2 text-center">Sillas (Max 10)</label>
                    <input type="number" id="editCapRound" min="1" max="10" class="w-full p-3 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-600 rounded-lg outline-none text-center text-slate-800 dark:text-white font-bold">
                </div>

                <div id="editSquareGroup" class="hidden gap-4 bg-slate-50 dark:bg-slate-800 p-3 rounded-xl border border-slate-100 dark:border-slate-700">
                    <div class="flex-1">
                        <label class="block text-[10px] font-bold text-slate-500 dark:text-slate-400 mb-1 text-center">Sillas Largo</label>
                        <input type="number" id="editCapX" min="1" class="w-full p-2 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-600 rounded-lg outline-none text-center text-slate-800 dark:text-white font-bold">
                    </div>
                    <div class="flex-1">
                        <label class="block text-[10px] font-bold text-slate-500 dark:text-slate-400 mb-1 text-center">Sillas Ancho</label>
                        <input type="number" id="editCapY" min="1" class="w-full p-2 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-600 rounded-lg outline-none text-center text-slate-800 dark:text-white font-bold">
                    </div>
                </div>
                
                <div class="bg-slate-50 dark:bg-slate-800 p-3 rounded-xl border border-slate-100 dark:border-slate-700">
                    <p class="text-[10px] font-bold text-slate-400 uppercase mb-2">Mantelería</p>
                    <div class="flex items-center gap-3 mb-2">
                        <input type="color" id="editTableColor" class="w-8 h-8 rounded cursor-pointer border-0 p-0" value="#ffffff">
                        <label class="text-xs font-bold text-slate-600 dark:text-slate-300 flex-1">Color Mantel Base</label>
                    </div>
                    <div class="flex items-center gap-3">
                        <input type="checkbox" id="editTableOverlayCheck" class="w-5 h-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500" onchange="document.getElementById('overlayColorDiv').classList.toggle('hidden', !this.checked)">
                        <label class="text-xs font-bold text-slate-600 dark:text-slate-300">Cubre Mantel</label>
                    </div>
                    <div id="overlayColorDiv" class="flex items-center gap-3 mt-2 hidden">
                        <input type="color" id="editTableOverlayColor" class="w-8 h-8 rounded cursor-pointer border-0 p-0" value="#ffd700">
                        <label class="text-xs font-bold text-slate-600 dark:text-slate-300 flex-1">Color Cubre</label>
                    </div>
                </div>

                <!-- SECCIÓN SILLAS Y COLORES NUEVOS -->
                <div class="bg-slate-50 dark:bg-slate-800 p-3 rounded-xl border border-slate-100 dark:border-slate-700">
                    <p class="text-[10px] font-bold text-slate-400 uppercase mb-2">Sillas y Cojines</p>
                    <div class="grid grid-cols-3 gap-2 mb-3">
                         <div class="text-center">
                             <input type="color" id="editChairColor" class="w-8 h-8 rounded cursor-pointer border-0 p-0 mx-auto" value="#000000">
                             <label class="block text-[9px] font-bold text-slate-500 mt-1">Estructura</label>
                         </div>
                         <div class="text-center">
                             <input type="color" id="editCushionColor" class="w-8 h-8 rounded cursor-pointer border-0 p-0 mx-auto" value="#ffffff">
                             <label class="block text-[9px] font-bold text-slate-500 mt-1">Cojín</label>
                         </div>
                         <div class="text-center">
                             <input type="color" id="editOccupiedColor" class="w-8 h-8 rounded cursor-pointer border-0 p-0 mx-auto" value="#64748b">
                             <label class="block text-[9px] font-bold text-slate-500 mt-1">Ocupado</label>
                         </div>
                    </div>
                </div>

                <!-- SECCIÓN COLORES RECIENTES -->
                <div id="recentColorsSection" class="hidden">
                    <p class="text-[10px] font-bold text-slate-400 uppercase mb-2">Colores Recientes</p>
                    <div id="recentColorsContainer" class="flex flex-wrap gap-2"></div>
                </div>

                <div>
                    <label class="block text-[10px] font-bold text-slate-500 dark:text-slate-400 mb-2 uppercase">Rotación</label>
                    <div class="flex items-center gap-2">
                        <input type="range" id="editTableRotation" min="0" max="360" value="0" step="5" class="w-full accent-blue-600" oninput="document.getElementById('rotVal').innerText=this.value+'°'">
                        <span id="rotVal" class="text-xs font-bold text-slate-700 dark:text-slate-300 w-8 text-right">0°</span>
                    </div>
                </div>

                <div class="flex gap-3 pt-2">
                    <button type="button" id="btnDeleteTable" onclick="deleteTableFromMap()" class="bg-red-50 text-red-600 px-5 py-3 rounded-xl font-bold text-sm hidden hover:bg-red-100 active:scale-95 transition border border-red-100"><i class="fas fa-trash"></i></button>
                    <button type="submit" class="flex-1 bg-blue-600 text-white font-bold py-3.5 rounded-xl shadow-lg text-sm hover:bg-blue-700 active:scale-95 transition">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- EDIT OBJECT MODAL -->
    <div id="editObjectModal" class="fixed inset-0 z-[90] hidden bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-slate-900 p-6 rounded-3xl w-full max-w-sm border border-slate-200 dark:border-slate-700 shadow-2xl animate__animated animate__fadeInUp">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-slate-800 dark:text-white">Editar Objeto</h3>
                <button type="button" onclick="document.getElementById('editObjectModal').classList.add('hidden')" class="bg-slate-100 dark:bg-slate-800 p-2 rounded-full text-slate-400 hover:text-slate-600 active:scale-95"><i class="fas fa-times w-5 h-5 flex justify-center items-center"></i></button>
            </div>
            <form id="editObjectForm" class="space-y-4">
                <input type="hidden" id="editObjId">
                <input type="hidden" id="editObjType">
                <div>
                    <label class="block text-[10px] font-bold text-slate-500 dark:text-slate-400 mb-1 uppercase">Nombre</label>
                    <input type="text" id="editObjName" class="w-full p-3 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl outline-none text-sm font-bold text-slate-800 dark:text-white">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[10px] font-bold text-slate-500 dark:text-slate-400 mb-1 uppercase text-center">Ancho (m)</label>
                        <input type="number" id="editObjWidth" step="0.1" class="w-full p-3 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl outline-none text-center font-bold text-slate-800 dark:text-white">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-500 dark:text-slate-400 mb-1 uppercase text-center">Largo (m)</label>
                        <input type="number" id="editObjHeight" step="0.1" class="w-full p-3 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl outline-none text-center font-bold text-slate-800 dark:text-white">
                    </div>
                </div>
                <div class="flex items-center gap-3 bg-slate-50 dark:bg-slate-800 p-3 rounded-xl border border-slate-200 dark:border-slate-700">
                    <input type="color" id="editObjColor" class="w-8 h-8 rounded cursor-pointer border-0 p-0">
                    <label class="text-xs font-bold text-slate-600 dark:text-slate-300">Color</label>
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-slate-500 dark:text-slate-400 mb-1 uppercase">Rotación</label>
                    <input type="range" id="editObjRotation" min="0" max="360" step="5" class="w-full accent-purple-600">
                </div>
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="deleteObject()" class="bg-red-50 text-red-600 px-5 py-3 rounded-xl font-bold text-sm hover:bg-red-100 active:scale-95 transition border border-red-100"><i class="fas fa-trash"></i></button>
                    <button type="submit" class="flex-1 bg-purple-600 text-white font-bold py-3.5 rounded-xl shadow-lg text-sm hover:bg-purple-700 active:scale-95 transition">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Otros Modales (Guests, QR, etc) se mantienen igual en estructura pero ocultos por defecto -->
    <div id="addGuestModal" class="hidden fixed inset-0 z-[70] bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white dark:bg-slate-900 p-6 rounded-3xl w-full max-w-sm border border-slate-200 dark:border-slate-700 shadow-2xl max-h-[90vh] overflow-y-auto admin-scroll"><div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold text-slate-800 dark:text-white">Nueva Invitación</h3><button type="button" onclick="document.getElementById('addGuestModal').classList.add('hidden')" class="bg-slate-100 dark:bg-slate-800 p-2 rounded-full text-slate-400 active:scale-95"><i class="fas fa-times w-5 h-5 flex justify-center items-center"></i></button></div><form id="addGuestFormModal" class="space-y-5"><div><label class="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-2 uppercase">Nombre o Familia</label><input type="text" id="inputName" placeholder="Ej. Familia Pérez" class="w-full p-4 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl outline-none text-slate-800 dark:text-white font-bold text-base sm:text-sm placeholder-slate-400" required></div><div><label class="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-2 uppercase">WhatsApp</label><div class="flex"><select id="countryCodeSelect" class="border border-r-0 border-slate-200 dark:border-slate-700 rounded-l-xl bg-slate-50 dark:bg-slate-800 p-4 text-base sm:text-sm text-slate-800 dark:text-white font-bold outline-none"><option value="52"> +52</option><option value="1"> +1</option></select><input type="tel" id="inputPhone" placeholder="10 dígitos" class="border border-slate-200 dark:border-slate-700 p-4 rounded-r-xl w-full bg-slate-50 dark:bg-slate-800 outline-none text-slate-800 dark:text-white font-bold text-base sm:text-sm placeholder-slate-400" required></div></div><div class="flex items-center justify-between bg-slate-50 dark:bg-slate-800 p-3 rounded-xl border border-slate-200 dark:border-slate-700"><span class="text-sm font-bold text-slate-500 dark:text-slate-400 ml-2 uppercase">Pases:</span><div class="flex items-center bg-white dark:bg-slate-900 rounded-lg border border-slate-200 dark:border-slate-700 overflow-hidden shadow-sm"><button type="button" onclick="adjustTickets(-1)" class="w-12 h-12 hover:bg-slate-100 dark:hover:bg-slate-800 font-black text-slate-500 text-lg active:bg-slate-200">-</button><input type="number" id="inputTickets" value="2" class="w-12 text-center bg-transparent outline-none font-black text-slate-800 dark:text-white text-lg" readonly><button type="button" onclick="adjustTickets(1)" class="w-12 h-12 hover:bg-slate-100 dark:hover:bg-slate-800 font-black text-slate-500 text-lg active:bg-slate-200">+</button></div></div><button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg text-base active:scale-95 transition flex justify-center items-center gap-2 mt-4"><i class="fab fa-whatsapp text-xl"></i> Enviar Invitación</button></form></div></div>
    
    <!-- MODALS RESTANTES (Copia del anterior pero con IDs correctos para funcionamiento JS) -->
    <div id="editGuestTableModal" class="hidden fixed inset-0 z-[100] bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white dark:bg-slate-800 p-6 sm:p-8 rounded-3xl shadow-2xl max-w-sm w-full relative admin-theme border border-slate-200 dark:border-slate-700 animate__animated animate__zoomIn"><div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold text-slate-800 dark:text-white">Asignar Mesa</h3><button type="button" onclick="document.getElementById('editGuestTableModal').classList.add('hidden')" class="bg-slate-100 dark:bg-slate-800 p-2 rounded-full text-slate-400 hover:text-slate-600 active:scale-95"><i class="fas fa-times w-5 h-5 flex justify-center items-center"></i></button></div><form id="editGuestTableForm" class="space-y-4"><input type="hidden" id="editGT_id"><div><label class="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-2 uppercase">Selecciona la mesa</label><select id="editGT_select" class="w-full p-4 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl outline-none text-slate-800 dark:text-white font-bold text-center text-base sm:text-sm"></select></div><button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg transition mt-4 active:scale-95">Guardar Cambios</button></form></div></div>
    <div id="editGuestPaxModal" class="hidden fixed inset-0 z-[100] bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white dark:bg-slate-800 p-6 sm:p-8 rounded-3xl shadow-2xl max-w-sm w-full relative admin-theme border border-slate-200 dark:border-slate-700 animate__animated animate__zoomIn"><div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold text-slate-800 dark:text-white">Modificar Pases</h3><button type="button" onclick="document.getElementById('editGuestPaxModal').classList.add('hidden')" class="bg-slate-100 dark:bg-slate-800 p-2 rounded-full text-slate-400 hover:text-slate-600 active:scale-95"><i class="fas fa-times w-5 h-5 flex justify-center items-center"></i></button></div><form id="editGuestPaxForm" class="space-y-4"><input type="hidden" id="editGP_id"><div><label class="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-2 uppercase text-center">Cantidad de Pases</label><input type="number" id="editGP_input" min="1" class="w-full p-4 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl outline-none text-slate-800 dark:text-white font-black text-center text-2xl" required></div><button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg transition mt-4 active:scale-95">Guardar Cambios</button></form></div></div>
    <div id="tableWarningModal" class="hidden fixed inset-0 z-[90] bg-black/80 flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white dark:bg-slate-800 p-6 rounded-3xl w-full max-w-sm border border-slate-200 dark:border-slate-700 shadow-2xl animate__animated animate__headShake max-h-[90vh] overflow-y-auto"><div class="text-center mb-4"><i class="fas fa-exclamation-triangle text-red-500 text-5xl mb-4 drop-shadow-md"></i><h3 class="text-xl font-black text-slate-800 dark:text-white">Capacidad Excedida</h3><p class="text-sm text-slate-500 dark:text-slate-400 mt-2">La mesa <strong class="text-slate-800 dark:text-white" id="twMesa">X</strong> solo tiene <strong class="text-red-500" id="twDisp">0</strong> sillas vacías, pero este invitado requiere <strong class="text-blue-500" id="twReq">0</strong> sillas.</p></div><div class="bg-slate-50 dark:bg-slate-900 p-4 rounded-xl border border-slate-200 dark:border-slate-700 mb-6"><p class="text-[10px] font-bold text-slate-400 uppercase mb-3 text-center">Alternativas Sugeridas:</p><div id="twSuggestions" class="flex flex-wrap gap-2 justify-center"></div></div><div class="flex flex-col gap-3"><button id="btnAutoSingle" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3.5 rounded-xl shadow-lg transition text-sm flex items-center justify-center gap-2 active:scale-95"><i class="fas fa-magic"></i> Auto-Acomodar Invitado</button><button onclick="closeTableWarning()" class="w-full bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 font-bold py-3.5 rounded-xl transition text-sm active:scale-95">Cancelar Asignación</button></div></div></div>
    <div id="aaResultModal" class="hidden fixed inset-0 z-[110] bg-black/80 flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white dark:bg-slate-800 p-6 rounded-3xl w-full max-w-md border border-slate-200 dark:border-slate-700 shadow-2xl animate__animated animate__fadeInUp max-h-[90vh] flex flex-col"><div class="flex justify-between items-center mb-2 shrink-0"><h3 class="text-xl font-black text-slate-800 dark:text-white"><i class="fas fa-info-circle text-blue-500 mr-2"></i> Reporte de Acomodo</h3><button onclick="closeAaResult()" class="bg-slate-100 dark:bg-slate-800 p-2 rounded-full text-slate-400 hover:text-slate-600 active:scale-95"><i class="fas fa-times w-5 h-5 flex justify-center items-center"></i></button></div><div id="aaResultContent" class="flex-1 overflow-y-auto"></div></div></div>
    <div id="configModal" class="hidden fixed inset-0 z-[80] bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white dark:bg-slate-900 p-6 rounded-3xl w-full max-w-md border border-slate-200 dark:border-slate-700 shadow-2xl animate__animated animate__fadeInUp"><div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold text-slate-800 dark:text-white">Imagen Evento (Miniatura)</h3><button type="button" onclick="document.getElementById('configModal').classList.add('hidden')" class="bg-slate-100 dark:bg-slate-800 p-2 rounded-full text-slate-400 active:scale-95"><i class="fas fa-times w-5 h-5 flex justify-center items-center"></i></button></div><form id="configForm" class="space-y-4"><input type="hidden" id="configImageUrlHidden"><div class="border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-2xl p-6 text-center hover:bg-slate-50 dark:hover:bg-slate-800 transition cursor-pointer relative" onclick="document.getElementById('configImageFile').click()"><i class="fas fa-cloud-upload-alt text-3xl text-blue-500 mb-2"></i><p class="text-sm font-bold text-slate-700 dark:text-slate-300">Toca para subir una foto</p><p class="text-xs text-slate-500 mt-1">Se mostrará al enviar invitaciones y en el código QR</p><input type="file" id="configImageFile" accept="image/*" class="hidden"></div><div class="flex justify-center"><img id="configImagePreview" class="hidden rounded-xl max-h-32 object-cover shadow-md border border-slate-200 dark:border-slate-700"></div><div class="flex gap-3 pt-4"><button type="button" onclick="document.getElementById('configModal').classList.add('hidden')" class="flex-1 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 py-3.5 rounded-xl font-bold text-sm active:scale-95 transition">Cancelar</button><button type="submit" class="flex-1 bg-blue-600 text-white font-bold py-3.5 rounded-xl shadow-lg text-sm active:scale-95 transition">Guardar</button></div></form></div></div>
    <div id="qrPreviewModal" class="hidden fixed inset-0 z-[80] bg-black/90 flex items-center justify-center p-4 backdrop-blur-md" onclick="this.classList.add('hidden')"><div class="bg-white p-6 sm:p-8 rounded-[2rem] max-w-sm w-full text-center relative shadow-2xl transform transition-transform scale-100 animate__animated animate__zoomIn" onclick="event.stopPropagation()"><div id="ticketContainer" class="bg-white pb-6 rounded-2xl border-4 border-dashed border-slate-200 mb-6 flex flex-col items-center overflow-hidden relative"><img id="qrModalCover" class="ticket-cover-img hidden" src="" alt="Portada"><div class="w-full h-32 mb-4"></div><div class="ticket-content w-full px-6 flex flex-col items-center"><h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Pase de Acceso</h3><h2 class="text-2xl font-black text-slate-900 mb-3 leading-tight relative z-10" id="qrModalName">Nombre Invitado</h2><div class="flex justify-center gap-4 text-sm font-bold text-slate-700 mb-5 bg-slate-100 p-3 rounded-xl border border-slate-200 w-full max-w-[200px] relative z-10"><span id="qrModalPax"><i class="fas fa-users text-slate-400 mr-1"></i> 0</span></div><div id="qrModalCanvas" class="flex justify-center mb-4 p-3 bg-white rounded-xl shadow-inner border border-slate-100 w-fit mx-auto relative z-10"></div><p class="text-[10px] text-slate-400 font-mono tracking-widest bg-slate-50 py-1 px-4 rounded-lg border border-slate-100 relative z-10" id="qrModalID">ID: ---</p></div></div><button onclick="downloadQrTicket()" class="w-full bg-slate-900 hover:bg-slate-800 text-white font-bold py-4 rounded-2xl shadow-xl transition flex items-center justify-center gap-2 active:scale-95 text-sm uppercase tracking-wider"><i class="fas fa-download"></i> Guardar Imagen</button><button onclick="document.getElementById('qrPreviewModal').classList.add('hidden')" class="mt-4 text-xs font-bold text-slate-400 uppercase tracking-wider p-2">Cerrar</button></div></div>
    <div id="guestDetailModal" class="hidden fixed inset-0 z-[70] bg-black/60 flex items-end sm:items-center justify-center p-0 sm:p-4 backdrop-blur-sm"><div class="bg-white dark:bg-slate-900 w-full sm:max-w-sm rounded-t-3xl sm:rounded-3xl overflow-hidden animate__animated animate__slideInUp sm:animate__fadeIn border-t border-slate-200 dark:border-slate-700 pb-6 sm:pb-0"><div class="p-6"><div class="flex justify-between items-start mb-6"><div><h2 id="mobName" class="text-2xl font-black text-slate-800 dark:text-white leading-tight">Nombre</h2><p id="mobPhone" class="text-sm text-slate-400 font-medium mt-1"></p></div><button onclick="closeMobileDetails()" class="bg-slate-100 dark:bg-slate-800 p-2.5 rounded-full text-slate-500 dark:text-slate-400 active:scale-95"><i class="fas fa-times w-5 h-5 flex items-center justify-center"></i></button></div><div class="grid grid-cols-2 gap-3 mb-6"><div class="bg-slate-50 dark:bg-slate-800 p-4 rounded-2xl border border-slate-100 dark:border-slate-700 text-center shadow-sm"><span class="block text-[10px] text-slate-400 uppercase font-bold mb-1"><i class="fas fa-users"></i> Pases</span><div class="flex justify-center items-center gap-2"><span id="mobTickets" class="text-2xl font-black text-slate-800 dark:text-white">0</span><button id="btnEditMobPax" class="text-slate-400 hover:text-blue-500 active:scale-95 transition"><i class="fas fa-edit"></i></button></div></div><div class="bg-slate-50 dark:bg-slate-800 p-4 rounded-2xl border border-slate-100 dark:border-slate-700 text-center shadow-sm flex flex-col justify-center"><span class="block text-[10px] text-slate-400 uppercase font-bold mb-1"><i class="fas fa-chair"></i> Mesa</span><div class="flex justify-center items-center gap-2"><span id="mobTableDisplay" class="text-2xl font-black text-blue-600 dark:text-blue-400">-</span><button id="mobEditTableBtn" class="text-slate-400 hover:text-blue-500 active:scale-95 transition"><i class="fas fa-edit"></i></button></div></div></div><div class="flex justify-center mb-6"><button id="btnVerQR" class="w-full flex items-center justify-center gap-2 bg-blue-600 text-white px-6 py-4 rounded-2xl text-sm font-bold shadow-lg active:scale-95 transition"><i class="fas fa-qrcode text-lg"></i> Mostrar Código de Acceso</button></div><div id="mobStatusBadge" class="w-full py-3.5 rounded-xl text-center font-bold text-sm mb-6 border">Estado</div><button id="btnEliminarInvitacion" class="w-full text-red-500 bg-red-50 dark:bg-red-900/10 border border-red-100 dark:border-red-900/30 text-sm font-bold py-3.5 rounded-xl active:scale-95 transition"><i class="fas fa-trash-alt mr-2"></i> Eliminar Invitación</button></div></div></div>

    <script>
        const adminPin = "1234";
        let html5QrCode = null;
        let currentGuestIdCheckin = null;
        let currentMobId = null;
        let allGuests = [];
        let eventConfig = { imageUrl: "" };
        let tablesData = {}; 
        let venueObjects = {}; 
        let venueFloors = {}; 
        let tableOccupancy = {}; 
        let previousLayoutBackup = null;
        let mapZoom = 1.0;
        let recentColors = []; 
        let lastChairConfig = { chair: '#000000', cushion: '#ffffff', occupied: '#64748b' };
        
        let scaleFactor = 30; // Pixeles por metro base (Zoom 1.0)

        window.onclick = function(event) {
            if (!event.target.matches('.dropbtn') && !event.target.closest('#exportDropdown') && !event.target.closest('#addObjDropdown') && !event.target.closest('button') && !event.target.closest('label') && !event.target.closest('select')) {
                var dropdowns = document.getElementsByClassName("dropdown-content");
                for (var i = 0; i < dropdowns.length; i++) { if (dropdowns[i].classList.contains('show')) dropdowns[i].classList.remove('show'); }
            }
        }

        window.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            if (params.get('view') === 'wendy_planner') { document.getElementById('guestView').classList.add('hidden'); openReceptionView(); }
            fetch('https://ipapi.co/json/').then(res => res.json()).then(data => { const select = document.getElementById('countryCodeSelect'); if(select) { const opt = document.createElement('option'); opt.value = data.country_calling_code.replace('+',''); opt.text = `${data.country_name} ${data.country_calling_code}`; select.add(opt, 0); select.selectedIndex = 0; } }).catch(e=>{});
        });

        // --- SISTEMA DE MODALES Y NOTIFICACIONES ---
        window.showToast = (msg, icon='check') => { const t = document.getElementById('toastMsg'); document.getElementById('toastText').innerText = msg; let iconClass = icon === 'check' ? 'fa-check-circle text-green-400' : 'fa-info-circle text-blue-400'; if(icon==='error') iconClass = 'fa-times-circle text-red-400'; document.getElementById('toastIcon').innerHTML = `<i class="fas ${iconClass}"></i>`; t.classList.remove('-translate-y-32', 'opacity-0'); setTimeout(() => t.classList.add('-translate-y-32', 'opacity-0'), 3000); }
        window.showAlert = (title, text, type='info') => { let icon = type==='error'?'<i class="fas fa-times-circle text-red-500"></i>':(type==='success'?'<i class="fas fa-check-circle text-green-500"></i>':'<i class="fas fa-info-circle text-blue-500"></i>'); document.getElementById('sysModalIcon').innerHTML = icon; document.getElementById('sysModalTitle').innerText = title; document.getElementById('sysModalText').innerText = text; document.getElementById('sysModalActions').innerHTML = `<button onclick="closeSysModal()" class="w-full bg-slate-800 dark:bg-slate-700 text-white font-bold py-3.5 rounded-xl active:scale-95 transition shadow-lg">Aceptar</button>`; document.getElementById('sysModal').classList.remove('hidden'); }
        window.showConfirm = (title, text, confirmCb) => { document.getElementById('sysModalIcon').innerHTML = '<i class="fas fa-question-circle text-yellow-500"></i>'; document.getElementById('sysModalTitle').innerText = title; document.getElementById('sysModalText').innerText = text; window.tempConfirmCb = () => { closeSysModal(); confirmCb(); }; document.getElementById('sysModalActions').innerHTML = `<button onclick="closeSysModal()" class="flex-1 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 font-bold py-3.5 rounded-xl active:scale-95 transition">Cancelar</button><button onclick="window.tempConfirmCb()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 rounded-xl active:scale-95 transition shadow-lg">Confirmar</button>`; document.getElementById('sysModal').classList.remove('hidden'); }
        window.closeSysModal = () => document.getElementById('sysModal').classList.add('hidden');

        // ADMIN LOGIN
        window.openAdminLogin = () => document.getElementById('loginModal').classList.remove('hidden');
        window.closeAdmin = () => document.getElementById('adminPanel').classList.add('translate-y-full');
        window.checkLogin = () => { if (document.getElementById('adminPassword').value === adminPin) { document.getElementById('loginModal').classList.add('hidden'); document.getElementById('adminPanel').classList.remove('translate-y-full'); loadConfig(); document.getElementById('plannerLinkInput').value = window.location.origin + window.location.pathname + "?view=wendy_planner"; } else { showAlert("Acceso Denegado", "PIN incorrecto.", "error"); } }
        
        window.switchTab = (tabName) => {
            ['guests', 'tables', 'map', 'planner'].forEach(t => { document.getElementById(`view-${t}`).classList.add('hidden'); const btn = document.getElementById(`tab-${t}`); if(btn){ btn.classList.replace('text-blue-600','text-slate-500'); btn.classList.replace('dark:text-blue-400','dark:text-slate-400'); btn.classList.replace('border-blue-600','border-transparent'); } });
            document.getElementById(`view-${tabName}`).classList.remove('hidden');
            const activeBtn = document.getElementById(`tab-${tabName}`); activeBtn.classList.replace('text-slate-500','text-blue-600'); activeBtn.classList.replace('dark:text-slate-400','dark:text-blue-400'); activeBtn.classList.replace('border-transparent','border-blue-600');
            if(tabName === 'tables') renderTablesView();
            if(tabName === 'map') { setTimeout(renderMap, 100); } 
        }

        // CARGA DE DATOS FIREBASE
        function loadConfig() {
            if(!window.db || !window.isAuthReady) { setTimeout(loadConfig, 500); return; }
            window.onSnapshot(window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'settings', 'config'), (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if(data.imageUrl) { eventConfig.imageUrl = data.imageUrl; document.getElementById('configImageUrlHidden').value = data.imageUrl; document.getElementById('configImagePreview').src = data.imageUrl; document.getElementById('configImagePreview').classList.remove('hidden'); }
                    if(data.tablesData) tablesData = data.tablesData;
                    if(data.venueObjects) venueObjects = data.venueObjects;
                    if(data.venueFloors) venueFloors = data.venueFloors; 
                    else if(!data.venueFloors && data.venueDims) {
                         venueFloors = { 'floor_default': { id: 'floor_default', name: 'Salón Principal', width: data.venueDims.width, height: data.venueDims.length, x: 0, y: 0 } };
                    }
                    if(data.recentColors) recentColors = data.recentColors; 
                    if(data.lastChairConfig) lastChairConfig = data.lastChairConfig;
                }
                
                // Si no hay pisos definidos, inicializar uno por defecto
                if (!venueFloors || Object.keys(venueFloors).length === 0) {
                     venueFloors = { 'floor_default': { id: 'floor_default', name: 'Salón Principal', width: 20, height: 30, x: 0, y: 0 } };
                }
                
                window.loadAdminData();
            });
        }

        window.loadAdminData = function() {
            const q = window.query(window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'guests'), window.orderBy('createdAt', 'desc'));
            window.onSnapshot(q, (snapshot) => {
                allGuests = []; let totalG = 0, confirmedG = 0, checkedInG = 0; tableOccupancy = {}; 
                Object.keys(tablesData).forEach(k => tableOccupancy[k] = 0);
                snapshot.forEach((docSnap) => { const g = docSnap.data(); g.id = docSnap.id; allGuests.push(g); totalG += g.tickets; if(g.confirmed) confirmedG += g.tickets; if(g.checkedIn) checkedInG += (g.actualAttendees || g.tickets); if (g.table && tableOccupancy[g.table] !== undefined) tableOccupancy[g.table] += g.tickets; });
                window.renderGuestList();
                if(document.getElementById('dashTotalGuests')) document.getElementById('dashTotalGuests').innerText = totalG;
                if(document.getElementById('dashConfirmed')) document.getElementById('dashConfirmed').innerText = confirmedG;
                if(document.getElementById('dashCheckedIn')) document.getElementById('dashCheckedIn').innerText = checkedInG;
                if(!document.getElementById('view-tables').classList.contains('hidden')) renderTablesView();
                if(!document.getElementById('view-map').classList.contains('hidden')) renderMap();
            });
        }

        // --- EXPORT DATA LOGIC ---
        window.exportData = (type) => {
            if (allGuests.length === 0) { showAlert("Error", "No hay datos para exportar", "error"); return; }
            const data = allGuests.map(g => [g.name, g.phone, g.tickets, g.table || "Sin mesa", g.confirmed ? "Sí" : "No", g.checkedIn ? "Sí" : "No"]);
            const headers = ["Nombre", "Teléfono", "Pases", "Mesa", "Confirmado", "Ingresó"];

            if (type === 'xlsx') {
                const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Invitados");
                XLSX.writeFile(wb, "invitados_fiesteala.xlsx");
            } else if (type === 'pdf') {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.text("Lista de Invitados - Fiesteala", 14, 15);
                doc.autoTable({ head: [headers], body: data, startY: 20 });
                doc.save("invitados_fiesteala.pdf");
            }
            document.getElementById('exportDropdown').classList.remove('show');
        };

        // --- WRISTBANDS GENERATION ---
        window.generateWristbands = async () => {
            const { jsPDF } = window.jspdf;
            if(allGuests.length === 0) { showAlert("Error", "No hay invitados", "error"); return; }
            showToast("Generando Pulseras...", "info");
            const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
            let yPos = 10; const bandHeight = 25; const qrContainer = document.getElementById('qrGenContainer');
            
            for(let g of allGuests) {
                for(let i=0; i<g.tickets; i++) {
                    if (yPos + bandHeight > 280) { doc.addPage(); yPos = 10; }
                    doc.setDrawColor(200); doc.rect(10, yPos, 190, bandHeight); 
                    doc.setFillColor(240, 240, 240); doc.rect(170, yPos, 30, bandHeight, 'F');
                    doc.setFontSize(6); doc.setTextColor(150); doc.text("ADHESIVO", 175, yPos + 12);
                    doc.setTextColor(0); doc.setFont("helvetica", "bold"); doc.setFontSize(14); doc.text("ACCESO VIP", 15, yPos + 10);
                    doc.setFont("helvetica", "normal"); doc.setFontSize(10); doc.text(g.name.substring(0, 25), 15, yPos + 18);
                    
                    qrContainer.innerHTML = "";
                    const qrCode = new QRCode(qrContainer, { text: g.id, width: 100, height: 100 });
                    await new Promise(r => setTimeout(r, 10)); 
                    const qrCanvas = qrContainer.querySelector('canvas');
                    if (qrCanvas) {
                        const qrData = qrCanvas.toDataURL("image/png");
                        doc.addImage(qrData, 'PNG', 145, yPos + 2, 21, 21);
                    }
                    doc.setFontSize(8); doc.text(g.id.substring(0,8).toUpperCase(), 145, yPos + 24);
                    yPos += bandHeight + 2;
                }
            }
            doc.save("pulseras_tyvek.pdf"); showToast("PDF Generado");
        };

        // --- NUEVA FUNCIÓN EXPORTAR MAPA A PDF ---
        window.exportMapPdf = async () => {
            const element = document.getElementById('venueCanvas');
            if(!element) return;
            
            try {
                showToast("Generando PDF...", "info");
                // Usar html2canvas para capturar el div del mapa
                const canvas = await html2canvas(element, { 
                    scale: 2, // Mejor calidad
                    backgroundColor: null,
                    logging: false,
                    useCORS: true
                });
                
                const imgData = canvas.toDataURL('image/png');
                const { jsPDF } = window.jspdf;
                
                // Determinar orientación (aunque venueCanvas suele ser cuadrado o apaisado)
                const orientation = canvas.width > canvas.height ? 'landscape' : 'portrait';
                
                const pdf = new jsPDF({
                    orientation: orientation,
                    unit: 'mm',
                    format: 'a4'
                });
                
                const imgProps = pdf.getImageProperties(imgData);
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                
                // Calcular dimensiones para ajustar a la página manteniendo ratio
                const widthRatio = pdfWidth / imgProps.width;
                const heightRatio = pdfHeight / imgProps.height;
                const ratio = Math.min(widthRatio, heightRatio);
                
                const w = imgProps.width * ratio;
                const h = imgProps.height * ratio;
                
                // Centrar imagen
                const x = (pdfWidth - w) / 2;
                const y = (pdfHeight - h) / 2;
                
                pdf.addImage(imgData, 'PNG', x, y, w, h);
                pdf.save('plano-evento.pdf');
                showToast("PDF Descargado");
            } catch (e) {
                console.error(e);
                showAlert("Error", "No se pudo generar el PDF del mapa.", "error");
            }
        };

        // --- GESTIÓN DE ÁREAS (MODIFICADO: INPUTS EN LISTA) ---
        window.openReconfigureModal = () => {
            const modal = document.getElementById('initialSetupModal');
            const listContainer = document.getElementById('venueAreasList');
            listContainer.innerHTML = '';
            
            if (Object.keys(venueFloors).length === 0) {
                 listContainer.innerHTML = '<p class="text-xs text-slate-400 text-center italic">No hay áreas definidas.</p>';
            } else {
                Object.values(venueFloors).forEach(f => {
                    const div = document.createElement('div');
                    div.className = "flex flex-col bg-slate-50 dark:bg-slate-900 p-3 rounded-xl border border-slate-200 dark:border-slate-700 gap-2";
                    div.innerHTML = `
                        <div class="flex justify-between items-center">
                            <span class="block text-xs font-bold text-slate-800 dark:text-white">${f.name || 'Área'}</span>
                            <button onclick="deleteVenueArea('${f.id}')" class="text-red-400 hover:text-red-600 px-2 active:scale-95"><i class="fas fa-trash"></i></button>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div class="flex items-center gap-1">
                                <label class="text-[9px] font-bold text-slate-400">ANCHO:</label>
                                <input type="number" value="${f.width}" min="1" class="w-full p-1 text-center bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded text-xs text-slate-800 dark:text-white font-bold" onchange="updateVenueArea('${f.id}', 'width', this.value)">
                            </div>
                            <div class="flex items-center gap-1">
                                <label class="text-[9px] font-bold text-slate-400">LARGO:</label>
                                <input type="number" value="${f.height}" min="1" class="w-full p-1 text-center bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded text-xs text-slate-800 dark:text-white font-bold" onchange="updateVenueArea('${f.id}', 'height', this.value)">
                            </div>
                        </div>
                    `;
                    listContainer.appendChild(div);
                });
            }
            modal.classList.remove('hidden');
        }

        window.updateVenueArea = (id, prop, val) => {
            if(venueFloors[id]) {
                venueFloors[id][prop] = parseFloat(val);
                saveMapToFirebase();
                renderMap();
            }
        }

        window.addNewVenueArea = async () => {
            const w = parseFloat(document.getElementById('newAreaW').value) || 10;
            const l = parseFloat(document.getElementById('newAreaL').value) || 10;
            const id = 'floor_' + Date.now();
            const offset = Object.keys(venueFloors).length * 5;
            
            venueFloors[id] = { id: id, name: `Área ${Object.keys(venueFloors).length + 1}`, width: w, height: l, x: offset, y: 0 };
            
            await saveMapToFirebase();
            openReconfigureModal(); 
            renderMap();
        }
        
        window.deleteVenueArea = async (id) => {
            if (Object.keys(venueFloors).length <= 1) { showAlert("Aviso", "Debes tener al menos una área/piso."); return; }
            showConfirm("Borrar Área", "¿Eliminar esta sección del mapa?", async () => {
                delete venueFloors[id];
                await saveMapToFirebase();
                openReconfigureModal();
                renderMap();
            });
        }

        // --- GESTIÓN DE MESAS (MODAL RESTAURADO) ---
        window.openTableConfigModal = () => {
            const modal = document.getElementById('tableConfigModal');
            document.getElementById('initTableCount').value = 0;
            document.getElementById('varietyToggle').checked = false;
            toggleVariety();
            document.getElementById('initTableShape').value = 'round';
            updateInitInputs();
            modal.classList.remove('hidden');
        }

        window.toggleVariety = () => {
            const isMixed = document.getElementById('varietyToggle').checked;
            const singleConfig = document.getElementById('singleTypeConfig');
            const mixedConfig = document.getElementById('initMixedConfig');
            const singleCountContainer = document.getElementById('singleConfigContainer');

            if (isMixed) {
                singleConfig.classList.add('hidden');
                singleCountContainer.classList.add('hidden');
                mixedConfig.classList.remove('hidden');
            } else {
                singleConfig.classList.remove('hidden');
                singleCountContainer.classList.remove('hidden');
                mixedConfig.classList.add('hidden');
                updateInitInputs();
            }
        }

        window.updateInitInputs = () => {
            const shape = document.getElementById('initTableShape').value;
            const roundGrp = document.getElementById('initRoundConfig');
            const rectGrp = document.getElementById('initRectConfig');
            const customGrp = document.getElementById('initCustomConfig');
            
            roundGrp.classList.add('hidden'); rectGrp.classList.add('hidden'); customGrp.classList.add('hidden');
            rectGrp.classList.remove('grid'); customGrp.classList.remove('grid');

            if (shape === 'custom') { customGrp.classList.remove('hidden'); customGrp.classList.add('grid'); } 
            else if(shape === 'round') { roundGrp.classList.remove('hidden'); } 
            else { 
                rectGrp.classList.remove('hidden'); rectGrp.classList.add('grid'); 
                const inputX = document.getElementById('initTableX'); const inputY = document.getElementById('initTableY');
                if (shape === 'rect') { inputX.max = 5; inputY.max = 1; } 
                else if(shape === 'square') { inputX.max = 3; inputY.max = 3; }
            }
        }

        document.getElementById('tableGenerationForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const isMixed = document.getElementById('varietyToggle').checked;
            let tCount = 0;

            if (isMixed) {
                tCount = (parseInt(document.getElementById('mixRoundCount').value)||0) + 
                         (parseInt(document.getElementById('mixSquareCount').value)||0) + 
                         (parseInt(document.getElementById('mixRectCount').value)||0) + 
                         (parseInt(document.getElementById('mixCustomCount').value)||0);
            } else {
                tCount = parseInt(document.getElementById('initTableCount').value);
            }
            
            if(tCount > 0) {
                showConfirm("Generar Mesas", "Esto borrará las mesas existentes y creará " + tCount + " nuevas. ¿Continuar?", async () => {
                    executeTableGeneration(tCount, isMixed);
                });
            } else {
                document.getElementById('tableConfigModal').classList.add('hidden');
            }
        });

        async function executeTableGeneration(tCount, isMixed) {
            const newTables = {}; 
            const cols = Math.ceil(Math.sqrt(tCount));
            let tablesToGenerate = [];

            if (isMixed) {
                const countR = parseInt(document.getElementById('mixRoundCount').value) || 0;
                const capR = Math.min(parseInt(document.getElementById('mixRoundCap').value) || 10, 10);
                const countS = parseInt(document.getElementById('mixSquareCount').value) || 0;
                const sqX = Math.min(parseInt(document.getElementById('mixSquareX').value) || 3, 3);
                const sqY = Math.min(parseInt(document.getElementById('mixSquareY').value) || 3, 3);
                const countRec = parseInt(document.getElementById('mixRectCount').value) || 0;
                const recX = Math.min(parseInt(document.getElementById('mixRectX').value) || 3, 5);
                const recY = Math.min(parseInt(document.getElementById('mixRectY').value) || 1, 1);
                const countCust = parseInt(document.getElementById('mixCustomCount').value) || 0;
                const custL = parseFloat(document.getElementById('mixCustomL').value) || 2.0;
                const custW = parseFloat(document.getElementById('mixCustomW').value) || 1.0;

                for(let i=0; i<countR; i++) tablesToGenerate.push({ shape: 'round', capacity: capR, chairsX:0, chairsY:0 });
                for(let i=0; i<countS; i++) tablesToGenerate.push({ shape: 'square', capacity: 0, chairsX: sqX, chairsY: sqY });
                for(let i=0; i<countRec; i++) tablesToGenerate.push({ shape: 'rect', capacity: 0, chairsX: recX, chairsY: recY });
                for(let i=0; i<countCust; i++) tablesToGenerate.push({ shape: 'custom', capacity: 0, chairsX: 0, chairsY: 0, widthM: custL, heightM: custW });
            } else {
                const shape = document.getElementById('initTableShape').value;
                let cap = 10; let cX = 3; let cY = 1; let targetShape = shape;
                if(shape === 'round') { cap = parseInt(document.getElementById('initTableCap').value); if(cap > 10) cap = 10; } 
                else if (shape === 'custom') { cX = parseInt(document.getElementById('initCustomX').value); cY = parseInt(document.getElementById('initCustomY').value); targetShape = 'custom'; } 
                else { cX = parseInt(document.getElementById('initTableX').value); cY = parseInt(document.getElementById('initTableY').value); }
                
                for(let i=0; i<tCount; i++) {
                    tablesToGenerate.push({ shape: targetShape, capacity: (shape==='round' ? cap : 0), chairsX: (shape!=='round' ? cX : 0), chairsY: (shape!=='round' ? cY : 0) });
                }
            }

            tablesToGenerate.forEach((tData, index) => {
                const i = index + 1;
                const row = Math.floor((i-1) / cols); 
                const col = (i-1) % cols;
                newTables[i] = { 
                    id: String(i), shape: tData.shape, capacity: tData.capacity, 
                    chairsX: tData.chairsX, chairsY: tData.chairsY,
                    widthM: tData.widthM || 0, heightM: tData.heightM || 0,
                    x: 2 + (col * 3), y: 2 + (row * 3), rotation: 0, color: '#ffffff', overlay: false, overlayColor: '#ffd700' 
                };
            });
            
            tablesData = newTables;
            for(let g of allGuests) if(g.table) await window.updateDoc(window.doc(window.db,'artifacts',window.appId,'public','data','guests',g.id), {table: ""});
            await saveMapToFirebase();
            document.getElementById('tableConfigModal').classList.add('hidden'); 
            showToast("Mesas Generadas");
            renderTablesView(); renderMap();
        }

        // ZOOM CONTROL
        window.zoomMap = (delta) => {
            mapZoom += delta;
            if (mapZoom < 0.2) mapZoom = 0.2;
            if (mapZoom > 3.0) mapZoom = 3.0;
            renderMap();
        }

        // RENDERIZADO DEL MAPA
        window.renderMap = () => {
            const canvas = document.getElementById('venueCanvas');
            const pxPerMeter = scaleFactor * mapZoom;
            
            canvas.innerHTML = ''; 

            // 1. RENDER FLOORS (ÁREAS)
            Object.values(venueFloors).forEach(f => {
                const wPx = f.width * pxPerMeter;
                const hPx = f.height * pxPerMeter;
                const leftPx = f.x * pxPerMeter;
                const topPx = f.y * pxPerMeter;
                
                // Z-index 0 para que estén al fondo
                canvas.innerHTML += `
                    <div id="floor-${f.id}" class="draggable-floor map-floor-area"
                         style="width:${wPx}px; height:${hPx}px; left:${leftPx}px; top:${topPx}px; z-index:0;"
                         onmousedown="startDragFloor(event, '${f.id}')" ontouchstart="startDragFloor(event, '${f.id}')">
                         <span class="absolute top-2 left-2 text-[10px] text-slate-400 select-none pointer-events-none uppercase font-bold tracking-widest bg-white/50 dark:bg-black/20 px-1 rounded">${f.name}</span>
                    </div>
                `;
            });

            // 2. RENDER OBJETOS
            Object.values(venueObjects).forEach(obj => {
                const wPx = obj.width * pxPerMeter;
                const hPx = obj.height * pxPerMeter;
                const leftPx = obj.x * pxPerMeter;
                const topPx = obj.y * pxPerMeter;
                
                let extraClass = '';
                if(obj.type === 'pista') extraClass = 'led-floor';
                if(obj.type === 'alberca') extraClass = 'pool-water';
                if(obj.type === 'jardin') extraClass = 'grass-texture';
                
                canvas.innerHTML += `
                    <div id="obj-${obj.id}" class="draggable-object venue-object ${extraClass}" 
                         style="width:${wPx}px; height:${hPx}px; left:${leftPx}px; top:${topPx}px; transform: rotate(${obj.rotation}deg); background-color: ${obj.color};"
                         onmousedown="startDragObj(event, '${obj.id}')" ontouchstart="startDragObj(event, '${obj.id}')" ondblclick="openEditObjectModal('${obj.id}')">
                         <span class="pointer-events-none text-xs ${obj.type==='pista'||obj.type==='escenario'?'text-white':'text-slate-800'} drop-shadow-md z-10 select-none font-black">${obj.name}</span>
                    </div>
                `;
            });

            // 3. RENDER MESAS
            Object.values(tablesData).forEach(t => {
                let tWidthM, tHeightM; 
                
                if (t.shape === 'round') { tWidthM = 1.5; tHeightM = 1.5; } 
                else if (t.shape === 'square') { tWidthM = 1.5; tHeightM = 1.5; } 
                else if (t.shape === 'rect') { tWidthM = 2.44; tHeightM = 0.75; } 
                else if (t.shape === 'custom') { tWidthM = parseFloat(t.widthM) || 2.0; tHeightM = parseFloat(t.heightM) || 1.0; } 
                else { tWidthM = 1.5; tHeightM = 1.5; }

                const tWidthPx = tWidthM * pxPerMeter;
                const tHeightPx = tHeightM * pxPerMeter;
                const tLeftPx = t.x * pxPerMeter;
                const tTopPx = t.y * pxPerMeter;

                let chairsHTML = '';
                const chairSizeM = 0.45; 
                const chairSizePx = chairSizeM * pxPerMeter;
                
                const guests = allGuests.filter(g => g.table === t.id);
                let occupiedCount = 0;
                guests.forEach(g => occupiedCount += g.tickets);

                // --- NUEVA LÓGICA DE SILLAS ORIENTADAS AL CENTRO ---
                const createChair = (xM, yM, fixedRotation = null) => {
                    const isOccupied = occupiedCount > 0;
                    if(isOccupied) occupiedCount--;
                    
                    const cLeftPx = xM * pxPerMeter;
                    const cTopPx = yM * pxPerMeter;
                    
                    let angleDeg = 0;
                    if (fixedRotation !== null) {
                        angleDeg = fixedRotation;
                    } else {
                        // Calcular centro de la mesa en pixeles relativos
                        const centerX = tWidthPx / 2;
                        const centerY = tHeightPx / 2;
                        
                        const deltaY = centerY - cTopPx;
                        const deltaX = centerX - cLeftPx;
                        
                        angleDeg = Math.atan2(deltaY, deltaX) * (180 / Math.PI);
                        angleDeg += 90;
                    }

                    const strColor = t.chairColor || '#000000'; 
                    const seatColor = t.cushionColor || '#ffffff'; 
                    const occColor = t.occupiedColor || '#64748b'; 
                    const finalSeatColor = isOccupied ? occColor : seatColor;
                    
                    return `<div class="chair-tiffany" style="width:${chairSizePx}px; height:${chairSizePx}px; left:${cLeftPx}px; top:${cTopPx}px; transform: translate(-50%, -50%) rotate(${angleDeg}deg);">
                        <div class="chair-back" style="background-color: ${strColor}; opacity: 0.3; border-color: ${strColor}"></div>
                        <div class="chair-seat" style="background-color: ${finalSeatColor}; border-color: ${strColor}"></div>
                    </div>`;
                };

                // Ajuste de separación: 0.05m gap + 0.225m mitad de silla = 0.275m
                if(t.shape === 'round') {
                    const radiusM = tWidthM / 2;
                    const seatRadiusM = radiusM + 0.275; 
                    const cap = t.capacity || 10;
                    for(let i=0; i<cap; i++) {
                        const angle = (i / cap) * 2 * Math.PI;
                        const cx = (tWidthM/2) + Math.cos(angle) * seatRadiusM;
                        const cy = (tHeightM/2) + Math.sin(angle) * seatRadiusM;
                        chairsHTML += createChair(cx, cy);
                    }
                } else {
                    // Rectangular Logic Distribution
                    const cx = (t.chairsX||1);
                    const cy = (t.chairsY||1);
                    const chairOffset = 0.275; 
                    
                    // Top Side (y negative, facing Down 0deg)
                    const spacingX = tWidthM / (cx + 1);
                    for(let i=1; i<=cx; i++) chairsHTML += createChair(i*spacingX, -chairOffset, 0);
                    
                    // Bottom Side (y > height, facing Up 180deg)
                    for(let i=1; i<=cx; i++) chairsHTML += createChair(i*spacingX, tHeightM + chairOffset, 180);
                    
                    if(t.shape !== 'round') {
                        // Left Side (x negative, facing Right 270deg/-90deg)
                        const spacingY = tHeightM / (cy + 1);
                        for(let i=1; i<=cy; i++) chairsHTML += createChair(-chairOffset, i*spacingY, 270);
                        // Right Side (x > width, facing Left 90deg)
                        for(let i=1; i<=cy; i++) chairsHTML += createChair(tWidthM + chairOffset, i*spacingY, 90);
                    }
                }

                const mainColor = t.color || '#ffffff';
                // Clip path para rombo que se adapta a cualquier tamaño + escala para que "caiga"
                const overlayHTML = (t.overlay) ? `<div class="table-cloth-overlay" style="background-color: ${t.overlayColor || '#ffd700'}; width: 100%; height: 100%; clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%); transform: scale(1.25);"></div>` : '';
                const shapeRadius = t.shape === 'round' ? '50%' : '2px';

                canvas.innerHTML += `
                    <div id="table-${t.id}" class="draggable-table" style="left:${tLeftPx}px; top:${tTopPx}px;"
                         onmousedown="startDragTable(event, '${t.id}')" ontouchstart="startDragTable(event, '${t.id}')" ondblclick="openEditTableModal('${t.id}')">
                        <div class="relative shadow-lg" style="width:${tWidthPx}px; height:${tHeightPx}px; transform: rotate(${t.rotation}deg);">
                            <!-- Contenedor superficie (recorta mantel) -->
                            <div class="absolute inset-0 z-10" style="overflow: hidden; border-radius: ${shapeRadius};">
                                <div class="table-cloth-base" style="background-color: ${mainColor};"></div>
                                ${overlayHTML}
                            </div>
                            <!-- ID Label -->
                            <span class="absolute inset-0 flex items-center justify-center font-bold text-slate-800 z-20 pointer-events-none select-none" style="transform: rotate(-${t.rotation}deg); text-shadow: 0 0 2px white;">${t.id}</span>
                            <!-- Sillas (fuera del recorte) -->
                            <div class="absolute inset-0 z-0" style="width:100%; height:100%; overflow: visible; transform: rotate(-${t.rotation}deg);">
                                ${chairsHTML}
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        // DRAG & DROP LOGIC
        let dragId = null; let dragType = null;
        let startX, startY, initX, initY;

        window.startDragTable = (e, id) => { e.stopPropagation(); dragId = id; dragType = 'table'; initDrag(e); }
        window.startDragObj = (e, id) => { e.stopPropagation(); dragId = id; dragType = 'object'; initDrag(e); }
        window.startDragFloor = (e, id) => { e.stopPropagation(); dragId = id; dragType = 'floor'; initDrag(e); }

        function initDrag(e) {
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            startX = clientX; startY = clientY;
            
            if(dragType === 'table') { initX = tablesData[dragId].x; initY = tablesData[dragId].y; }
            else if (dragType === 'floor') { initX = venueFloors[dragId].x; initY = venueFloors[dragId].y; }
            else { initX = venueObjects[dragId].x; initY = venueObjects[dragId].y; }
        }

        const mapArea = document.getElementById('mapScrollArea');
        
        const moveHandler = (e) => {
            if(!dragId) return;
            e.preventDefault();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            
            const pxPerMeter = scaleFactor * mapZoom;
            const deltaX_px = clientX - startX;
            const deltaY_px = clientY - startY;
            const deltaX_m = deltaX_px / pxPerMeter;
            const deltaY_m = deltaY_px / pxPerMeter;

            let newX = initX + deltaX_m;
            let newY = initY + deltaY_m;

            // Limites muy laxos (el canvas es de 2000px virtualmente infinito)
            if(newX < -20) newX = -20;
            if(newY < -20) newY = -20;
            
            if(dragType === 'table') {
                tablesData[dragId].x = newX; tablesData[dragId].y = newY;
                const el = document.getElementById(`table-${dragId}`);
                if(el) { el.style.left = (newX * pxPerMeter) + 'px'; el.style.top = (newY * pxPerMeter) + 'px'; }
            } else if (dragType === 'floor') {
                venueFloors[dragId].x = newX; venueFloors[dragId].y = newY;
                const el = document.getElementById(`floor-${dragId}`);
                if(el) { el.style.left = (newX * pxPerMeter) + 'px'; el.style.top = (newY * pxPerMeter) + 'px'; }
            } else {
                venueObjects[dragId].x = newX; venueObjects[dragId].y = newY;
                const el = document.getElementById(`obj-${dragId}`);
                if(el) { el.style.left = (newX * pxPerMeter) + 'px'; el.style.top = (newY * pxPerMeter) + 'px'; }
            }
        };

        const endHandler = () => { if(dragId) { saveMapToFirebase(); dragId = null; } };

        mapArea.addEventListener('mousemove', moveHandler); mapArea.addEventListener('touchmove', moveHandler, {passive:false});
        mapArea.addEventListener('mouseup', endHandler); mapArea.addEventListener('mouseleave', endHandler); mapArea.addEventListener('touchend', endHandler);

        window.saveMapToFirebase = async () => {
            try { await window.setDoc(window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'settings', 'config'), { tablesData: tablesData, venueObjects: venueObjects, venueFloors: venueFloors, recentColors: recentColors, lastChairConfig: lastChairConfig }, { merge: true }); } catch(e) {}
        }

        // --- EDITAR MESA ---
        window.openEditTableModal = (id) => {
            document.getElementById('editTableForm').reset();
            document.getElementById('overlayColorDiv').classList.add('hidden');
            renderRecentColors(); 

            if (id === 'new') {
                document.getElementById('editTableTitle').innerText = "Nueva Mesa"; document.getElementById('editTableId').value = ""; document.getElementById('editTableLabel').value = Object.keys(tablesData).length + 1; 
                document.getElementById('editTableShape').value = 'round';
                document.getElementById('btnDeleteTable').classList.add('hidden');
                document.getElementById('editDimLargo').value = 2.0; document.getElementById('editDimAncho').value = 1.0;
                
                // USAR ULTIMOS COLORES
                document.getElementById('editChairColor').value = lastChairConfig.chair; 
                document.getElementById('editCushionColor').value = lastChairConfig.cushion; 
                document.getElementById('editOccupiedColor').value = lastChairConfig.occupied; 
                
                updateEditInputs();
            } else {
                const t = tablesData[id];
                document.getElementById('editTableTitle').innerText = "Editar: " + id; document.getElementById('editTableId').value = id; document.getElementById('editTableLabel').value = t.id; document.getElementById('editTableShape').value = t.shape; 
                document.getElementById('editTableRotation').value = t.rotation || 0; document.getElementById('rotVal').innerText = (t.rotation || 0) + "°";
                document.getElementById('editTableColor').value = t.color || '#ffffff';
                document.getElementById('editTableOverlayCheck').checked = t.overlay || false;
                if(t.overlay) document.getElementById('overlayColorDiv').classList.remove('hidden');
                document.getElementById('editTableOverlayColor').value = t.overlayColor || '#ffd700';
                document.getElementById('editChairColor').value = t.chairColor || '#000000'; document.getElementById('editCushionColor').value = t.cushionColor || '#ffffff'; document.getElementById('editOccupiedColor').value = t.occupiedColor || '#64748b'; 
                if(t.widthM) document.getElementById('editDimLargo').value = t.widthM;
                if(t.heightM) document.getElementById('editDimAncho').value = t.heightM;
                updateEditInputs();
                if(t.shape === 'round') document.getElementById('editCapRound').value = t.capacity; 
                else { document.getElementById('editCapX').value = t.chairsX; document.getElementById('editCapY').value = t.chairsY; }
                document.getElementById('btnDeleteTable').classList.remove('hidden');
            }
            document.getElementById('editTableModal').classList.remove('hidden');
        }

        window.renderRecentColors = () => {
            const container = document.getElementById('recentColorsContainer');
            const section = document.getElementById('recentColorsSection');
            container.innerHTML = '';
            if (recentColors.length === 0) { section.classList.add('hidden'); return; }
            section.classList.remove('hidden');
            recentColors.forEach(color => {
                const swatch = document.createElement('div');
                swatch.className = 'color-swatch'; swatch.style.backgroundColor = color;
                swatch.onclick = () => { document.getElementById('editTableColor').value = color; };
                container.appendChild(swatch);
            });
        }

        window.saveRecentColor = (color) => {
            if (!color) return;
            if (recentColors.includes(color)) { recentColors = recentColors.filter(c => c !== color); }
            recentColors.unshift(color);
            if (recentColors.length > 5) recentColors.pop();
        }

        window.updateEditInputs = () => {
            const shape = document.getElementById('editTableShape').value;
            const roundGrp = document.getElementById('editRoundGroup'); const sqGrp = document.getElementById('editSquareGroup'); 
            const customDims = document.getElementById('editCustomDims');
            roundGrp.classList.add('hidden'); sqGrp.classList.add('hidden'); customDims.classList.add('hidden'); sqGrp.classList.remove('flex');

            if(shape === 'round') { roundGrp.classList.remove('hidden'); } 
            else { 
                sqGrp.classList.remove('hidden'); sqGrp.classList.add('flex'); 
                const cx = document.getElementById('editCapX'); const cy = document.getElementById('editCapY');
                if(shape === 'square') { cx.max = 3; cy.max = 3; cy.removeAttribute('readonly'); cy.classList.remove('bg-slate-200','text-slate-500'); } 
                else if(shape === 'rect') { cx.max = 5; cy.max = 1; cy.removeAttribute('readonly'); cy.classList.remove('bg-slate-200','text-slate-500'); } 
                else { cx.removeAttribute('max'); cy.removeAttribute('max'); cy.removeAttribute('readonly'); cy.classList.remove('bg-slate-200','text-slate-500'); customDims.classList.remove('hidden'); customDims.classList.add('grid'); }
            }
        }

        document.getElementById('editTableForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const originalId = document.getElementById('editTableId').value; const newId = document.getElementById('editTableLabel').value; 
            const shape = document.getElementById('editTableShape').value;
            let capRound = parseInt(document.getElementById('editCapRound').value) || 10; 
            let cX = parseInt(document.getElementById('editCapX').value) || 3; 
            let cY = parseInt(document.getElementById('editCapY').value) || 1;
            let rot = parseInt(document.getElementById('editTableRotation').value) || 0;
            let color = document.getElementById('editTableColor').value;
            let overlay = document.getElementById('editTableOverlayCheck').checked;
            let overlayColor = document.getElementById('editTableOverlayColor').value;
            let chairColor = document.getElementById('editChairColor').value;
            let cushionColor = document.getElementById('editCushionColor').value;
            let occupiedColor = document.getElementById('editOccupiedColor').value;
            
            saveRecentColor(color); if(overlay) saveRecentColor(overlayColor);
            
            // ACTUALIZAR GLOBAL Y GUARDAR PREFERENCIA
            lastChairConfig = { chair: chairColor, cushion: cushionColor, occupied: occupiedColor };

            let wM = 0; let hM = 0;
            if(shape === 'custom') { wM = parseFloat(document.getElementById('editDimLargo').value) || 2.0; hM = parseFloat(document.getElementById('editDimAncho').value) || 1.0; }
            
            // Si es la primera vez, intentar colocar en el centro de la primera área encontrada
            let startX = 5, startY = 5;
            if(Object.keys(venueFloors).length > 0) { const f = Object.values(venueFloors)[0]; startX = f.x + 2; startY = f.y + 2; }

            const newTableData = { 
                id: newId, shape, rotation: rot, color, overlay, overlayColor, chairColor, cushionColor, occupiedColor,
                capacity: shape==='round'?capRound:0, chairsX: shape!=='round'?cX:0, chairsY: shape!=='round'?cY:0, widthM: wM, heightM: hM,
                x: originalId ? tablesData[originalId].x : startX, y: originalId ? tablesData[originalId].y : startY
            };

            if (originalId && originalId !== newId) { delete tablesData[originalId]; allGuests.forEach(g => { if(g.table === originalId) window.updateDoc(window.doc(window.db,'artifacts',window.appId,'public','data','guests',g.id), {table: newId}); }); }
            tablesData[newId] = newTableData;
            saveMapToFirebase(); document.getElementById('editTableModal').classList.add('hidden'); renderMap(); renderTablesView();
        });

        window.deleteTableFromMap = () => {
            const id = document.getElementById('editTableId').value;
            showConfirm("Eliminar", "¿Eliminar mesa?", () => { delete tablesData[id]; saveMapToFirebase(); document.getElementById('editTableModal').classList.add('hidden'); renderMap(); renderTablesView(); });
        }
        
        window.emptyAllTables = () => { showConfirm("VACIAR MESAS", "¿Quitar a todos los invitados de sus mesas?", async () => { try { for(let g of allGuests) if(g.table) await window.updateDoc(window.doc(window.db,'artifacts',window.appId,'public','data','guests',g.id), {table: ""}); showToast("Mesas vaciadas"); renderTablesView(); } catch(e) { showAlert("Error", "Error al vaciar", "error"); } }); }
        window.deleteAllTables = () => { showConfirm("ELIMINAR TODO", "⚠️ ¿Estás seguro de eliminar TODAS las mesas?", async () => { try { tablesData = {}; for(let g of allGuests) if(g.table) await window.updateDoc(window.doc(window.db,'artifacts',window.appId,'public','data','guests',g.id), {table: ""}); await saveMapToFirebase(); renderMap(); renderTablesView(); showToast("Todas las mesas eliminadas"); } catch(e) { showAlert("Error", "Error al eliminar", "error"); } }); }

        // --- GESTIÓN DE OBJETOS ---
        window.openEditObjectModal = (id, type) => {
            document.getElementById('addObjDropdown').classList.remove('show');
            document.getElementById('editObjectForm').reset();
            
            if(id === 'new') {
                const newId = 'obj_' + Date.now();
                document.getElementById('editObjId').value = newId;
                document.getElementById('editObjType').value = type;
                document.getElementById('editObjRotation').value = 0;
                
                let defName = "Objeto"; let w=1, h=1, col="#cccccc";
                if(type === 'pista') { defName="Pista Baile"; w=5; h=5; col="#333333"; }
                if(type === 'escenario') { defName="Escenario"; w=6; h=3; col="#000000"; }
                if(type === 'dj') { defName="DJ"; w=2; h=1; col="#1a1a1a"; }
                if(type === 'barra') { defName="Barra"; w=3; h=1; col="#8b4513"; }
                if(type === 'mesa_honor') { defName="Mesa Honor"; w=4; h=1; col="#ffffff"; }
                if(type === 'entrada') { defName="Entrada"; w=2; h=0.5; col="#00ff00"; }
                if(type === 'bano') { defName="Baños"; w=3; h=2; col="#00ffff"; }
                // NUEVOS TIPOS
                if(type === 'deco') { defName="Set Fotos"; w=3; h=2; col="#f43f5e"; }
                if(type === 'brincolin') { defName="Brincolín"; w=4; h=4; col="#fb923c"; }
                if(type === 'alberca') { defName="Alberca"; w=8; h=4; col="#38bdf8"; }
                if(type === 'jardin') { defName="Jardín"; w=10; h=5; col="#4ade80"; }
                if(type === 'pinata') { defName="Piñata"; w=2; h=2; col="#facc15"; }
                if(type === 'animacion') { defName="Animación"; w=3; h=3; col="#a855f7"; }

                document.getElementById('editObjName').value = defName;
                document.getElementById('editObjWidth').value = w;
                document.getElementById('editObjHeight').value = h;
                document.getElementById('editObjColor').value = col;
            } else {
                const o = venueObjects[id];
                document.getElementById('editObjId').value = id;
                document.getElementById('editObjType').value = o.type;
                document.getElementById('editObjName').value = o.name;
                document.getElementById('editObjWidth').value = o.width;
                document.getElementById('editObjHeight').value = o.height;
                document.getElementById('editObjColor').value = o.color;
                document.getElementById('editObjRotation').value = o.rotation;
            }
            document.getElementById('editObjectModal').classList.remove('hidden');
        }

        document.getElementById('editObjectForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const id = document.getElementById('editObjId').value;
            const isNew = !venueObjects[id];
            
            // Encontrar un lugar seguro
            let startX = 2, startY = 2;
            if(Object.keys(venueFloors).length > 0) { const f = Object.values(venueFloors)[0]; startX = f.x + 1; startY = f.y + 1; }

            venueObjects[id] = {
                id: id,
                type: document.getElementById('editObjType').value,
                name: document.getElementById('editObjName').value,
                width: parseFloat(document.getElementById('editObjWidth').value),
                height: parseFloat(document.getElementById('editObjHeight').value),
                color: document.getElementById('editObjColor').value,
                rotation: parseInt(document.getElementById('editObjRotation').value),
                x: isNew ? startX : venueObjects[id].x,
                y: isNew ? startY : venueObjects[id].y
            };
            saveMapToFirebase(); document.getElementById('editObjectModal').classList.add('hidden'); renderMap();
        });

        window.deleteObject = () => {
            const id = document.getElementById('editObjId').value;
            delete venueObjects[id]; saveMapToFirebase(); document.getElementById('editObjectModal').classList.add('hidden'); renderMap();
        }

        // FUNCIONES AUXILIARES
        window.getGuestTableCapacity = (t) => t.shape === 'round' ? t.capacity : (t.chairsX + t.chairsY) * 2;
        
        window.renderTablesView = function() { 
            const g=document.getElementById('tablesGrid'); g.innerHTML=''; const t={}; let unassignedCount = 0;
            Object.keys(tablesData).forEach(k => t[k] = []);
            allGuests.forEach(x=>{ 
                const k = x.table || 'Sin Asignar'; 
                if(!t[k]) t[k]=[]; t[k].push(x); 
                if(!x.table || x.table === "Sin Asignar") unassignedCount++; 
            }); 
            document.getElementById('tableStatsText').innerText = `${unassignedCount} invitados sin mesa.`;
            if(t['Sin Asignar'] && t['Sin Asignar'].length > 0) g.innerHTML+=createTableCard('Sin Asignar',t['Sin Asignar'],'slate', null); 
            let sortedKeys = Object.keys(t).filter(k=>k!=='Sin Asignar').sort((a,b)=>a.localeCompare(b, undefined, {numeric:true}));
            sortedKeys.forEach(k => { g.innerHTML += createTableCard(k, t[k], 'blue', k); }); 
        }

        window.createTableCard = function(t,gList,c, tableId) { 
            const tot=gList.reduce((s,x)=>s+x.tickets,0); 
            let isFull = false; let cap = 0;
            if(tableId && tablesData[tableId]) { cap = getGuestTableCapacity(tablesData[tableId]); isFull = tot >= cap; }
            const borderColor = c === 'blue' ? (isFull ? 'border-red-400' : 'border-blue-500 dark:border-blue-700') : 'border-slate-300 dark:border-slate-700';
            const bgColor = c === 'blue' ? 'bg-white dark:bg-slate-800' : 'bg-slate-50 dark:bg-slate-800/50';
            let extraBadge = '';
            if (tableId) {
                if (isFull) extraBadge = `<span class="text-[10px] text-red-500 font-bold ml-2 bg-red-50 dark:bg-red-900/20 px-2 py-0.5 rounded uppercase">Lleno</span>`;
                else extraBadge = `<span class="text-[10px] text-slate-400 font-bold ml-2">(${tot}/${cap})</span>`;
            }
            let h=`<div class="${bgColor} border-t-4 ${borderColor} shadow-sm rounded-2xl p-5 transition-transform hover:-translate-y-1 duration-300 flex flex-col"><div class="flex justify-between items-center mb-4 border-b border-slate-100 dark:border-slate-700 pb-2"><h4 class="font-bold text-slate-800 dark:text-white flex items-center">${t} ${extraBadge}</h4><span class="text-[10px] bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 px-2 py-1 rounded-md font-bold">${tot} Pax</span></div>`; 
            if (gList.length === 0) { h += `<p class="text-xs text-slate-400 italic text-center py-2 flex-1 flex items-center justify-center">Mesa vacía</p>`; } 
            else { h += `<ul class="text-xs text-slate-500 dark:text-slate-400 space-y-2 flex-1 overflow-y-auto max-h-40 admin-scroll">`; gList.forEach(x=>h+=`<li class="flex justify-between items-center pb-2 border-b border-slate-50 dark:border-slate-700 last:border-0 last:pb-0"><span class="${x.confirmed?'text-yellow-600 dark:text-yellow-400 font-bold':''}">${x.name}</span> <span class="font-bold bg-slate-50 dark:bg-slate-700 border border-slate-100 dark:border-slate-600 px-1.5 py-0.5 rounded">${x.tickets}</span></li>`); h += `</ul>`; }
            return h+'</div>'; 
        }

        window.renderGuestList = function() {
            const tbody = document.getElementById('guestTableBody');
            tbody.innerHTML = ''; 
            
            let searchTerm = document.getElementById('searchGuestInput')?.value.toLowerCase() || '';
            let sortOption = document.getElementById('sortGuestSelect')?.value || 'newest';
            
            let filteredGuests = allGuests.filter(g => g.name.toLowerCase().includes(searchTerm));
            
            if (sortOption === 'confirmed') filteredGuests = filteredGuests.filter(g => g.confirmed);
            if (sortOption === 'unconfirmed') filteredGuests = filteredGuests.filter(g => !g.confirmed && !g.checkedIn);
            
            filteredGuests.sort((a, b) => {
                if (sortOption === 'name') return a.name.localeCompare(b.name);
                if (sortOption === 'table') return String(a.table || '').localeCompare(String(b.table || ''), undefined, {numeric: true});
                if (sortOption === 'tickets') return b.tickets - a.tickets;
                return 0; // default (newest) from Firebase
            });

            filteredGuests.forEach((g) => {
                const tr = document.createElement('div'); 
                tr.className = "flex flex-col md:flex-row w-full p-2 md:p-3 hover:bg-slate-50 dark:hover:bg-slate-800 transition";
                
                let deskStatusLabel = `<span class="bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-300 px-2 py-1 rounded text-[10px] font-bold">Pendiente</span>`;
                let mobStatusClass = "border-transparent bg-white dark:bg-slate-900 border border-slate-100 dark:border-slate-800";
                
                if (g.confirmed) { 
                    deskStatusLabel = `<span class="bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-400 px-2 py-1 rounded text-[10px] font-bold">Confirmado</span>`; 
                    mobStatusClass = "status-card-confirmed";
                }
                if (g.checkedIn) { 
                    deskStatusLabel = `<span class="bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 px-2 py-1 rounded text-[10px] font-bold">Ingresó</span>`;
                    mobStatusClass = "status-card-checkedin";
                }
                
                let tableDisplay = g.table ? g.table : '';
                let tableBtn = `<button onclick="event.stopPropagation(); window.openEditGuestTable('${g.id}', '${g.table||''}')" class="text-slate-400 hover:text-blue-500 transition ml-2"><i class="fas fa-edit"></i></button>`;
                let paxBtn = `<button onclick="event.stopPropagation(); window.openEditGuestPax('${g.id}', ${g.tickets})" class="text-slate-400 hover:text-blue-500 transition ml-2"><i class="fas fa-edit"></i></button>`;
                let mobileResendBtn = `<button onclick="event.stopPropagation(); resendInvitation('${g.id}', '${g.name}', '${g.phone}')" class="flex items-center justify-center gap-1.5 bg-[#25D366] hover:bg-green-600 text-white px-3 py-2.5 rounded-xl text-sm font-bold w-full mt-3 active:scale-95 transition shadow-sm border border-green-600/50"><i class="fab fa-whatsapp text-lg"></i> Reenviar Invitación</button>`;

                tr.innerHTML = `
                    <div class="md:hidden w-full p-4 rounded-xl mb-1 ${mobStatusClass}" onclick="openMobileDetails('${g.id}')">
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="font-black text-slate-800 dark:text-white text-lg leading-tight mb-1">${g.name}</div>
                                <div class="text-xs text-slate-500 flex items-center gap-2">
                                    <span class="bg-slate-200 dark:bg-slate-700 px-2 py-1 rounded-md font-bold text-slate-700 dark:text-slate-300"><i class="fas fa-users mr-1"></i> ${g.tickets}</span>
                                    <span class="bg-blue-100 dark:bg-blue-900/40 text-blue-700 dark:text-blue-400 px-2 py-1 rounded-md font-bold"><i class="fas fa-chair mr-1"></i> ${tableDisplay || 'Sin Mesa'}</span>
                                </div>
                            </div>
                            <button onclick="event.stopPropagation(); showGuestQR('${g.id}', '${g.name}', '${g.tickets}')" class="w-12 h-12 rounded-full bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 flex items-center justify-center shadow-md border border-slate-100 dark:border-slate-700 active:scale-95"><i class="fas fa-qrcode text-xl"></i></button>
                        </div>
                        ${mobileResendBtn}
                    </div>
                    <div class="hidden md:flex w-full items-center justify-between">
                        <div class="w-1/3 font-bold text-slate-700 dark:text-slate-300 text-sm truncate pl-2 pr-2">${g.name}</div>
                        <div class="w-20 text-center"><span class="font-bold text-slate-600 dark:text-slate-300">${tableDisplay}</span>${tableBtn}</div>
                        <div class="w-16 text-center"><button onclick="showGuestQR('${g.id}', '${g.name}', '${g.tickets}')" class="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-500 hover:text-blue-500 transition active:scale-95 flex items-center justify-center mx-auto"><i class="fas fa-qrcode"></i></button></div>
                        <div class="w-24 text-center"><span class="font-bold text-slate-600 dark:text-slate-300 text-sm">${g.tickets}</span>${paxBtn}</div>
                        <div class="w-24 text-center">${deskStatusLabel}</div>
                        <div class="w-24 text-center flex justify-center gap-2"><button onclick="resendInvitation('${g.id}', '${g.name}', '${g.phone}')" class="w-8 h-8 rounded-full bg-green-50 dark:bg-green-900/20 text-green-500 hover:bg-green-100 transition active:scale-95" title="Reenviar"><i class="fab fa-whatsapp"></i></button><button onclick="confirmDeleteGuest('${g.id}')" class="w-8 h-8 rounded-full bg-red-50 dark:bg-red-900/20 text-red-400 hover:bg-red-100 hover:text-red-500 transition active:scale-95" title="Eliminar"><i class="fas fa-trash-alt"></i></button></div>
                    </div>
                `;
                tbody.appendChild(tr);
            });
            if(filteredGuests.length === 0) { tbody.innerHTML = `<div class="p-8 text-center text-slate-400 dark:text-slate-500 font-bold text-sm">No se encontraron invitados.</div>`; }
        }

        // ADD GUEST
        document.getElementById('addGuestFormModal').addEventListener('submit', async (e) => {
            e.preventDefault(); 
            const name = document.getElementById('inputName').value;
            const phone = document.getElementById('inputPhone').value;
            const code = document.getElementById('countryCodeSelect').value;
            const tickets = parseInt(document.getElementById('inputTickets').value);
            
            try {
                const docRef = await window.addDoc(window.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'guests'), {
                    name, phone: code+phone, tickets, confirmed: false, checkedIn: false, table: "", createdAt: new Date().toISOString()
                });
                document.getElementById('addGuestModal').classList.add('hidden');
                document.getElementById('addGuestFormModal').reset();
                showToast("Invitado Agregado");
                resendInvitation(docRef.id, name, code+phone);
            } catch(e) {
                showAlert("Error", "No se pudo guardar", "error");
            }
        });

        window.openAddGuestModal = () => document.getElementById('addGuestModal').classList.remove('hidden');
        window.openConfigModal = () => document.getElementById('configModal').classList.remove('hidden');
        
        document.getElementById('configImageFile').addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;
            try {
                const resizedBase64 = await resizeImage(file, 800, 600);
                document.getElementById('configImageUrlHidden').value = resizedBase64;
                document.getElementById('configImagePreview').src = resizedBase64;
                document.getElementById('configImagePreview').classList.remove('hidden');
            } catch (err) { showAlert("Error", "No se pudo procesar la imagen", "error"); }
        });

        function resizeImage(file, maxWidth, maxHeight) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader(); reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image(); img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas'); let width = img.width; let height = img.height;
                        if (width > height) { if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; } } else { if (height > maxHeight) { width *= maxHeight / height; height = maxHeight; } }
                        canvas.width = width; canvas.height = height;
                        const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    };
                    img.onerror = (err) => reject(err);
                };
                reader.onerror = (err) => reject(err);
            });
        }

        document.getElementById('configForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const imageUrl = document.getElementById('configImageUrlHidden').value;
            try {
                if (imageUrl.length > 900000) { showAlert("Error", "La imagen es demasiado grande. Intenta con otra más pequeña.", "error"); return; }
                await window.setDoc(window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'settings', 'config'), { imageUrl: imageUrl }, { merge: true });
                document.getElementById('configModal').classList.add('hidden'); showToast("Configuración guardada");
            } catch(err) { showAlert("Error", "Fallo al guardar. La imagen podría ser muy pesada.", "error"); }
        });

        window.showGuestQR = (id, name, tickets) => {
            document.getElementById('qrModalName').innerText = name;
            document.getElementById('qrModalPax').innerHTML = `<i class="fas fa-users text-slate-400 mr-1"></i> ${tickets}`;
            document.getElementById('qrModalID').innerText = "ID: " + id.substring(0, 8).toUpperCase();
            
            const canvasContainer = document.getElementById('qrModalCanvas'); canvasContainer.innerHTML = ""; 
            new QRCode(canvasContainer, { text: id, width: 128, height: 128, colorDark : "#000000", colorLight : "#ffffff", correctLevel : QRCode.CorrectLevel.H });
            const coverImg = document.getElementById('qrModalCover');
            if(eventConfig.imageUrl) { coverImg.src = eventConfig.imageUrl; coverImg.classList.remove('hidden'); } else { coverImg.classList.add('hidden'); }
            document.getElementById('qrPreviewModal').classList.remove('hidden');
        };

        window.downloadQrTicket = () => {
            const element = document.getElementById('ticketContainer');
            html2canvas(element).then(canvas => { const link = document.createElement('a'); link.download = 'ticket-acceso.png'; link.href = canvas.toDataURL(); link.click(); });
        };
        
        window.resendInvitation = (id, name, phone) => { const link = window.location.origin + window.location.pathname + "?id=" + id; const msg = `Hola ${name}, aquí tienes tu pase digital para el evento: ${link}`; window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`, '_blank'); };
        window.adjustTickets = (v) => { const el = document.getElementById('inputTickets'); let val = parseInt(el.value) + v; if(val < 1) val = 1; el.value = val; };
        window.closeMobileDetails = () => document.getElementById('guestDetailModal').classList.add('hidden');
        window.copyPlannerLink = () => { copyToClipboard(document.getElementById('plannerLinkInput').value); }
        window.copyToClipboard = (text) => { var t = document.createElement("textarea"); t.value = text; document.body.appendChild(t); t.select(); document.execCommand('copy'); document.body.removeChild(t); showToast("Copiado al portapapeles"); }
        window.openReceptionView = () => { document.getElementById('adminPanel').classList.add('translate-y-full'); document.getElementById('receptionView').classList.remove('hidden'); startScanner(); }
        window.exitReception = () => { if (html5QrCode) { html5QrCode.stop().then(() => { html5QrCode.clear(); html5QrCode = null; }).catch(err => console.log(err)); } document.getElementById('receptionView').classList.add('hidden'); if(window.location.search.includes('wendy_planner')) window.location.href = window.location.pathname; }
        
        function startScanner() { if (html5QrCode) return; html5QrCode = new Html5Qrcode("reader"); html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, onScanSuccess).catch(e=>{}); }
        async function onScanSuccess(d) { if(html5QrCode) html5QrCode.pause(); try{ const s=await window.getDoc(window.doc(window.db,'artifacts',window.appId,'public','data','guests',d)); if(s.exists()){ const x=s.data(); currentGuestIdCheckin=d; document.getElementById('ciName').innerText=x.name; document.getElementById('ciTable').innerText=x.table||"-"; document.getElementById('ciTickets').innerText=x.tickets; document.getElementById('ciInput').value=x.tickets; if(x.checkedIn) showAlert("Aviso", "Este invitado YA INGRESÓ anteriormente.", "info"); document.getElementById('checkinModal').classList.remove('hidden'); }else{ showAlert("Inválido", "El QR no pertenece a este evento.", "error"); if(html5QrCode) html5QrCode.resume(); } }catch(e){ showAlert("Error", "Fallo al leer el QR", "error"); if(html5QrCode) html5QrCode.resume(); } }
        window.adjustCheckin=(v)=>{ const el=document.getElementById('ciInput'); let n=parseInt(el.value)+v; if(n<0)n=0; el.value=n; }
        window.closeCheckin=()=>{ document.getElementById('checkinModal').classList.add('hidden'); if(html5QrCode) html5QrCode.resume(); }
        window.confirmCheckin=async()=>{ const a=parseInt(document.getElementById('ciInput').value); if(currentGuestIdCheckin){ await window.updateDoc(window.doc(window.db,'artifacts',window.appId,'public','data','guests',currentGuestIdCheckin),{checkedIn:true,actualAttendees:a,checkinTime:new Date().toISOString()}); const li=document.createElement('li'); li.className="p-4 bg-slate-800/50 border-b border-slate-700 last:border-0 flex justify-between"; li.innerHTML=`<span class="text-slate-300 font-medium">${document.getElementById('ciName').innerText}</span> <strong class="text-green-400 bg-green-900/30 px-3 py-1 rounded-lg text-xs">${a} pax</strong>`; document.getElementById('recentCheckins').prepend(li); closeCheckin(); showToast("Acceso Registrado"); } }

        // Funciones de Auto Acomodo
        window.autoAssignAll = async () => {
            if(allGuests.length === 0 || Object.keys(tablesData).length === 0) { showAlert("Info", "No hay invitados o mesas para procesar."); return; }
            showConfirm("Auto-Acomodo", "¿Asignar mesas automáticamente?", async () => {
                let unassigned = allGuests.filter(g => !g.table || g.table === ""); unassigned.sort((a, b) => b.tickets - a.tickets);
                let updatedCount = 0; let tempOccupancy = { ...tableOccupancy }; 
                const getRemaining = (tId) => { const t = tablesData[tId]; if(!t) return 0; const cap = window.getGuestTableCapacity(t); const occ = tempOccupancy[tId] || 0; return cap - occ; };
                for (let g of unassigned) {
                    let bestTable = null; let bestFit = 999;
                    for (let tId in tablesData) { const rem = getRemaining(tId); if (rem >= g.tickets) { const fit = rem - g.tickets; if (fit < bestFit) { bestFit = fit; bestTable = tId; } } }
                    if (bestTable) { tempOccupancy[bestTable] += g.tickets; await window.updateDoc(window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'guests', g.id), { table: bestTable }); updatedCount++; }
                }
                const resultDiv = document.getElementById('aaResultContent');
                resultDiv.innerHTML = `<div class="p-4 text-center"><div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4 text-green-600 text-3xl"><i class="fas fa-check"></i></div><h4 class="text-lg font-bold text-slate-800 dark:text-white mb-2">Proceso Completado</h4><p class="text-sm text-slate-600 dark:text-slate-400">Se asignaron <strong>${updatedCount}</strong> invitados.</p></div>`;
                document.getElementById('aaResultModal').classList.remove('hidden');
            });
        };
        window.closeAaResult = () => { document.getElementById('aaResultModal').classList.add('hidden'); };

        window.openEditGuestTable = (guestId, currentTable) => {
            document.getElementById('editGT_id').value = guestId;
            const select = document.getElementById('editGT_select'); select.innerHTML = '<option value="">-- Sin Asignar --</option>';
            const sortedKeys = Object.keys(tablesData).sort((a,b) => a.localeCompare(b, undefined, {numeric: true}));
            sortedKeys.forEach(tId => {
                const t = tablesData[tId]; const cap = window.getGuestTableCapacity(t); const occ = tableOccupancy[tId] || 0; const available = cap - occ;
                const isCurrent = currentTable === tId; const label = `Mesa ${t.id} (${isCurrent ? 'Actual' : available + ' disp'})`;
                const opt = document.createElement('option'); opt.value = tId; opt.text = label; if(isCurrent) opt.selected = true; select.add(opt);
            });
            document.getElementById('editGuestTableModal').classList.remove('hidden');
        };

        document.getElementById('editGuestTableForm').addEventListener('submit', async (e) => { e.preventDefault(); const gId = document.getElementById('editGT_id').value; const tId = document.getElementById('editGT_select').value; try { await window.updateDoc(window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'guests', gId), { table: tId }); document.getElementById('editGuestTableModal').classList.add('hidden'); showToast("Mesa actualizada"); } catch(err) { showAlert("Error", "No se pudo actualizar", "error"); } });
        window.openEditGuestPax = (guestId, currentPax) => { document.getElementById('editGP_id').value = guestId; document.getElementById('editGP_input').value = currentPax; document.getElementById('editGuestPaxModal').classList.remove('hidden'); };
        document.getElementById('editGuestPaxForm').addEventListener('submit', async (e) => { e.preventDefault(); const gId = document.getElementById('editGP_id').value; const pax = parseInt(document.getElementById('editGP_input').value); if(pax < 1) { showAlert("Error", "Mínimo 1 pase.", "error"); return; } try { await window.updateDoc(window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'guests', gId), { tickets: pax }); document.getElementById('editGuestPaxModal').classList.add('hidden'); showToast("Pases actualizados"); } catch(err) { showAlert("Error", "No se pudo actualizar", "error"); } });

        window.confirmDeleteGuest = (guestId) => { showConfirm("Eliminar Invitado", "¿Estás seguro?", async () => { try { await window.deleteDoc(window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'guests', guestId)); showToast("Invitado eliminado"); } catch(err) { showAlert("Error", "No se pudo eliminar", "error"); } }); };
        window.closeTableWarning = () => document.getElementById('tableWarningModal').classList.add('hidden');

        // Lógica detalles móvil
        window.openMobileDetails = (id) => {
            const g = allGuests.find(x => x.id === id); if(!g) return; currentMobId = id;
            document.getElementById('mobName').innerText = g.name; document.getElementById('mobPhone').innerText = g.phone || 'Sin teléfono'; document.getElementById('mobTickets').innerText = g.tickets;
            const tableText = g.table ? g.table : "Sin Asignar"; const tableEl = document.getElementById('mobTableDisplay'); tableEl.innerText = tableText;
            if(!g.table) { tableEl.classList.replace('text-blue-600', 'text-slate-400'); tableEl.classList.replace('dark:text-blue-400', 'dark:text-slate-500'); } else { tableEl.classList.replace('text-slate-400', 'text-blue-600'); tableEl.classList.replace('dark:text-slate-500', 'dark:text-blue-400'); }
            const badge = document.getElementById('mobStatusBadge'); badge.className = "w-full py-3.5 rounded-xl text-center font-bold text-sm mb-6 border";
            if(g.checkedIn) { badge.classList.add('bg-green-100', 'text-green-700', 'border-green-200', 'dark:bg-green-900/30', 'dark:text-green-400', 'dark:border-green-800'); badge.innerText = "YA INGRESÓ AL EVENTO"; } 
            else if(g.confirmed) { badge.classList.add('bg-yellow-100', 'text-yellow-700', 'border-yellow-200', 'dark:bg-yellow-900/30', 'dark:text-yellow-400', 'dark:border-yellow-800'); badge.innerText = "CONFIRMADO"; } 
            else { badge.classList.add('bg-slate-100', 'text-slate-500', 'border-slate-200', 'dark:bg-slate-800', 'dark:text-slate-400', 'dark:border-slate-700'); badge.innerText = "PENDIENTE DE CONFIRMAR"; }
            document.getElementById('btnVerQR').onclick = () => window.showGuestQR(g.id, g.name, g.tickets);
            document.getElementById('btnEliminarInvitacion').onclick = () => { window.closeMobileDetails(); window.confirmDeleteGuest(g.id); };
            document.getElementById('btnEditMobPax').onclick = () => { window.openEditGuestPax(g.id, g.tickets); };
            document.getElementById('mobEditTableBtn').onclick = () => { window.openEditGuestTable(g.id, g.table); };
            document.getElementById('guestDetailModal').classList.remove('hidden');
        };

    </script>
</body>
</html>